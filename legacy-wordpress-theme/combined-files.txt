/*
Theme Name: Ting Tong Theme
Theme URI: https://example.com/ting-tong-theme/
Author: Your Name
Author URI: https://example.com/
Description: A custom theme for the Ting Tong application, converted from a static HTML project.
Version: 1.0.0
License: GNU General Public License v2 or later
License URI: https://www.gnu.org/licenses/gpl-2.0.html
Text Domain: tingtongtheme
*/

/* ==========================================================================
           --- PRELOADER ---
           ========================================================================== */
.preloader-icon-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 160px;
    height: 160px;
    z-index: 10001;
    opacity: 1;
    transition: opacity 0.5s linear;
}

.splash-icon {
    width: 100%;
    height: 100%;
    object-fit: contain;
    animation: pulse-glow 2.5s infinite ease-in-out;
}

#preloader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #000;
  z-index: 10000;
  transition: opacity 0.5s linear;
  overflow: hidden; /* Prevent layout issues */
}


.preloader-hiding {
  opacity: 0;
  pointer-events: none;
  z-index: -1; /* FIX: Ensure the preloader goes behind all content when hidden */
}

/* ============================================================================
   FIRST LOGIN MODAL - PREMIUM STYLES
   ============================================================================ */
.fl-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: flex-start; /* Wyrównuje zawartość do góry */
  justify-content: center;
  z-index: 10020;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
  padding-top: var(--topbar-height); /* <--- ZMIANA: Dynamiczna pozycja pod topbarem */
}

.fl-modal-overlay.visible {
  opacity: 1;
  visibility: visible;
}

/* FIX: Container for better keyboard handling and to fill space correctly */
.fl-modal-content-wrapper {
  width: 100%;
  height: auto; /* <--- ZMIANA: Karta zajmuje tylko tyle miejsca, ile potrzebuje */
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding: 20px; /* Dodatkowy margines wokół karty */
}

/* ... reszta stylów fl-modal-content i fl-modal-content pozostaje bez zmian ... */

.fl-modal-content {
  transform: scale(0.95) translateY(20px);
  opacity: 0;
}

.fl-modal-overlay.visible .fl-modal-content {
    transform: scale(1) translateY(0);
    opacity: 1;
}

.fl-modal-content {
  background: linear-gradient(180deg, #242426 0%, #18181a 100%);
  border-radius: 24px;
  display: flex;
  flex-direction: column;
  height: auto;
  max-height: calc(100vh - 80px); /* <-- ZMIANA: Więcej miejsca, z marginesami */
  width: 100%;
  max-width: 500px;
  /* ... (pozostałe style) ... */
}

.fl-header {
  padding: 12px 24px 16px;
  flex-shrink: 0;
}

.fl-drag-handle-container {
  padding-bottom: 12px;
  display: flex;
  justify-content: center;
}

.fl-drag-handle {
  width: 40px;
  height: 5px;
  background: #48484a;
  border-radius: 2.5px;
}

.fl-title {
  color: #fff;
  text-align: center;
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 16px;
}

.fl-progress-bar-container {
  height: 6px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 3px;
}

.fl-progress-bar-fill {
  height: 100%;
  width: 33.33%;
  background: linear-gradient(90deg, #34d058, #007aff); /* FIX: Optymistyczny akcent - zieleń i błękit */
  border-radius: 3px;
  transition: width 0.4s ease;
}

.fl-body {
  padding: 0 24px 20px;
  overflow-y: auto;
  flex-grow: 1;
}

.fl-step {
  display: none;
}

.fl-step.active {
  display: block;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.fl-step-description {
  color: #b0b3b8;
  font-size: 16px;
  line-height: 1.5;
  margin-bottom: 24px;
  text-align: center;
}

.fl-fields-container {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.fl-input {
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.15);
  padding: 14px 16px;
  border-radius: 12px;
  color: #fff;
  font-size: 16px;
  transition: all 0.2s ease;
}

.fl-input:focus {
  outline: none;
  border-color: var(--accent-color);
  background: rgba(255, 255, 255, 0.1);
  box-shadow: 0 0 0 3px rgba(255, 0, 85, 0.15);
}

.fl-input::placeholder {
  color: #8e8e93;
}

.fl-preference-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255, 255, 255, 0.08);
  padding: 14px 16px;
  border-radius: 12px;
  cursor: pointer;
}

.fl-preference-label {
  color: #fff;
  font-size: 16px;
  font-weight: 500;
}

.fl-checkbox {
  transform: scale(1.4);
  accent-color: var(--accent-color);
}

.fl-language-selector {
  display: none; /* Hidden by default, shown by JS */
  gap: 10px;
  background: rgba(255, 255, 255, 0.08);
  padding: 6px;
  border-radius: 12px;
}

.fl-language-selector.visible {
    display: flex;
}

.fl-language-option {
  flex: 1;
  padding: 10px 16px;
  border-radius: 8px;
  color: #b0b3b8;
  font-weight: 600;
  cursor: pointer;
  border: none;
  background: transparent;
  transition: all 0.2s ease;
}

.fl-language-option.active {
  background: var(--accent-color);
  color: #fff;
  box-shadow: 0 4px 12px rgba(255, 0, 85, 0.3);
}

.fl-hint-text {
  font-size: 13px;
  color: #888;
  text-align: center;
  margin-top: 4px;
}

.fl-email-display {
  display: block;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 12px;
  padding: 14px 16px;
  color: #fff;
  font-weight: 500;
  text-align: center;
}

.fl-footer {
  padding: 16px 24px;
  background: #18181a;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  padding-bottom: calc(16px + var(--safe-area-bottom));
}

.fl-footer-buttons {
  display: flex;
  gap: 12px;
}

.fl-btn {
  flex: 1;
  padding: 16px;
  border: none;
  border-radius: 14px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
}

.fl-btn:active {
  transform: scale(0.97);
}

.fl-btn-prev {
  background: #3a3a3c;
  color: #fff;
  display: none; /* Hidden by default */
}

.fl-btn-next {
  background: linear-gradient(90deg, #007aff, #0056b3);
  color: #fff;
  box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
}

.fl-btn-submit {
  background: linear-gradient(90deg, #34c759, #28a745);
  color: #fff;
  display: none; /* Hidden by default */
  box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
}

#flNameError,
#flPasswordError {
    margin-top: -8px;
    margin-bottom: 8px;
}

/* --- Tipping Modal Specific Styles --- */

.tipping-amount-container {
    display: flex;
    align-items: center;
    background-color: #2c2c2e;
    border-radius: 12px;
    padding: 4px;
    border: 1px solid #4d4d50;
    transition: border-color 0.2s;
}

.tipping-amount-container:focus-within {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(255, 0, 85, 0.15);
}

#tippingAmount {
    flex-grow: 1;
    background: transparent;
    border: none;
    color: white;
    font-size: 28px;
    font-weight: bold;
    padding: 12px 16px;
    text-align: center;
    -moz-appearance: textfield; /* Firefox */
}

#tippingAmount::-webkit-outer-spin-button,
#tippingAmount::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.tipping-currency {
    font-size: 24px;
    font-weight: bold;
    color: rgba(255, 255, 255, 0.6);
    padding-right: 20px;
}

#tippingEmailContainer {
    transition: all 0.3s ease-in-out;
    opacity: 0;
    max-height: 0;
    overflow: hidden;
}

#tippingEmailContainer.visible {
    opacity: 1;
    max-height: 100px; /* enough for input and hint */
    margin-top: 16px;
}

.loading-spinner.large {
    width: 48px;
    height: 48px;
    border-width: 4px;
}
@keyframes pulse-glow {
  0% {
    transform: scale(1);
    opacity: 0.9;
  }
  50% {
    transform: scale(1.05);
    opacity: 1;
  }
  100% {
    transform: scale(1);
    opacity: 0.9;
  }
}
.preloader-content-container {
  position: absolute;
  top: calc(50% + 80px); /* Odsunięcie w dół o połowę wysokości obrazka (80px to połowa z 160px) */
  bottom: 0;
  left: 0;
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center; /* FIX: Vertically center content in the available space */
  overflow-y: auto; /* FIX: Allow scrolling on extremely small screens as a safeguard */
  padding: 10px 20px calc(15px + var(--safe-area-bottom));
  box-sizing: border-box;
  opacity: 0;
  transform: translateY(100%);
  transition:
    transform 1s cubic-bezier(0.68, -0.55, 0.27, 1.55),
    opacity 0.6s ease-out,
    padding 0.3s ease-out;
}
.preloader-content-container::-webkit-scrollbar {
  display: none;
}
.preloader-content-container {
  -ms-overflow-style: none;
  scrollbar-width: none;
}
#preloader.content-visible .preloader-content-container {
  opacity: 1;
  transform: translateY(0);
}
.language-selection {
  margin-top: 0; /* FIX: Remove margin, as justify-content now handles vertical position */
  text-align: center;
  width: 100%;
  max-width: 400px;
  flex-shrink: 0; /* FIX: Prevent shrinking on flex parent */
}
.language-selection h2 {
  font-size: clamp(1.1rem, 3vh, 1.3rem); /* Approx 17.6px to 20.8px */
  font-weight: 600;
  color: #fff;
  margin-bottom: clamp(10px, 3vh, 20px);
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.7);
  transition:
    font-size 0.3s ease-out,
    margin-bottom 0.3s ease-out;
}
.language-selection .lang-buttons-container {
  display: flex;
  flex-direction: column;
  gap: clamp(8px, 2vh, 15px);
  width: 100%;
  justify-content: center;
  transition: gap 0.3s ease-out;
}
@keyframes subtle-flicker-glow {
  0% {
    box-shadow: 0 0 0 0 rgba(255, 64, 129, 0.7);
  }
  50% {
    box-shadow: 0 0 16px 8px rgba(255, 64, 129, 0.3);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(255, 64, 129, 0);
  }
}
.language-selection button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: white;
  padding: clamp(8px, 2vh, 16px) clamp(18px, 3vw, 24px);
  margin: 0;
  font-size: clamp(0.875rem, 2.2vh, 1.125rem); /* Approx 14px to 18px */
  font-weight: 600;
  border-radius: clamp(12px, 2vh, 16px);
  cursor: pointer;
  width: 100%;
  max-width: 400px;
  transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  -webkit-tap-highlight-color: transparent;
}
.language-selection button:hover:not(:disabled) {
  transform: translateY(-2px);
  border-color: rgba(255, 255, 255, 0.5);
}
.language-selection button:active:not(:disabled) {
  transform: translateY(-1px) scale(0.98);
  transition-duration: 0.1s;
}
.language-selection button.is-selected {
  background-color: var(--accent-color);
  border-color: var(--accent-color);
  color: #fff;
  animation: subtle-flicker-glow 1s ease-out;
}
.language-selection button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ==========================================================================
           --- STYLE GŁÓWNE, RESET I SCROLLING ---
           ========================================================================== */
:root {
  --app-height: 100%;
  --accent-color: #ff0055;
  --progress-bar-color: var(--accent-color);
  --main-ui-bg-color: #696969;
  --transition-speed: 0.4s;
  --transition-timing: cubic-bezier(0.25, 0.46, 0.45, 0.94);
  --topbar-base-height: 40px;
  --bottombar-base-height: 110px;
  --safe-area-top: env(safe-area-inset-top);
  --safe-area-bottom: env(safe-area-inset-bottom);
  --topbar-height: calc(var(--topbar-base-height) + var(--safe-area-top));
  --bottombar-height: calc(
    var(--bottombar-base-height) + var(--safe-area-bottom)
  );
  --video-controls-height: 40px;
}
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}
html,
body {
  height: 100%;
  width: 100%;
  overflow: hidden;
  font-family:
    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial,
    sans-serif;
  background-color: #000;
  color: white;
  overscroll-behavior: none; /* Prevent bounce scroll and pull-to-refresh on iOS */
  user-select: none;
  -webkit-user-select: none;
}
body::-webkit-scrollbar,
#webyx-container::-webkit-scrollbar {
  display: none;
}
body,
#webyx-container {
  -ms-overflow-style: none; /* IE and Edge */
  scrollbar-width: none; /* Firefox */
}
#webyx-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0; /* Hidden initially */
  transition: opacity 0.5s linear;
  overflow: hidden; /* Swiper handles overflow */
  /* Wymuszenie własnej warstwy GPU na całym kontenerze Swipera */
  -webkit-transform: translate3d(0, 0, 0); /* Stabilizacja kontenera */
  transform: translate3d(0, 0, 0);
}
#webyx-container.ready {
  opacity: 1;
}
.webyx-section {
  width: 100vw;
  height: var(--app-height); /* Use var, remove 1px patch for scroll-snap */
  overflow: hidden;
  position: relative;
}

/* Wymuszenie własnej warstwy kompozycji dla każdego slajdu */
.webyx-section,
.swiper-slide {
  -webkit-transform: translate3d(0, 0, 0) !important;
  transform: translate3d(0, 0, 0) !important;
  /* Dodanie backface-visibility poprawia zachowanie przy transformacjach 3D */
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
  will-change: transform;
}

/* Upewnij się, że wrapper Swipera ma transformację 3D */
.swiper-wrapper {
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
}

/* ==========================================================================
           --- GŁÓWNY LAYOUT (TIKTOK-LIKE) ---
           ========================================================================== */
.tiktok-symulacja {
  position: relative;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background-color: black;
  color: white;
  z-index: 1;
  font-family: "Manrope", sans-serif;
}
.tiktok-symulacja iframe {
  width: 100%;
  height: 100%;
  border: none;
  pointer-events: none !important;
}
.tiktok-symulacja * {
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}
.secret-overlay {
  position: absolute;
  top: var(--topbar-height);
  left: 0;
  width: 100%;
  height: calc(100vh - var(--topbar-height));
  background: none;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  text-align: center;
  padding: 20px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease, top 0.3s ease-out, height 0.3s ease-out;
  overflow: hidden;
}
.secret-overlay.visible {
  opacity: 1;
  pointer-events: auto;
}

.interactive-wall-overlay {
    position: absolute;
    top: var(--topbar-height);
    left: 0;
    width: 100%;
    bottom: 0; /* Cover the entire area */
    height: auto;
    z-index: 10200; /* Match modal z-index to cover everything */
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
    background-color: #333; /* Ensure it has a background */
}

.interactive-wall-overlay.visible {
  opacity: 1;
  pointer-events: auto;
}

.interactive-canvas {
    display: block;
    width: 100%;
    height: 100%;
    cursor: crosshair;
}

/* Ten kontener musi mieć ten sam kolor co fuga w Canvas, aby były spójne */
.mur-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    /* Upewnia się, że "fuga" jest kolorem tła */
    background-color: #333333;
    overflow: hidden;
    display: block !important; /* Wymuś widoczność */
}

.mur-row {
    display: flex;
    flex-wrap: nowrap;
    margin-bottom: 1px;
}

.mur-row:nth-child(even) {
    margin-left: -30.5px;
}

/* W statycznym murze obrys (fuga) jest realizowana przez tło kontenera i marginesy. */
.cegla {
    width: 60px;
    height: 30px;
    background-color: #ffffff;
    /* Daje efekt białej cegły z ciemną fugą */
    margin-right: 1px;
    flex-shrink: 0;
}
/* --- End Brick Wall --- */

.secret-overlay .secret-icon {
  width: 64px;
  height: 64px;
  margin-bottom: 24px;
  color: rgba(255, 255, 255, 0.9);
  filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.4));
}
.secret-overlay .secret-title {
  font-size: 24px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 4px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
}
.secret-overlay .secret-subtitle {
  font-size: 16px;
  color: rgba(255, 255, 255, 0.8);
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
}
.pwa-secret-overlay {
  position: absolute;
  top: var(--topbar-height);
  left: 0;
  width: 100%;
  height: calc(100% - var(--topbar-height));
  background: rgba(0, 0, 0, 0.4);
  -webkit-backdrop-filter: blur(12px) saturate(120%);
  backdrop-filter: blur(12px) saturate(120%);
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  text-align: center;
  padding: 20px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease, top 0.3s ease-out, height 0.3s ease-out;
}
.pwa-secret-overlay.visible {
  opacity: 1;
  pointer-events: auto;
}
.pwa-secret-overlay .pwa-secret-icon,
.pwa-secret-overlay .secret-icon {
  width: 64px;
  height: 64px;
  margin-bottom: 24px;
  color: rgba(255, 255, 255, 0.9);
  filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.4));
}
.pwa-secret-overlay .pwa-secret-title {
  font-size: 22px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 4px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
}
.pwa-secret-overlay .pwa-secret-subtitle {
  font-size: 16px;
  color: rgba(255, 255, 255, 0.8);
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
}
.player {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  transform: translate3d(0, 0, 0); /* Fix for video flickering on iOS */
}
.pause-overlay {
  position: absolute;
  top: var(--topbar-height);
  left: 0;
  width: 100%;
  height: calc(100% - var(--topbar-height) - var(--bottombar-height));
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: transparent; /* Zmień kolor na przeźroczysty */
  z-index: 101;
  opacity: 0;
  pointer-events: none;
  transition: top 0.3s ease-out, height 0.3s ease-out, opacity 0.2s ease-in-out;
  visibility: hidden;
}
.tiktok-symulacja:not(.video-loaded) .pause-overlay {
  display: none !important;
}
.pause-overlay.visible {
  opacity: 1;
  pointer-events: auto;
  visibility: visible;
}
.pause-icon {
  width: 80px;
  height: 80px;
  color: rgba(255, 255, 255, 0.8);
  filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.5));
}

/* ✅ NOWE: Replay overlay */
.replay-overlay {
  position: absolute;
  top: var(--topbar-height);
  left: 0;
  width: 100%;
  height: calc(100% - var(--topbar-height) - var(--bottombar-height));
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: transparent;
  z-index: 101;
  opacity: 0;
  pointer-events: none;
  transition: top 0.3s ease-out, height 0.3s ease-out, opacity 0.2s ease-in-out;
  visibility: hidden;
}

.tiktok-symulacja:not(.video-loaded) .replay-overlay {
  display: none !important;
}

.replay-overlay.visible {
  opacity: 1;
  pointer-events: auto;
  visibility: visible;
}

.replay-icon {
  width: 80px;
  height: 80px;
  color: rgba(255, 255, 255, 0.9);
  filter: drop-shadow(0 0 12px rgba(0, 0, 0, 0.6));
  animation: replayPulse 2s ease-in-out infinite;
}

@keyframes replayPulse {
  0%, 100% {
    transform: scale(1);
    opacity: 0.9;
  }
  50% {
    transform: scale(1.1);
    opacity: 1;
  }
}


/* ✅ FIX 2: Kontrolki wideo w poziomie, bliżej lewej krawędzi */
.video-controls {
  position: absolute;
  bottom: calc(var(--bottombar-height) + 8px);
  left: 4px; /* Odsunięcie od lewej krawędzi */
  right: 4px; /* Odsunięcie od prawej krawędzi */
  width: auto; /* Szerokość auto, aby dopasować się do lewej i prawej */
  z-index: 105;
  display: flex;
  flex-direction: row; /* Układ poziomy */
  align-items: center;
  justify-content: space-between; /* Kluczowe dla rozmieszczenia */
  opacity: 0;
  transition: opacity 0.6s ease-out;
}

.tiktok-symulacja.video-loaded .video-controls {
    opacity: 1;
}

.video-controls-left {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 4px; /* Odstęp między przyciskami po lewej */
}

.video-controls button {
  background: rgba(0, 0, 0, 0.5);
  border: none;
  border-radius: 50%;
  width: 34px; /* Zmniejszono */
  height: 34px; /* Zmniejszono */
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  transition: background-color 0.2s, transform 0.1s, opacity 0.3s ease-out;
  padding: 0;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}

.video-controls button svg {
  width: 18px; /* Zmniejszono */
  height: 18px; /* Zmniejszono */
  transition: fill 0.3s ease-out, stroke 0.3s ease-out;
}

.video-controls button:hover {
  background: rgba(0, 0, 0, 0.7);
}

.video-controls button:active {
  transform: scale(0.9);
}

.info-button svg.info-icon-pulsing {
    animation: pulse 2.5s infinite cubic-bezier(0.4, 0, 0.6, 1);
    transition: none !important;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.1);
        opacity: 0.7;
    }
}

.cc-button {
  cursor: not-allowed;
  opacity: 0.5;
}

.elegant-modal-error {
    color: #ff8a80; /* Light red for dark theme */
    background-color: rgba(255, 138, 128, 0.1); /* Subtle red background */
    border: 1px solid rgba(255, 138, 128, 0.3);
    border-radius: 8px;
    padding: 10px 15px;
    margin-top: 15px;
    font-size: 14px;
    text-align: center;
    display: none; /* Hidden by default */
}
.topbar {
  background: #000;
}
.tiktok-symulacja .bottombar {
  background: rgba(0, 0, 0, 0.7); /* Półprzezroczyste czarne tło dla lepszej czytelności */
}
.login-panel {
  background: rgba(0, 0, 0, 0.6);
  -webkit-backdrop-filter: blur(8px);
  backdrop-filter: blur(8px);
}
.topbar {
  position: absolute; /* Zmienione z 'fixed' na 'absolute' */
  display: flex;
  justify-content: center;
  align-items: center;
  text-shadow:
    -1px -1px 0 black,
    1px -1px 0 black,
    -1px 1px 0 black,
    1px 1px 0 black;
  top: 0;
  left: 0;
  width: 100%; /* teraz 100% szerokości #app-frame */
  height: var(--topbar-height);
  padding-top: var(--safe-area-top);
  z-index: 115;
  font: inherit;
  color: inherit;
  transition: border-color 0.3s ease-out;
}

/* Stabilizacja kluczowych elementów interfejsu (topbar, sidebar, bottombar) */
.topbar,
.tiktok-symulacja .sidebar,
.tiktok-symulacja .bottombar {
  /* Wymuszenie własnej, stabilnej warstwy GPU dla stałych elementów */
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
}
.topbar.login-panel-active {
  border-bottom-color: transparent;
}
.topbar.login-panel-active .central-text-wrapper.with-arrow::after {
  transform: translateY(-50%) rotate(180deg);
}
.central-text-wrapper {
  position: relative;
}
.topbar-text {
  font-size: 16px;
  font-weight: 600;
  color: white;
  pointer-events: none;
}
.central-text-wrapper.with-arrow::after {
  content: "▼";
  position: absolute;
  left: 100%;
  top: 50%;
  transform: translateY(-50%);
  font-size: 12px;
  opacity: 0.8;
  margin-left: 6px;
  transition: transform 0.3s ease;
}
.tiktok-symulacja .sidebar {
  position: absolute;
  top: calc(
    (var(--app-height) - var(--topbar-height) - var(--bottombar-height)) / 2 +
      var(--topbar-height)
  );
  right: 2px;
  transform: translateY(-50%) translateX(150%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  z-index: 10052;
  transition:
    top 0.3s ease-out,
    transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.tiktok-symulacja.video-loaded .sidebar.visible {
  transform: translateY(-50%) translateX(0);
}
.tiktok-symulacja .bottombar {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: var(--bottombar-base-height); /* ✅ Zmieniono na stałą wysokość */
  display: flex;
  flex-direction: column;
  justify-content: flex-start; /* ✅ Wyrównaj zawartość do góry */
  padding: 15px 75px 10px 12px; /* ✅ Zwiększony górny padding */
  color: white;
  z-index: 10050;
  padding-bottom: calc(10px + var(--safe-area-bottom));
  opacity: 0;
  transition: opacity 0.6s ease-out;
}

/* ✅ NOWE: Pokaż bottombar dopiero gdy video jest załadowane */
.tiktok-symulacja.video-loaded .bottombar {
  opacity: 1;
}

/* Dodaj tę regułę, aby dostosować dolny pasek, gdy widoczony jest pasek instalacji PWA */
.app-frame--pwa-visible .bottombar {
}
/* === PATCH: Pasek progressu na górnej krawędzi bottombar (v2 - Pixel Perfect) === */

/* 1. Zmień pozycjonowanie i wysokość - progress bar ma być częścią bottombar */
.progress-bar {
  position: absolute;
  bottom: 100%; /* Na górnej krawędzi bottombar */
  left: 0;
  width: 100%;
  height: 2px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  z-index: 10060; /* Podniesiony, aby był nad paskiem PWA */
  transition: height 0.2s ease-in-out;
}

/* 2. Usuń stare reguły dla app-frame--pwa-visible - pozostaje bez zmian */
.app-frame--pwa-visible .progress-bar {
  top: unset;
  bottom: 100%;
}

/* 3. Dla przeglądarki (nie-PWA) - usuń transform - pozostaje bez zmian */
@media not all and (display-mode: standalone) {
  .progress-bar {
    bottom: 100%;
    top: auto;
    transform: translateY(2px); /* Przesunięcie w dół o 2px */
  }
}

/* 4. Dostosuj pseudo-elementy do nowej wysokości kontenera */
.progress-bar::before {
  content: "";
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%; /* Wypełnia całą wysokość kontenera */
  background-color: rgba(255, 0, 85, 0.3);
}

.progress-bar-fill {
  position: absolute;
  left: 0;
  top: 0;
  width: 0%;
  height: 100%; /* Wypełnia całą wysokość kontenera */
  background-color: var(--progress-bar-color);
  border-radius: 2px;
  pointer-events: none;
}

.progress-bar-handle {
  position: absolute;
  top: 50%; /* Pozostaje wycentrowany w pionie */
  left: 0%;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background-color: white;
  transform: translate(-50%, -50%) scale(1);
  transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  opacity: 1;
  pointer-events: none;
  box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
  z-index: 10; /* FIX: Zapewnia, że uchwyt jest nad innymi elementami w progress-bar */
}

/* 5. Zmień sposób obsługi hover - powiększamy cały kontener */
.progress-bar:hover,
.progress-bar.dragging {
  height: 4px; /* Zwiększamy wysokość całego paska */
}

.progress-bar:hover .progress-bar-handle,
.progress-bar.dragging .progress-bar-handle {
  transform: translate(-50%, -50%) scale(1.5);
}

.tiktok-symulacja .text-info {
  display: flex;
  flex-direction: column;
  min-width: 0;
}

.tiktok-symulacja .slide-meta-line {
  display: flex;
  align-items: center; /* Lepsze wyrównanie w pionie */
  gap: 8px;
  width: 100%;
  overflow: hidden; /* Zapobiegaj przepełnieniu */
}

.tiktok-symulacja .author-name {
  font-size: 16px;
  font-weight: 700; /* Używamy <strong>, więc pogrubiamy */
  color: white;
  text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
  /* NOWE: Pozwól na skracanie i dodaj wielokropek, aby uniknąć przepełnienia */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  min-width: 0;
}

.tiktok-symulacja .slide-title {
  font-size: 16px;
  font-weight: 400; /* Zwykła waga dla kontrastu */
  line-height: 1.2;
  text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
  white-space: nowrap; /* Nie zawijaj tekstu */
  overflow: hidden; /* Ukryj przepełnienie */
  text-overflow: ellipsis; /* Dodaj wielokropek */
  min-width: 0; /* Pozwól na zmniejszenie */
}

.tiktok-symulacja .slide-description {
  font-size: 14px;
  line-height: 1.4;
  color: white;
  text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
  margin-top: 4px;
  /* Ograniczenie do 2 linii z wielokropkiem */
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2; /* Ogranicz do 2 linii */
  -webkit-box-orient: vertical;
  white-space: normal;
}

/* ==========================================================================
           --- KOMPONENTY UI: PRZYCISKI I IKONY ---
           ========================================================================== */
.tiktok-symulacja .profile {
  position: relative;
  width: 50px;
  height: 50px;
  margin-bottom: 6px;
}
.tiktok-symulacja .profileButton {
  background: none;
  border: none;
  padding: 0;
  border-radius: 50%;
  cursor: pointer;
  display: block;
  width: 100%;
  height: 100%;
  transition: transform 0.15s ease-out;
}
.tiktok-symulacja .profileButton:active {
  transform: scale(1.15);
  transition: none;
}
.tiktok-symulacja .profile img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  border: 2px solid white;
  display: block;
  transition:
    border-color 0.1s ease-in-out,
    filter 0.2s;
  background-color: white; /* Dodane białe tło */
}

@keyframes flicker-glow {
 0% { box-shadow: 0 0 8px rgba(255, 215, 0, 0.3); }
 50% { box-shadow: 0 0 20px 5px rgba(255, 215, 0, 0.7); }
 100% { box-shadow: 0 0 8px rgba(255, 215, 0, 0.3); }
}

/* Styl dla obwódki VIP */
.vip-avatar-border {
  position: relative;
  padding: 0;
  background-clip: padding-box !important;
  animation: flicker-glow 4s infinite;
  transition: border-color 0.1s ease-in-out, filter 0.2s;
  background-color: white; /* Dziedziczenie defaultowego tła jest ok */
}
.tiktok-symulacja .profileButton:active img {
  border-color: var(--accent-color);
}
.tiktok-symulacja .plus {
  position: absolute;
  bottom: -6px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--accent-color);
  color: white;
  border: 2px solid black;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 18px;
  line-height: 1;
  pointer-events: none;
  transition: border-color 0.1s ease-in-out;
}
.tiktok-symulacja.is-logged-in .profile .plus {
  display: none;
}
.tiktok-symulacja .profileButton:active + .plus {
  border-color: var(--accent-color);
}
.tiktok-symulacja .icon-button {
  background: none;
  border: none;
  font: inherit;
  color: inherit;
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  font-size: 11px;
  transition: transform 0.2s ease-out, opacity 0.2s ease-out;
  gap: 2px;
}
.tiktok-symulacja .icon-button:focus,
.tiktok-symulacja .profileButton:focus {
  outline: none;
}
.tiktok-symulacja .icon-button:active:not(:disabled) {
  transform: scale(1.15);
  transition: none;
}
.tiktok-symulacja .icon-button svg {
  width: 32px;
  height: 32px;
  stroke: white;
  stroke-width: 1.5;
  fill: none;
  transition:
    stroke 0.2s ease-in-out,
    fill 0.2s ease-in-out;
  pointer-events: none;
  padding: 0;
  margin: 0;
  display: block;
  filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.5));
}
.tiktok-symulacja .icon-button .icon-label {
  margin: 0;
  padding: 0;
  text-align: center;
  line-height: 1.1;
  transition: color 0.2s ease-in-out;
  text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
}
.tiktok-symulacja .like-button.active > svg {
  fill: var(--accent-color);
  stroke: white;
}
.tiktok-symulacja .like-button:active:not([disabled]) {
  transform: scale(1.2);
}
.tiktok-symulacja .tipButton {
  width: 64px;
  margin-top: 0;
  flex-shrink: 0;
}
.tiktok-symulacja .like-button:active:not(:disabled) svg {
  stroke: white !important;
}
.topbar-central-trigger {
  background: none;
  border: none;
  padding: 0;
  margin: 0;
  font: inherit;
  color: inherit;
  cursor: pointer;
  display: flex;
  justify-content: center;
}
.topbar-central-trigger:active {
  transform: scale(0.98);
}
.topbar-icon-btn {
  position: absolute;
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  flex-shrink: 0;
  transition:
    transform 0.1s ease-in-out,
    opacity 0.2s;
  /* ✅ FIX: Center vertically considering safe area */
  top: calc(var(--safe-area-top) + (var(--topbar-base-height) / 2));
  transform: translateY(-50%);
}
.hamburger-icon {
  left: 0;
}
.notification-bell {
  right: 0;
}
.topbar-icon-btn:active:not([disabled]) {
  transform: translateY(-50%) scale(0.9);
}
.topbar-icon-btn[disabled] {
  opacity: 0.5;
  cursor: not-allowed;
  transform: translateY(-50%) scale(1);
}
.hamburger-icon svg {
  stroke: white;
  stroke-width: 2.5;
  stroke-linecap: round;
  fill: none;
}
.notification-bell svg {
  stroke: white;
  fill: none;
}
.notification-dot {
  position: absolute;
  top: 10px;
  right: 11px;
  width: 8px;
  height: 8px;
  background-color: var(--accent-color);
  border-radius: 50%;
  border: 2px solid white;
}

/* ==========================================================================
           --- KOMPONENTY UI: PANELE I MENU ---
           ========================================================================== */
@keyframes slideInFromTop {
    from {
        transform: translateY(-100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes slideOutToTop {
    from {
        transform: translateY(0);
        opacity: 1;
    }
    to {
        transform: translateY(-100%);
        opacity: 0;
    }
}

@keyframes slideInDown {
    from {
        transform: translateY(-100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes slideOutUp {
    from {
        transform: translateY(0);
        opacity: 1;
        visibility: visible;
    }
    to {
        transform: translateY(-100%);
        opacity: 0;
        visibility: hidden;
    }
}

.login-panel {
  position: absolute;
  top: var(--topbar-height);
  left: 0;
  width: 100%;
  color: white;
  z-index: 114;
  border-top: none;
  /* Start hidden by default */
  visibility: hidden;
  opacity: 0;
}

.login-panel.active {
  visibility: visible;
  opacity: 1;
  transform: translateY(0);
}

.login-panel.login-panel--closing {
  visibility: hidden;
  opacity: 0;
  transform: translateY(-100%);
  pointer-events: none;
}
.login-panel > div,
.login-panel > form {
  padding: 10px 15px;
  background: transparent !important;
}
.login-panel .login-form {
background: white;
/* ZMIANA 1: Nowy dolny padding 10px */
padding: 10px 20px 10px;
border-radius: 8px;
display: flex;
flex-direction: column;
gap: 12px;
width: 100%;
max-width: 400px;
/* ZMIANA 2: Nowy górny margines -7px (daje 3px odległości od topbara) */
margin: -7px auto 0;
}

/* === LOGIN PANEL NEW STYLE === */
.login-panel .login-form .password-wrapper {
  position: relative;
  width: 100%;
  display: flex;
  align-items: center;
}

.login-panel .login-form input[type="text"],
.login-panel .login-form input[type="password"] {
  background: white;
  border: 2px solid black;
  font-weight: bold;
  color: black;
  padding: 8px 40px 8px 10px; /* Add padding to the right for the icon */
  border-radius: 4px;
  width: 100%;
  font-size: 16px;
}

.password-toggle-btn {
  position: absolute;
  right: 0;
  top: 0;
  height: 100%;
  width: 40px;
  background: transparent;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  opacity: 1; /* Make fully opaque */
  transition: transform 0.2s;
}

.password-toggle-btn:hover {
  transform: scale(1.1);
}

.password-toggle-btn svg {
  width: 22px; /* Slightly larger */
  height: 22px; /* Slightly larger */
  fill: black; /* Use fill for solid icons */
  stroke: none; /* No stroke needed */
}

.login-panel .login-form button[type="submit"] {
  background: var(--accent-color);
  border: 2px solid black;
  width: 100%;
  padding: 10px;
  font-weight: bold;
  color: white;
  text-transform: uppercase;
  font-family: inherit;
  cursor: pointer;
  -webkit-appearance: none;
  appearance: none;
  border-radius: 4px;
  font-size: 16px;
}

.login-panel .login-form button[type="submit"]:active {
  background: #222;
}

.logged-in-menu {
  position: absolute;
  top: var(--topbar-height);
  left: 0;
  z-index: 110;
  background-color: rgba(20, 20, 20, 0.85);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-bottom-right-radius: 12px;
  overflow: hidden;
  max-height: 0;
  transition: max-height 0.3s ease;
  display: flex;
  flex-direction: column;
  border: none; /* Removed border */
}
.logged-in-menu.active {
  max-height: 200px;
}
.logged-in-menu a {
  color: white;
  text-decoration: none;
  padding: 12px 24px 12px 16px;
  font-size: 16px;
  text-align: left;
  white-space: nowrap;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  transition: background-color 0.2s ease;
}
.logged-in-menu a:last-child {
  border-bottom: none;
}
.logged-in-menu a:hover,
.logged-in-menu a:focus {
  background: rgba(255, 255, 255, 0.1);
  outline: none;
}

/* ==========================================================================
           --- KOMPONENTY UI: MODALE I ALERTY ---
           ========================================================================== */
#alertBox {
  /* ✅ FIX: Zmieniono na position:fixed aby zapewnić widoczność w PWA */
  position: fixed;
  /* ✅ FIX: Obniżono pozycję bliżej dolnego paska */
  bottom: calc(var(--bottombar-height) + 4px);
  left: 50%;
  transform: translateX(-50%);
  transition: bottom 0.3s ease-out;

  background-color: #000000;
  color: white;
  padding: 12px 20px;
  border-radius: 24px;
  font-size: 14px;
  font-weight: 500;
  display: none;
  align-items: center;
  justify-content: center;
  gap: 10px;
  z-index: 10500; /* Znacząco podniesiony z-index */
  white-space: nowrap; /* ✅ FIX: Wymuś jedną linię dla krótkich tekstów */

  /* ✅ FIX: Szerokość dopasowana do treści, z marginesami */
  width: fit-content;
  max-width: calc(100vw - 40px); /* Maksymalna szerokość z marginesami po 20px */

  box-shadow: 0 4px 15px rgba(0,0,0,0.5);
  border: 1px solid #000;
  animation: fadeInOut 4s ease-in-out forwards;
  box-sizing: border-box;
  text-align: center;
}

#app-frame.hide-ui #alertBox {
  /* ✅ FIX: Dostosowano pozycję w trybie immersyjnym */
  bottom: calc(var(--video-controls-height) + var(--safe-area-bottom) + 12px);
}

#alertBox svg {
    width: 22px;
    height: 22px;
    flex-shrink: 0;
}

#alertText {
    display: block;
    min-width: 0;
    flex-grow: 1;
    white-space: normal; /* ✅ FIX: Pozwól długim tekstom na zawijanie */
}

#alertBox.visible {
  display: flex;
}
@keyframes fadeInOut {
  0% {
    opacity: 0;
    transform: translate(-50%, 10px);
  }
  10% {
    opacity: 1;
    transform: translate(-50%, 0);
  }
  90% {
    opacity: 1;
    transform: translate(-50%, 0);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, 10px);
  }
}
.modal-overlay,
.fl-modal-overlay,
#commentsModal,
.account-modal-overlay,
.crop-modal,
.image-lightbox {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  z-index: 10200;
  opacity: 0;
  visibility: hidden;
  transition:
    opacity 0.3s ease-out,
    visibility 0.3s ease-out;
  overflow: hidden;
}
.modal-overlay.visible {
  opacity: 1;
  visibility: visible;
}
.modal-content {
  z-index: 2001;
  position: relative;
  /* Generic transition for modals that fade/scale */
  transition: transform 0.3s ease-out, opacity 0.3s ease-out;
}

/* Default state for modals that just fade/scale */
.modal-overlay:not(#comments-modal-container) .modal-content {
  opacity: 0;
  transform: scale(0.95);
}

.modal-overlay.visible:not(#comments-modal-container) .modal-content {
    opacity: 1;
    transform: scale(1);
}

.modal-close-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: none;
  border: none;
  font-size: 28px;
  line-height: 1;
  cursor: pointer;
  padding: 0;
  color: #111;
  z-index: 10;
  opacity: 0.7;
  transition: opacity 0.2s;
}
.modal-close-btn:hover {
  opacity: 1;
  transform: scale(1.1);
  background-color: rgba(0,0,0,0.1);
}

/* Modal: Info */
.info-modal-overlay {
    background: transparent;
    transition: background-color 0.6s ease; /* Zmieniamy na tło */
}

.info-modal-overlay.visible {
    background: transparent;
}

.info-modal-content {
    position: relative;
    width: 100%;
    height: 100vh;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    display: flex !important;
    flex-direction: column;
    will-change: transform, opacity;
    transform: scale(0.95) translateY(10px);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s ease;
}

.info-modal-overlay.visible .info-modal-content {
    transform: scale(1) translateY(0);
    opacity: 1;
}

#infoModal .modal-body {
  overflow-y: auto;
  padding: 16px 24px;
  -webkit-overflow-scrolling: touch;
}

#infoModal .modal-body::-webkit-scrollbar {
    width: 4px;
}
#infoModal .modal-body::-webkit-scrollbar-track {
    background: transparent;
}
#infoModal .modal-body::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
}
#infoModal .modal-body::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.4);
}

#infoModal h2 {
  margin-top: 0;
  padding-right: 40px;
  color: #fff;
  border-bottom: 1px solid rgba(255,255,255,0.15);
  padding-bottom: 10px;
  margin-bottom: 15px;
}
#infoModal h3 {
    margin-top: 20px;
    margin-bottom: 10px;
    color: #f0f0f0;
}
#infoModal p,
#infoModal li {
    color: #dcdcdc;
}
#infoModal .modal-close-btn {
  color: #fff;
  opacity: 0.7;
}
#infoModal .modal-close-btn:hover {
  opacity: 1;
  background-color: transparent;
  transform: none;
}

#infoModal ul {
    padding-left: 20px;
}

#infoModal li {
    margin-bottom: 8px;
}

.crowdfunding-container {
    padding: 16px 10px;
    text-align: center;
}

.crowdfunding-header {
    margin-bottom: 24px;
    text-align: center;
}

.crowdfunding-title {
    font-size: 26px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 8px;
    text-align: center;
    width: 100%;
}

.crowdfunding-subtitle {
    font-size: 15px;
    color: rgba(255, 255, 255, 0.7);
    line-height: 1.5;
    max-width: 90%;
    margin: 0 auto;
    margin-bottom: 16px;
}

.crowdfunding-description {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.6;
    max-width: 90%;
    margin: 0 auto 24px;
}

#infoModal .premiere-date-value {
    color: #FFFFFF;
    font-weight: 700;
    font-size: 22px;
    margin-top: 4px;
}

.progress-section {
    margin-bottom: 20px;
}

.progress-bar-wrapper {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 3px;
    position: relative;
    overflow: hidden;
}

.progress-bar-fill {
    height: 12px;
    background: linear-gradient(90deg, #ff0055, #ff4081);
    border-radius: 7px;
    transition: width 1s ease-in-out;
    box-shadow: 0 0 10px rgba(255, 0, 85, 0.4);
}

.progress-bar-sparkle {
    position: absolute;
    top: 0;
    left: 0;
    width: 20px;
    height: 100%;
    background: rgba(255, 255, 255, 0.4);
    filter: blur(4px);
    transform: skewX(-20deg);
    animation: sparkle-animation 2.5s infinite linear;
}

@keyframes sparkle-animation {
    0% { left: -10%; }
    100% { left: 110%; }
}

.progress-label {
    margin-top: 8px;
    font-size: 13px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.6);
}

.countdown-section {
    margin-bottom: 24px;
}

.countdown-value {
    font-size: 22px;
    font-weight: 700;
    color: #fff;
    letter-spacing: 2px;
    display: flex;
    gap: 10px;
    justify-content: center;
}

.countdown-part {
    display: flex;
    flex-direction: column;
}

.countdown-label-small {
    font-size: 10px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.5);
    text-transform: uppercase;
}

.premiere-date-label {
    margin-top: 16px;
    font-size: 14px;
    color: rgba(255, 255, 255, 0.7);
}

.countdown-label {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.5);
    margin-top: 16px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 28px;
}

.stat-item {
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 12px;
    display: flex;
    flex-direction: column;
}

.stat-value {
    font-size: 20px;
    font-weight: 600;
    color: #fff;
}

.stat-label {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.6);
    text-transform: uppercase;
}

.cta-section {
    margin-top: 20px;
}

.cta-button {
    background: linear-gradient(135deg, #ff0055, #ff4081);
    color: #fff;
    border: none;
    border-radius: 14px;
    padding: 14px 28px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(255, 0, 85, 0.3);
    display: inline-flex;
    align-items: center;
    gap: 12px;
}

.cta-button:hover {
    transform: translateY(-3px) scale(1.03);
    box-shadow: 0 10px 30px rgba(255, 0, 85, 0.5);
}

.shiny-tip-button {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

.shiny-tip-button svg {
    width: 24px;
    height: 24px;
    fill: #fff;
    stroke: none;
}

.shiny-tip-button::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(0deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
    transform: rotate(30deg);
    animation: shiny-effect 3s infinite linear;
}

@keyframes shiny-effect {
    0% {
        transform: rotate(30deg) translateX(-150%);
    }
    100% {
        transform: rotate(30deg) translateX(150%);
    }
}


/* ==========================================================================
           --- NOTIFICATION POPUP ---
           ========================================================================== */
.notification-popup {
  position: fixed;
  top: calc(var(--safe-area-top) + 10px);
  left: 50%;
  width: 350px;
  max-width: calc(100vw - 20px);
  background: rgba(30, 30, 30, 0.9);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
  z-index: 10100;
  color: white;
  font-family:
    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial,
    sans-serif;
  -webkit-backdrop-filter: blur(12px) saturate(120%);
  backdrop-filter: blur(12px) saturate(120%);
  opacity: 0;
  transform: translateX(-50%) scale(0.95);
  transition:
    opacity 0.2s ease-out,
    transform 0.2s ease-out,
    visibility 0.2s;
  visibility: hidden;
  pointer-events: none;
  display: flex;
  flex-direction: column;
}
.notification-popup.visible {
  opacity: 1;
  transform: translateX(-50%) scale(1);
  visibility: visible;
  pointer-events: auto;
}
.notification-header {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  font-weight: 600;
  font-size: 16px;
  flex-shrink: 0;
  position: relative;
}
.notification-header button {
  background: none;
  border: none;
  color: white;
  font-size: 24px;
  line-height: 1;
  padding: 0 4px;
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.2s;
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
}
.notification-header button:hover {
  opacity: 1;
}
.notification-list {
  list-style: none;
  margin: 0;
  padding: 8px;
  max-height: 80vh;
  overflow-y: auto;
  flex-grow: 1;
}
.notification-list::-webkit-scrollbar {
  width: 4px;
}
.notification-list::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.3);
  border-radius: 2px;
}

.notification-item {
  border-radius: 8px;
  cursor: pointer;
  transition: background-color 0.2s ease-out;
  margin-bottom: 4px;
}
.notification-item:hover {
  background-color: rgba(255, 255, 255, 0.08);
}
.notification-item.unread .notif-preview {
  font-weight: 600;
}

.notif-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
}

.notif-icon {
  width: 24px;
  height: 24px;
  flex-shrink: 0;
  color: rgba(255, 255, 255, 0.8);
}

.notif-content-wrapper {
  flex-grow: 1;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 8px;
}

.notif-summary {
  display: flex;
  flex-direction: column;
}

.notif-preview {
  font-size: 14px;
  line-height: 1.3;
  color: rgba(255, 255, 255, 0.95);
}
.notif-time {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
}
.expand-chevron {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
  align-self: center;
  transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  color: rgba(255, 255, 255, 0.6);
}
.notification-item.expanded .expand-chevron {
  transform: rotate(180deg);
}

.unread-dot {
  width: 8px;
  height: 8px;
  background-color: var(--accent-color);
  border-radius: 50%;
  flex-shrink: 0;
  align-self: center;
  transition:
    opacity 0.3s,
    transform 0.3s;
}

.notification-item:not(.unread) .unread-dot {
  opacity: 0;
  transform: scale(0);
}

.notif-full-details {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.35s ease-out;
}
.notification-item.expanded .notif-full-details {
  max-height: 200px;
}
.notif-full-details-content {
  padding: 0 12px 12px 48px;
  font-size: 14px;
  line-height: 1.5;
  color: rgba(255, 255, 255, 0.8);
  opacity: 0;
  transition: opacity 0.2s ease-in 0.15s;
}
.notification-item.expanded .notif-full-details-content {
  opacity: 1;
}

.notification-empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  padding: 40px 20px;
  text-align: center;
  color: rgba(255, 255, 255, 0.6);
}
.notification-empty-state svg {
  width: 48px;
  height: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}
.notification-empty-state p {
  font-size: 14px;
  font-weight: 500;
}
.notification-empty-state.hidden-by-js {
  display: none !important;
}

/* ==========================================================================
           --- NEW ACCOUNT PANEL STYLES ---
           ========================================================================== */
.account-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  background: transparent;
  z-index: 10200;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.6s ease, visibility 0.6s ease;
  overflow: hidden;
}

.account-modal-overlay.visible {
  opacity: 1;
  visibility: visible;
}

.account-modal-content {
  position: relative;
  width: 100%;
  height: 100vh;
  background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
  transform: translateX(-100%);
  display: flex;
  flex-direction: column;
  transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  will-change: transform;
}

.account-modal-overlay.visible .account-modal-content {
  transform: translateX(0);
}

.account-modal-overlay.is-hiding .account-modal-content {
  transform: translateX(-100%);
  transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}


.account-header {
  position: relative;
  height: var(--topbar-height);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 20px; /* Simplified padding */
  padding-top: var(--safe-area-top);
  flex-shrink: 0;
}

.account-header h2 {
  font-size: 16px;
  font-weight: 600;
  color: #fff;
  margin: 0; /* FIX: Remove default margin for perfect centering */
}

.close-btn {
  position: absolute;
  right: 4px;
  top: var(--safe-area-top);
  height: var(
    --topbar-base-height
  ); /* FIX: Set height to match visible header area */
  width: 40px;
  background: none;
  border: none;
  color: #fff;
  font-size: 24px;
  font-weight: 400;
  line-height: 1;
  cursor: pointer;
  display: flex;
  align-items: center; /* FIX: Vertical centering */
  justify-content: center; /* FIX: Horizontal centering */
  transition: all 0.2s ease;
  z-index: 10;
}

.close-btn:hover {
  opacity: 0.8;
}

.close-btn:active {
  transform: scale(0.9);
}

.account-tabs {
  display: flex;
  background: rgba(255, 255, 255, 0.03);
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  margin: 0;
  padding: 0;
  flex-shrink: 0;
}

.tab-btn {
  flex: 1;
  padding: 14px 8px;
  background: rgba(255, 255, 255, 0.08);
  border: none;
  border-left: 1px solid rgba(255, 255, 255, 0.1);
  border-bottom: 2px solid transparent;
  color: #fff;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  position: relative;
  transition: all 0.3s ease;
  border-radius: 0;
}

.tab-btn:hover {
  color: rgba(255, 255, 255, 0.9);
  background: rgba(255, 255, 255, 0.05);
}

.tab-btn.active {
  color: rgba(255, 255, 255, 0.6);
  background: none;
  border-bottom-color: var(--accent-color);
}

.tab-btn:last-child {
  border-right: 1px solid rgba(255, 255, 255, 0.1);
}

.account-content {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: calc(80px + var(--safe-area-bottom)); /* Zwiększony padding na dole */
  position: relative; /* Niezbędne dla kontekstu pozycjonowania potomnych elementów */
}

.account-content::-webkit-scrollbar {
  display: none;
}

.tab-pane {
  display: none;
  padding: 20px 16px;
}
.tab-pane > *:last-child {
  margin-bottom: 0;
}

.tab-pane.active {
  display: block;
}

.profile-section,
.avatar-section,
.form-section,
.settings-section {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.section-title {
  font-size: 18px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.section-title::before {
  content: "";
  width: 4px;
  height: 18px;
  background: linear-gradient(180deg, #ff0055, #ff4081);
  border-radius: 2px;
}

.avatar-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  text-align: center;
  position: relative;
}

.avatar-wrapper {
  position: relative;
  width: 80px;
  height: 80px;
  flex-shrink: 0;
}

.avatar-container {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  overflow: hidden;
  border: 2px solid rgba(255, 255, 255, 0.8);
  box-shadow: 0 0 15px rgba(255, 0, 85, 0.3);
}

.avatar-img {
  width: 100%;
  height: 100%;
  display: block;
  object-fit: cover;
  transition: all 0.2s;
}

.avatar-edit-btn {
  position: absolute;
  bottom: -12px;
  left: 50%;
  transform: translateX(-50%);
  width: 28px;
  height: 28px;
  background: var(--accent-color, #ff0055);
  border: 2px solid #2d2d2d;
  border-radius: 50%;
  color: white;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: bold;
  line-height: 1;
  z-index: 2;
}

.avatar-edit-btn:hover {
  transform: translateX(-50%) scale(1.1);
}

.avatar-info {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}

.avatar-name {
  font-size: 18px;
  font-weight: 700;
  color: #fff;
  margin: 0;
}

.avatar-email {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.6);
  margin: 0;
  margin-bottom: 6px;
}

.user-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  background: linear-gradient(135deg, #ffd700, #ffb347);
  color: #2d1b00;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
}

.badge-icon {
  width: 14px;
  height: 14px;
}

.toggle-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}

.toggle-label {
  font-size: 14px;
  color: white;
  margin: 0;
}

.toggle-switch {
  position: relative;
  width: 50px;
  height: 24px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.toggle-switch.active {
  background: linear-gradient(135deg, #ff0055, #ff4081);
  border-color: #ff0055;
}

.toggle-slider {
  position: absolute;
  top: 1px;
  left: 1px;
  width: 22px;
  height: 22px;
  background: #fff;
  border-radius: 50%;
  transition: transform 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.toggle-switch.active .toggle-slider {
  transform: translateX(26px);
}

.language-selector {
  display: flex;
  gap: 8px;
}

.language-option {
  flex: 1;
  padding: 12px 16px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 8px;
  color: rgba(255, 255, 255, 0.7);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
}

.language-option:hover {
  background: rgba(255, 255, 255, 0.12);
  color: rgba(255, 255, 255, 0.9);
  border-color: rgba(255, 255, 255, 0.3);
}

.language-option.active {
  background: linear-gradient(135deg, #ff0055, #ff4081);
  border-color: #ff0055;
  color: #fff;
  transform: scale(1.02);
}

.form-group {
  margin-bottom: 18px; /* FIX: Adjusted spacing */
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 16px;
}

.form-label {
  display: block;
  font-size: 14px;
  font-weight: 500;
  color: white;
  margin-bottom: 8px; /* FIX: Adjusted spacing */
}

.form-input {
  width: 100%;
  padding: 12px 16px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 12px;
  color: #fff;
  font-size: 16px;
  transition: all 0.3s ease;
}

.form-input:focus {
  outline: none;
  border-color: #ff0055;
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 0 3px rgba(255, 0, 85, 0.1);
}

.form-input::placeholder {
  color: rgba(255, 255, 255, 0.5);
}
.form-section .form-group:last-of-type,
.settings-section .form-group:last-of-type,
#password-tab .form-group:last-of-type,
#delete-tab .form-group:last-of-type {
  margin-bottom: 0;
}

.btn-primary {
  background: linear-gradient(135deg, #ff0055, #ff4081);
  border: 1px solid rgba(255, 255, 255, 0.8);
  padding: 14px 24px;
  border-radius: 12px;
  color: #fff;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  width: 100%;
  margin-top: 8px;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(255, 0, 85, 0.3);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn-danger {
  background: linear-gradient(135deg, #dc2626, #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.8);
  padding: 14px 24px;
  border-radius: 12px;
  color: #fff;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  width: 100%;
  margin-top: 8px;
}

.btn-danger:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(220, 38, 38, 0.3);
}

.status-message {
  padding: 12px 16px;
  border-radius: 8px;
  margin-top: 16px;
  font-size: 14px;
  font-weight: 500;
  display: none;
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.3s ease;
}

.status-message.show {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

.status-success {
  background: rgba(34, 197, 94, 0.15);
  border: 1px solid rgba(34, 197, 94, 0.3);
  color: #22c55e;
}

.status-error {
  background: rgba(239, 68, 68, 0.15);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
}

.helper-text {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.5);
  margin-top: 8px;
  line-height: 1.4;
}

.crop-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  background: rgba(0, 0, 0, 0.95);
  z-index: 3000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
overflow: hidden;
}

.crop-modal.visible {
  display: flex;
}

.crop-modal-content {
  background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
  border-radius: 16px;
  width: 100%;
  max-width: 400px;
  display: flex;
  flex-direction: column;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.7);
  animation: premiumEntrance 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.crop-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.crop-header h3 {
  font-size: 16px;
  font-weight: 600;
  margin: 0;
}

.crop-header .close-btn {
  font-size: 24px;
  font-weight: 400;
  color: #fff;
  opacity: 0.7;
}

.crop-body {
  padding: 20px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.crop-canvas-container {
  position: relative;
  width: 300px;
  height: 300px;
  max-width: 100%;
  border-radius: 50%;
  overflow: hidden;
  cursor: grab;
}

.crop-canvas-container:active {
  cursor: grabbing;
}

#cropCanvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.crop-overlay-circle {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
  pointer-events: none;
  border: 2px dashed rgba(255, 255, 255, 0.7);
}

.crop-footer {
  padding: 16px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.zoom-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}

.zoom-btn {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: #fff;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.zoom-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}

.zoom-slider {
  flex: 1;
  -webkit-appearance: none;
  appearance: none;
  width: 100%;
  height: 4px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 2px;
  outline: none;
}

.zoom-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  background: #fff;
  cursor: pointer;
  border-radius: 50%;
  border: 2px solid var(--accent-color);
}

.zoom-slider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  background: #fff;
  cursor: pointer;
  border-radius: 50%;
  border: 2px solid var(--accent-color);
}

#cropSaveBtn {
  margin-top: 0;
}

.file-input {
  display: none;
}

.loading-spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

@media (max-width: 480px) {
  .tab-pane {
    padding: 16px;
  }
  .profile-section,
  .avatar-section,
  .form-section,
  .settings-section {
    padding: 16px;
  }
}

/* ==========================================================================
           --- STYLE POMOCNICZE I DOSTĘPNOŚĆ ---
           ========================================================================== */
.tiktok-symulacja .hidden-by-js {
  display: none !important;
}
#bmc-wbtn {
  /* Ukryj domyślny przycisk BuyMeACoffee */
  display: none !important;
  opacity: 0 !important;
  pointer-events: none !important;
}
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.001ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.001ms !important;
  }
}
.tiktok-symulacja .icon-button:focus-visible,
.tiktok-symulacja .profileButton:focus-visible,
.tiktok-symulacja .logged-in-menu a:focus-visible {
  outline: 2px solid white;
  outline-offset: 2px;
}

#app-frame {
  position: relative; /* Make this the positioning context */
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  overflow: hidden; /* Prevent modals from overflowing */
  z-index: 2000;
}


/* PWA Prompt Styles from Reference */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.001ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.001ms !important;
  }
}
.pwa-prompt {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #333;
  color: white;
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem;
  padding-bottom: calc(1rem + var(--safe-area-bottom));
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
  transform: translateY(100%);
  transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  visibility: hidden;
  height: var(--bottombar-height);
}
.pwa-prompt.visible {
  transform: translateY(0);
  visibility: visible;
}
.pwa-prompt-content {
  display: flex;
  flex-direction: column;
}
.pwa-prompt-title {
  font-weight: bold;
  font-size: 1.1rem;
  margin: 0 0 0.25rem 0;
}
.pwa-prompt-description {
  font-size: 0.9rem;
  margin: 0;
  opacity: 0.8;
}
.pwa-prompt-button {
  background-color: var(--accent-color);
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  flex-shrink: 0;
  margin-left: 1rem;
  position: relative; /* Create a new stacking context */
  z-index: 1; /* Ensure it's above other content in the same flex container */
  pointer-events: auto !important; /* Force clickability */
}
.pwa-prompt-ios {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: rgba(20, 20, 20, 0.9);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color: white;
  z-index: 10001;
  padding: 1rem;
  padding-bottom: calc(1rem + var(--safe-area-bottom));
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  transform: translateY(100%);
  transition:
    transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94),
    visibility 0.5s;
  visibility: hidden;
}
.pwa-prompt-ios.visible {
  transform: translateY(0);
  visibility: visible;
}
.pwa-ios-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  font-weight: bold;
  font-size: 1.2rem;
}
.pwa-ios-close-button {
  background: none;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  opacity: 0.7;
}
.pwa-ios-body {
  font-size: 1rem;
  line-height: 1.5;
}

.pwa-ios-body p {
  display: flex;
  align-items: center;
  gap: 0.5em;
  margin-bottom: 0.75rem;
}

.pwa-ios-body p:last-child {
  margin-bottom: 0;
}

.pwa-ios-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  width: 24px;
  height: 24px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
}

.pwa-ios-icon svg {
  width: 20px;
  height: 20px;
  fill: currentColor;
}

/* --- Desktop PWA Modal --- */
#pwa-desktop-modal {
  z-index: 10004;
}
#pwa-desktop-modal .modal-content {
  background: white;
  color: #111;
  border-radius: 12px;
  max-width: 90%;
  width: 450px;
  padding: 20px;
  text-align: center;
}

#pwa-desktop-modal h2 {
  margin-top: 0;
  padding-right: 40px; /* Space for the close button */
  font-size: 1.4rem;
  margin-bottom: 1rem;
}

#pwa-desktop-modal .modal-body p {
  line-height: 1.5;
  font-size: 1rem;
  color: #333;
}

#pwa-desktop-modal .modal-close-btn {
  color: #111;
}

/* --- Video Error Overlay --- */
.error-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  -webkit-backdrop-filter: blur(8px);
  backdrop-filter: blur(8px);
  z-index: 102; /* Above pause, below sidebar */
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  text-align: center;
  padding: 20px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.error-overlay .error-icon {
  width: 64px;
  height: 64px;
  margin-bottom: 24px;
  color: #ffc107; /* A warning yellow */
  filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.4));
}

.error-overlay .error-title {
  font-size: 22px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 4px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
}

.error-overlay .error-subtitle {
  font-size: 16px;
  color: rgba(255, 255, 255, 0.8);
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  margin-bottom: 24px;
}

.error-overlay .error-retry-button {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  padding: 12px 24px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 24px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.error-overlay .error-retry-button:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.5);
}

.error-overlay .error-retry-button:active {
  transform: scale(0.95);
}

/* Styles for installed PWA bar */

.force-hide {
  display: none !important;
}


/* --- Toast Notification --- */
/* (This style is now handled by #alertBox for consistency) */

/* ============================================================================
   WELCOME MODAL STYLES - Premium Design
   ============================================================================ */

/* Overlay z mocnym blur */
.welcome-modal {
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  z-index: 10010;
}

/* Content - premium card */
.welcome-modal-content {
  background: linear-gradient(165deg, #2a2a2a 0%, #1a1a1a 100%);
  border-radius: 28px;
  padding: 0;
  width: 92%;
  max-width: 460px;
  text-align: center;
  border: 2px solid rgba(255, 0, 85, 0.3);
  box-shadow:
    0 32px 80px rgba(0, 0, 0, 0.9),
    0 0 80px rgba(255, 0, 85, 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.05);
  overflow: hidden;
  position: relative;
}

/* Ambient glow effect */
.welcome-modal-content::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(
    circle at center,
    rgba(255, 0, 85, 0.08) 0%,
    transparent 60%
  );
  animation: ambientPulse 4s ease-in-out infinite;
  pointer-events: none;
}

@keyframes ambientPulse {
  0%, 100% { opacity: 0.3; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(1.1); }
}

/* Ikona na górze z zaawansowanym gradientem */
.welcome-icon-wrapper {
  background: linear-gradient(135deg, #ff0055 0%, #ff4081 50%, #ff0055 100%);
  background-size: 200% 200%;
  padding: 40px;
  margin: 0;
  position: relative;
  overflow: hidden;
  animation: gradientShift 8s ease infinite;
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.welcome-icon-wrapper::before {
  content: '';
  position: absolute;
  top: -60%;
  left: -60%;
  width: 220%;
  height: 220%;
  background: radial-gradient(
    circle,
    rgba(255, 255, 255, 0.15) 0%,
    transparent 60%
  );
  animation: shimmer 4s ease-in-out infinite;
}

@keyframes shimmer {
  0%, 100% { transform: translate(0, 0) scale(1); }
  50% { transform: translate(15%, 15%) scale(1.05); }
}

.welcome-icon {
  width: 72px;
  height: 72px;
  color: #fff;
  filter: drop-shadow(0 6px 20px rgba(0, 0, 0, 0.5));
  position: relative;
  z-index: 1;
  animation: iconFloat 3s ease-in-out infinite;
}

@keyframes iconFloat {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-8px); }
}

/* Signature line (dekoracja) */
.welcome-signature {
  margin-top: 24px;
  padding-top: 20px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  position: relative;
}

.signature-line {
  width: 60px;
  height: 2px;
  background: linear-gradient(90deg, transparent, #ff0055, transparent);
  margin: 0 auto 16px;
  border-radius: 1px;
  box-shadow: 0 0 15px rgba(255, 0, 85, 0.5);
}

/* Tytuł z efektem świecenia */
.welcome-title {
  font-size: 32px;
  font-weight: 900;
  color: #fff;
  margin: 28px 24px 12px;
  line-height: 1.1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  text-shadow:
    0 0 20px rgba(255, 0, 85, 0.5),
    0 4px 12px rgba(0, 0, 0, 0.7);
  position: relative;
  z-index: 1;
}

.welcome-title-main {
  animation: titleGlow 2s ease-in-out infinite;
}

@keyframes titleGlow {
  0%, 100% { text-shadow: 0 0 20px rgba(255, 0, 85, 0.4); }
  50% { text-shadow: 0 0 30px rgba(255, 0, 85, 0.7); }
}

.welcome-title-emoji {
  font-size: 36px;
  animation: sparkle 2.5s ease-in-out infinite;
  display: inline-block;
}

@keyframes sparkle {
  0%, 100% { transform: scale(1) rotate(0deg); }
  25% { transform: scale(1.15) rotate(-15deg); }
  75% { transform: scale(1.15) rotate(15deg); }
}

/* Body z efektem glassmorphism */
.welcome-body {
  padding: 0 28px 36px;
  position: relative;
  z-index: 1;
}

/* Hero text z premium typografią */
.welcome-text-hero {
  font-size: 24px;
  font-weight: 800;
  color: #fff;
  margin: 0 0 24px;
  line-height: 1.3;
  text-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  letter-spacing: -0.5px;
}

/* Divider z animacją */
.welcome-divider {
  width: 80px;
  height: 4px;
  background: linear-gradient(90deg, transparent, #ff0055, #ff4081, transparent);
  background-size: 200% 100%;
  margin: 0 auto 28px;
  border-radius: 2px;
  box-shadow: 0 0 20px rgba(255, 0, 85, 0.6);
  animation: dividerFlow 3s ease-in-out infinite;
}

@keyframes dividerFlow {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

/* Highlight text z premium efektami */
.welcome-text-highlight {
  font-size: 28px;
  font-weight: 900;
  background: linear-gradient(135deg, #fff 0%, #ff0055 50%, #ff4081 100%);
  background-size: 200% 200%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin: 0 0 16px;
  letter-spacing: 0.5px;
  animation: textShimmer 4s ease infinite;
  text-shadow: 0 0 30px rgba(255, 0, 85, 0.8);
}

@keyframes textShimmer {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

/* Description z lepszą czytelnością */
.welcome-text-description {
  font-size: 17px;
  color: rgba(255, 255, 255, 0.95);
  margin: 0 0 36px;
  line-height: 1.6;
  font-weight: 500;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
}

/* Premium buttons */
.welcome-actions {
  display: flex;
  flex-direction: column;
  gap: 14px;
  margin-bottom: 24px;
}

.tipping-currency-wrapper {
    position: relative;
    display: inline-flex;
}

.amount-input-wrapper {
    position: relative;
    flex-grow: 1;
    display: flex;
}

.amount-placeholder-zero {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #8e8e93;
    pointer-events: none;
    transition: opacity 0.2s ease-in-out;
    font-size: 24px;
    font-weight: 600;
}

.elegant-modal-input.amount-input:not(:placeholder-shown) + .amount-placeholder-zero,
.elegant-modal-input.amount-input:focus + .amount-placeholder-zero {
    opacity: 0;
}

.tipping-currency-select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-color: transparent;
    border: none;
    color: white;
    padding: 10px 10px 10px 15px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    outline: none;
}

.tipping-currency-wrapper::after {
    content: ''; /* Remove the default arrow */
    display: none;
}

.tipping-currency-wrapper {
    position: relative;
    display: inline-flex;
}

.tipping-currency-select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-color: #333;
    border: 1px solid #555;
    color: white;
    padding: 10px 30px 10px 15px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    outline: none;
}

.tipping-currency-wrapper::after {
    content: '▼';
    font-size: 12px;
    color: #999;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
}

.welcome-btn {
  padding: 18px 28px;
  border-radius: 16px;
  font-size: 17px;
  font-weight: 800;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  position: relative;
  overflow: hidden;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

/* Ripple effect */
.welcome-btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.8s ease-out, height 0.8s ease-out;
}

.welcome-btn:active::before {
  width: 400px;
  height: 400px;
}

.welcome-btn svg {
  width: 22px;
  height: 22px;
  position: relative;
  z-index: 1;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
}

.welcome-btn span {
  position: relative;
  z-index: 1;
}

/* Primary button - premium gradient */
.welcome-btn-primary {
  background: linear-gradient(135deg, #ff0055 0%, #ff4081 50%, #ff0055 100%);
  background-size: 200% 200%;
  color: #fff;
  box-shadow:
    0 12px 32px rgba(255, 0, 85, 0.5),
    0 0 40px rgba(255, 0, 85, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);
  animation: primaryGradient 3s ease infinite;
}

@keyframes primaryGradient {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.welcome-btn-primary:hover {
  transform: translateY(-4px) scale(1.02);
  box-shadow:
    0 16px 48px rgba(255, 0, 85, 0.6),
    0 0 60px rgba(255, 0, 85, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

.welcome-btn-primary:active {
  transform: translateY(-2px) scale(0.98);
}

/* Secondary button - glassmorphism */
.welcome-btn-secondary {
  background: rgba(255, 255, 255, 0.08);
  color: rgba(255, 255, 255, 0.95);
  border: 2px solid rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow:
    0 8px 24px rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.welcome-btn-secondary:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: rgba(255, 255, 255, 0.4);
  transform: translateY(-3px) scale(1.01);
  box-shadow:
    0 12px 32px rgba(0, 0, 0, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.welcome-btn-secondary:active {
  transform: translateY(-1px) scale(0.98);
}

/* Footer text z lepszym kontrastem */
.welcome-footer-text {
  font-size: 15px;
  color: rgba(255, 255, 255, 0.7);
  margin: 0;
  line-height: 1.6;
  letter-spacing: 0.3px;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
}

.welcome-footer-text strong {
  color: #ff0055;
  font-weight: 800;
}

/* Responsive refinements */
@media (max-width: 480px) {
  .welcome-modal-content {
    width: 96%;
    border-radius: 24px;
    border-width: 1.5px;
  }

  .welcome-icon-wrapper {
    padding: 32px;
  }

  .welcome-icon {
    width: 56px;
    height: 56px;
  }

  .welcome-title {
    font-size: 26px;
    margin: 24px 20px 10px;
  }

  .welcome-title-emoji {
    font-size: 28px;
  }

  .welcome-body {
    padding: 0 20px 32px;
  }

  .welcome-text-hero {
    font-size: 20px;
  }

  .welcome-text-highlight {
    font-size: 24px;
  }

  .welcome-text-description {
    font-size: 15px;
  }

  .welcome-btn {
    padding: 16px 24px;
    font-size: 15px;
  }

  .welcome-footer-text {
    font-size: 13px;
  }
}

/* Ultra-smooth entrance animation */
.welcome-modal.visible .welcome-modal-content {
  animation: premiumEntrance 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes premiumEntrance {
  0% {
    opacity: 0;
    transform: translateY(50px) scale(0.9) rotateX(-10deg);
  }
  60% {
    opacity: 1;
    transform: translateY(-10px) scale(1.02) rotateX(2deg);
  }
  100% {
    opacity: 1;
    transform: translateY(0) scale(1) rotateX(0);
  }
}

@keyframes slideOutDown {
  from {
    opacity: 1;
    transform: translateY(0) scale(1) rotateX(0);
  }
  to {
    opacity: 0;
    transform: translateY(50px) scale(0.9) rotateX(-10deg);
  }
}

.welcome-modal.is-hiding .welcome-modal-content {
  animation: slideOutDown 0.6s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
}


/* Animacja pojawiania się overlay */
@keyframes errorFadeIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* --- Underline Styles --- */
.secret-subtitle u,
.pwa-secret-subtitle u,
.pwa-prompt-description u {
  text-decoration: none;
  border-bottom-width: 2px;
  border-bottom-style: solid;
  padding-bottom: 1px;
  cursor: pointer;
}

/* Color for 'Log in' and 'Download' in the secret overlay */
.secret-subtitle u,
.pwa-secret-subtitle u {
  border-bottom-color: #fff; /* White */
}

/* Color for 'Download the app' (in all locations) */
.pwa-prompt-description u[data-translate-key="installPwaSubheadingAction"] {
  border-bottom: none !important;
  text-decoration: none !important;
}

.form-row {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}

.form-row .form-group {
  flex: 1;
  min-width: calc(50% - 8px);
}

/* --- FIX: Poprawki układu formularza --- */
#profile-tab #profileForm,
#profile-tab .form-row {
  display: flex;
  flex-direction: column;
  gap: 16px; /* Spójny odstęp między wszystkimi polami */
}

#profile-tab .form-group {
    margin-bottom: 0; /* Usuwamy stary margines, polegamy na 'gap' */
}

#profile-tab .form-label {
    margin-bottom: 8px; /* Dodajemy mały odstęp między etykietą a polem input */
}

/* ============================================================================
   DESKTOP - Zwężenie do proporcji 9:16 (jak telefon)
   ============================================================================ */

@media (min-width: 600px) {
  #tippingModal.elegant-modal-overlay {
    width: calc(100vh * 9 / 16) !important;
    max-width: 100% !important;
    left: 0 !important;
    right: 0 !important;
    margin: 0 auto !important;
    top: 0 !important;
    height: 100% !important;
    border-left: 1px solid var(--border-color) !important;
    border-right: 1px solid var(--border-color) !important;
    box-sizing: border-box !important;
  }
  /* Główny kontener aplikacji */
  #webyx-container {
    height: 100vh;
    width: calc(100vh * 9 / 16); /* Proporcje 9:16 */
    max-width: 100%;
    margin: 0 auto; /* Wyśrodkowanie */
    left: 0; /* POPRAWKA: Niezbędne do centrowania elementu fixed/absolute */
    right: 0; /* POPRAWKA: Niezbędne do centrowania elementu fixed/absolute */
    border-left: 1px solid #333;
    border-right: 1px solid #333;
    animation: cloud-wave 6s infinite ease-in-out;
    overflow: hidden;
  }

  /* App frame - jeśli używasz */
  #app-frame {
    width: calc(100vh * 9 / 16);
    max-width: 100%;
    margin: 0 auto;
    left: 0; /* POPRAWKA: Niezbędne do centrowania elementu fixed/absolute */
    right: 0; /* POPRAWKA: Niezbędne do centrowania elementu fixed/absolute */
  }

  /* [FIX] Centrowanie i ograniczanie szerokości paska PWA na desktopie */
  .pwa-prompt,
  .pwa-prompt-ios {
    width: calc(100vh * 9 / 16);
    max-width: 100%;
    left: 0;
    right: 0;
    margin: 0 auto;
    border-left: 1px solid #333;
    border-right: 1px solid #333;
  }

  /* NOWE: Ujednolicony selektor modali i widgetów */

  #commentsModal,
  .modal-overlay,
  .fl-modal-overlay,
  .elegant-modal-overlay,
  .crop-modal,
  .notification-popup,
  .image-lightbox,
  #bmc-w-modal-container,
  .account-modal-overlay,
  .profile-modal-overlay,
  #bmc-w-modal-container iframe,
  #bmc-w-modal-container > div
  {
    width: calc(100vh * 9 / 16) !important;
    max-width: 100% !important;
    left: 0 !important;
    right: 0 !important;
    margin: 0 auto !important;
    top: 0 !important;
    height: 100% !important;
    border-left: 1px solid var(--border-color) !important;
    border-right: 1px solid var(--border-color) !important;
    box-sizing: border-box !important;
  }

  /* NOWE: Wymuszenie dopasowania wewnętrznej zawartości modali do nowej szerokości */
  .modal-overlay .modal-content,
  .fl-modal-overlay .fl-modal-content,
  .crop-modal .crop-modal-content,
  .notification-popup,
.account-modal-content
  {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
    left: 0 !important;
    right: 0 !important;
    margin: 0 !important;
    top: 0 !important;
  }

  /* Poprawka dla popupu powiadomień, aby nie miał podwójnego obramowania */
  .notification-popup {
      border: 1px solid rgba(255, 255, 255, 0.15) !important;
  }

  body {
    background-image: url('chmurki.jpg') !important;
    background-repeat: no-repeat !important;
    background-position: center center !important;
    background-attachment: fixed !important;
    background-size: cover !important;
    overflow-x: hidden;
  }


  @keyframes subtleShimmer {
    0%, 100% { transform: scale(1); opacity: 0.9; }
    50% { transform: scale(1.1); opacity: 1; }
  }

  /* Wymuszenie czarnego tła dla emulatora i jego zawartości */
  #webyx-container, #preloader {
    background: #000 !important;
    color: #fff !important;
  }
  #preloader h2, #preloader button {
      color: #fff !important;
  }

  #preloader {
    width: calc(100vh * 9 / 16);
    max-width: 100%;
    margin: 0 auto;
    left: 0;
    right: 0;
    border-left: 1px solid #333;
    border-right: 1px solid #333;
    animation: cloud-wave 6s infinite ease-in-out;
    background: #000 !important;
  }
}

/* ============================================================================
   TABLET - Dla tabletów (600px - 1024px)
   ============================================================================ */

@media (min-width: 600px) and (max-width: 1024px) {
  #webyx-container {
    border-left: 1px solid #444;
    border-right: 1px solid #444;
  }
}

/* ============================================================================
   DESKTOP - Dla dużych ekranów (>1024px)
   ============================================================================ */

@media (min-width: 1024px) {
  #webyx-container {
    border-left: 2px solid #555;
    border-right: 2px solid #555;
    box-shadow: 0 0 80px rgba(0, 0, 0, 0.8);
  }
}

/* ============================================================================
   OPCJONALNIE - Gradient background za aplikacją
   ============================================================================ */

/* WZMOCNIONE ukrywanie w trybie standalone */
@media (display-mode: standalone) {
  .pwa-prompt,
  .pwa-prompt-ios {
    display: none;
    visibility: hidden;
    opacity: 0;
    pointer-events: none;
    height: 0;
    overflow: hidden;
  }

  /* ✅ FIX: Gwarantuje pełną wysokość w trybie PWA */
  #app-frame {
    height: 100% !important;
  }
}

/* DODAJ TAKŻE dla iOS */
@media (display-mode: fullscreen) {
  .pwa-prompt,
  .pwa-prompt-ios {
    display: none;
    visibility: hidden;
    opacity: 0;
    pointer-events: none;
    height: 0;
    overflow: hidden;
  }
}

/* Ukryj pasek PWA gdy standalone na iOS */
@media (display-mode: standalone) and (-webkit-touch-callout: none) {
  .pwa-prompt,
  .pwa-prompt-ios {
    display: none;
  }
}
/* ============================================================================
   DESKTOP FIX - Zapewnienie poprawnego układu w trybie symulacji telefonu
   ============================================================================ */
@media (min-width: 600px) {
  /* ✅ FIX 1: Sekcje muszą używać 100% zamiast 100vw */
  .webyx-section {
    width: 100%; /* Zmiana z 100vw na 100% */
    height: 100vh;
    height: var(--app-height);
  }
  /* ✅ FIX 2: Video musi mieć object-fit: cover i być w granicach kontenera */
  .player,
  .tiktok-symulacja video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover; /* KRYTYCZNE: zapobiega rozciąganiu */
    object-position: center;
  }
  /* ✅ FIX 3: Iframe też musi być w granicach */
  .tiktok-symulacja iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  /* ✅ FIX 4: Sidebar - upewnij się że jest widoczny i dobrze pozycjonowany */
  .tiktok-symulacja .sidebar {
    display: flex; /* Wymuszenie widoczności */
    visibility: visible !important; /* Na wypadek gdyby coś go ukrywało */
  }
  /* ✅ FIX 5: Wszystkie overlay muszą używać 100% zamiast 100vw */
  .secret-overlay,
  .pwa-secret-overlay,
  .error-overlay,
  .pause-overlay,
  .replay-overlay {
    width: 100%;
  }
  /* ✅ FIX 6: Topbar i bottombar też muszą być w granicach */
  .topbar,
  .tiktok-symulacja .bottombar {
    width: 100%;
  }
  /* ✅ FIX 7: Login panel - dopasowanie do zwężonego kontenera */
  .login-panel {
    width: 100%;
  }
  /* ✅ FIX 8: Swiper wrapper - musi być w granicach */
  .swiper-wrapper {
    width: 100%;
  }
  /* ✅ FIX 9: Alert box - centrowanie w zwężonym kontenerze */
  #alertBox {
    left: 50%;
    transform: translateX(-50%);
    /* max-width jest teraz obsługiwany przez główną regułę z funkcją min() */
  }
  /* ✅ FIX 10: Video controls - zapewnienie widoczności */
  .video-controls {
    display: flex !important;
    z-index: 105;
  }
  /* ✅ FIX 11: Progress bar - pełna szerokość w kontenerze */
  .progress-bar {
    width: 100%;
    left: 0;
  }
  /* ✅ FIX 12: Bottombar text info - zapewnienie widoczności */
  .tiktok-symulacja .text-info {
    display: block;
    max-width: calc(100% - 80px); /* Odstęp od sidebara */
  }
}

/* ============================================================================
   DODATKOWE ZABEZPIECZENIA - dla wszystkich szerokości ekranu
   ============================================================================ */
/* Video zawsze z object-fit */
.player,
.tiktok-symulacja video {
  object-fit: cover;
  object-position: center;
}

/* Zapobieganie overflow */
.webyx-section,
.tiktok-symulacja {
  overflow: hidden;
}

/* Sidebar zawsze widoczny gdy video załadowane */
.tiktok-symulacja.video-loaded .sidebar {
  opacity: 1 !important;
  visibility: visible !important;
  display: flex !important;
}

/* ==========================================================================
   --- COMMENTS MODAL - COMPLETE REWRITE ---
   ========================================================================== */

#comments-modal-container.modal-overlay {
  align-items: flex-end !important; /* FIX: Override generic centering for bottom-sheet style */
  z-index: 10005;
  transition: visibility 0.3s ease-out;
}

#comments-modal-container .modal-content {
  background: #18191a;
  color: #e4e6eb;
  width: 100%;
  max-width: 100%;
  height: 75vh;
  border-radius: 16px 16px 0 0;
  padding: 0;
  transform: translateY(100%);
  transition: transform 0.4s ease-out;
  display: flex;
  flex-direction: column;
  border-top: 1px solid rgba(255, 255, 255, 0.15);
  position: relative;
}

/* Gdy klawiatura jest widoczna */
#comments-modal-container.keyboard-visible .modal-content {
  height: calc(100vh - var(--keyboard-offset, 0px));
  max-height: calc(100vh - var(--keyboard-offset, 0px));
  transition: height 0.3s ease-out, max-height 0.3s ease-out;
}

#comments-modal-container.visible .modal-content {
  transform: translateY(0);
}

#comments-modal-container.is-hiding .modal-content {
  transform: translateY(100%);
}

#comments-modal-container.is-hiding .modal-content {
  transform: translateY(100%);
}

/* Header */
#comments-modal-container .modal-header {
display: flex;
align-items: center;
justify-content: center;
position: relative;
padding: 0 12px;
flex-shrink: 0;
/* ZMIANA 1: Ustawienie wysokości na taką samą jak główny topbar */
height: var(--topbar-height);
/* ZMIANA 2: Dodanie paddingu dla strefy bezpiecznej */
padding-top: var(--safe-area-top);
/* ZMIANA 3: Usunięcie linii oddzielającej */
border-bottom: none;
}

#commentsTitle {
    font-size: 16px;
    font-weight: 600;
    color: #e4e6eb;
    margin: 0;
}

#comments-modal-container .modal-close-btn {
position: absolute;
/* ZMIANA 4: Umieszczenie przycisku w rogu (top i right 0) */
right: 0;
top: var(--safe-area-top);
height: var(--topbar-base-height); /* Utrzymanie obszaru klikalności 40px */
width: 40px;
font-size: 24px; /* Zmniejszenie rozmiaru 'X' */
color: #b0b3b8;
display: flex;
align-items: center;
justify-content: center;
/* Upewnienie się, że padding nie jest za duży */
padding: 0;
transform: none; /* Zabezpieczenie przed transform 50% */
}

#comments-modal-container .modal-close-btn:hover {
  background-color: rgba(255, 255, 255, 0.1);
  opacity: 1;
}

/* Body - scrollowalna lista */
#comments-modal-container .modal-body {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 8px;
  -webkit-overflow-scrolling: touch;
  transition: padding-bottom 0.3s ease-out;
}

#comments-modal-container.keyboard-visible .comment-form-container {
  box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
}

/* Comment Form Container - ZAWSZE NA DOLE */
.comment-form-container {
  padding: 8px 12px;
  background: #18191a;
  border-top: 1px solid #3a3b3c;
  flex-shrink: 0;
  position: sticky;
  bottom: 0;
  left: 0;
  width: 100%;
  z-index: 10;
}

#comments-modal-container.keyboard-visible .comment-form-container {
  box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
}

/* Reply Context */
.reply-context {
  padding: 8px 12px;
  background: rgba(255, 0, 85, 0.1);
  border-left: 3px solid var(--accent-color);
  font-size: 13px;
  color: #e4e6eb;
  display: none;
  justify-content: space-between;
  align-items: center;
  border-radius: 6px;
  margin-bottom: 8px;
  animation: slideDown 0.2s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.reply-context-text {
  flex: 1;
  font-weight: 500;
}

.cancel-reply-btn {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  color: #b0b3b8;
  padding: 0 4px;
  line-height: 1;
  transition: color 0.2s;
  margin-left: 8px;
}

.cancel-reply-btn:hover {
  color: #e4e6eb;
}

.cancel-reply-btn:active {
  transform: scale(0.9);
}

/* Comment Form */
#comment-form {
  display: flex;
  align-items: flex-end;
  gap: 8px;
}

.comment-input-wrapper {
  flex-grow: 1;
  position: relative;
  display: flex;
  align-items: flex-end;
  background: #242526;
  border: 1px solid #3a3b3c;
  border-radius: 18px;
  padding: 4px 4px 4px 12px;
  transition: border-color 0.2s;
}

.comment-input-wrapper:focus-within {
  border-color: var(--accent-color);
  box-shadow: 0 0 0 2px rgba(255, 0, 85, 0.1);
}

#comment-input {
  flex-grow: 1;
  border: none;
  background: transparent;
  padding: 6px 0;
  font-size: 15px;
  color: #e4e6eb;
  max-height: 120px;
  min-height: 24px;
  resize: none;
  overflow-y: auto;
  font-family: inherit;
  line-height: 1.4;
}

#comment-input:focus {
  outline: none;
}

#comment-input::placeholder {
  color: #b0b3b8;
}

/* Attachment Buttons */
.comment-attachments {
  display: flex;
  gap: 4px;
  align-items: center;
  padding: 0 4px;
}

.attachment-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #b0b3b8;
  transition: all 0.2s;
  border-radius: 50%;
}

.attachment-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #e4e6eb;
}

.attachment-btn:active {
  transform: scale(0.9);
}

.attachment-btn svg {
  width: 20px;
  height: 20px;
}

/* Submit Button */
#comment-form .submit-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--accent-color);
  transition: transform 0.1s ease;
  flex-shrink: 0;
  border-radius: 50%;
}

#comment-form .submit-btn:hover {
  background: rgba(255, 0, 85, 0.1);
}

#comment-form .submit-btn:active:not(:disabled) {
  transform: scale(0.9);
}

#comment-form .submit-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

#comment-form .submit-btn svg {
  width: 24px;
  height: 24px;
}

/* Image Preview */
.image-preview-container {
  display: none;
  padding: 8px 0;
  animation: slideDown 0.2s ease-out;
}

.image-preview-container.visible {
  display: block;
}

.image-preview {
  position: relative;
  display: inline-block;
  max-width: 150px;
  border-radius: 8px;
  overflow: hidden;
  border: 2px solid #3a3b3c;
}

.image-preview img {
  width: 100%;
  height: auto;
  display: block;
}

.remove-image-btn {
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(0, 0, 0, 0.7);
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: white;
  font-size: 16px;
  transition: background 0.2s;
}

.remove-image-btn:hover {
  background: rgba(0, 0, 0, 0.9);
}

/* Emoji Picker */
.emoji-picker {
  position: absolute;
  bottom: 100%;
  left: 0;
  margin-bottom: 8px;
  background: #242526;
  border: 1px solid #3a3b3c;
  border-radius: 12px;
  padding: 8px;
  display: none;
  flex-wrap: wrap;
  gap: 4px;
  max-width: 280px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  z-index: 20;
  animation: slideUp 0.2s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.emoji-picker.visible {
  display: flex;
}

.emoji-item {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
  transition: background 0.2s;
  line-height: 1;
}

.emoji-item:hover {
  background: rgba(255, 255, 255, 0.1);
}

.emoji-item:active {
  transform: scale(0.9);
}

/* Comments List */
.comments-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 8px 0;
}

.comment-item {
  display: flex;
  gap: 8px;
  align-items: flex-start;
  padding: 0;
  width: 100%;
}

.comment-avatar-wrapper {
  flex-shrink: 0;
}

.comment-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  flex-shrink: 0;
  object-fit: cover;
}

.comment-main {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.comment-body {
  background: #242526;
  border-radius: 18px;
  padding: 6px 10px;
}

.comment-user {
  font-weight: 600;
  font-size: 13px;
  color: #e4e6eb;
}

.comment-text {
  font-size: 14px;
  line-height: 1.3;
  color: #e4e6eb;
  margin: 0;
  white-space: pre-wrap;
  word-break: break-word;
}

/* Comment Image */
.comment-image {
  margin-top: 6px;
  max-width: 200px;
  border-radius: 8px;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.2s;
}

.comment-image img {
  width: 100%;
  height: auto;
  display: block;
}

.comment-image:hover {
  transform: scale(1.02);
}

.comment-footer {
  display: flex;
  align-items: center;
  gap: 10px;
  padding-left: 10px;
}

.comment-timestamp {
  font-size: 11px;
  color: #b0b3b8;
}

.comment-actions-wrapper {
  display: flex;
  gap: 8px;
}

.comment-action-btn,
.comment-reply-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: #b0b3b8;
  font-weight: 600;
  padding: 0;
  font-size: 11px;
  transition: color 0.2s;
}

.comment-action-btn:hover,
.comment-reply-btn:hover {
  color: #e4e6eb;
}

.comment-likes {
  display: flex;
  align-items: center;
  gap: 4px;
}

.comment-like-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  display: flex;
}

.comment-like-btn svg {
  width: 14px;
  height: 14px;
  stroke: #b0b3b8;
  stroke-width: 2;
  fill: none;
  transition: all 0.2s ease;
}

.comment-like-btn:hover svg {
  stroke: var(--accent-color);
}

.comment-like-btn.active svg {
  fill: var(--accent-color);
  stroke: var(--accent-color);
}

.comment-like-count {
  font-size: 11px;
  color: #b0b3b8;
  font-weight: 500;
}

/* Comment Threads */
.comment-thread {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.comment-replies {
  padding-left: 40px;
  display: none;
  flex-direction: column;
  gap: 12px;
  margin-top: 8px;
}

.comment-replies.visible {
  display: flex;
}

.toggle-replies-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: #b0b3b8;
  font-weight: 600;
  padding: 2px 10px;
  font-size: 11px;
  transition: color 0.2s;
  display: flex;
  align-items: center;
  gap: 4px;
}

.toggle-replies-btn:hover {
  color: #e4e6eb;
}

.toggle-replies-btn .arrow {
  border: solid #b0b3b8;
  border-width: 0 2px 2px 0;
  display: inline-block;
  padding: 2px;
  transform: rotate(45deg);
  transition: transform 0.2s, border-color 0.2s;
}

.toggle-replies-btn:hover .arrow {
  border-color: #e4e6eb;
}

.toggle-replies-btn.expanded .arrow {
  transform: rotate(-135deg);
}

/* Sort Options */
.comment-sort-options {
position: absolute;
left: auto;
/* ZMIANA 5: Pozycja startowa = (szerokość X: 40px) + (Twój margines: 3px) */
right: 43px;
top: 50%;
transform: translateY(-50%);
z-index: 10;
padding-right: 3px;
}

.sort-dropdown {
  position: relative;
}

.sort-trigger {
background: none;
border: none;
color: #b0b3b8;
font-size: 13px;
font-weight: 600;
cursor: pointer;
/* ZMIANA 6: Usunięcie zbędnego prawego paddingu */
padding: 4px 0 4px 8px;
}

.sort-trigger .current-sort {
  color: #e4e6eb;
}

.sort-options {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  background: #242526;
  border: 1px solid #3a3b3c;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  padding: 4px;
  margin-top: 4px;
  width: 160px;
  z-index: 20;
}

.sort-dropdown.open .sort-options {
  display: block;
}

.sort-option {
  background: none;
  border: none;
  width: 100%;
  padding: 8px 12px;
  text-align: left;
  font-size: 14px;
  cursor: pointer;
  border-radius: 4px;
  color: #e4e6eb;
}

.sort-option:hover {
  background-color: #3a3b3c;
}

.sort-option.active {
  font-weight: 600;
  color: var(--accent-color);
}

/* No Comments Message */
.no-comments-message {
  text-align: center;
  padding: 60px 20px;
  color: #65676b;
  font-weight: 500;
}

/* Login Prompt */
.login-to-comment-prompt {
  align-items: center;
  background-color: #18191a;
  display: flex;
  justify-content: center;
  padding: 8px 12px;
  text-align: center;
}

.login-to-comment-prompt p {
  margin: 0;
  font-size: 15px;
  color: #e4e6eb;
}

.login-to-comment-prompt a {
  color: var(--accent-color);
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
}

/* Loading Spinner */
#comments-modal-container .modal-body .loading-spinner {
  display: block;
  margin: 60px auto;
  border-color: rgba(0, 0, 0, 0.2);
  border-top-color: var(--accent-color);
}

/* Image Lightbox */
.image-lightbox {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  z-index: 10100;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.image-lightbox.visible {
  display: flex;
}

.image-lightbox img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  border-radius: 8px;
}

.image-lightbox-close {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(0, 0, 0, 0.7);
  border: none;
  color: white;
  font-size: 32px;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}

.image-lightbox-close:hover {
  background: rgba(0, 0, 0, 0.9);
}

/* Hidden File Input */
.comment-image-input {
  display: none;
}

/* ============================================================================
   --- NOWE: TRYB PEŁNEGO EKRANU (IMMERSYJNY) ---
   ============================================================================ */

/* Dodajemy płynne przejścia do animowanych elementów */
.tiktok-symulacja .bottombar,
.tiktok-symulacja .video-controls {
    transition: transform 0.3s ease-out, bottom 0.3s ease-out;
}

/* KROK 1: Całkowicie schowaj dolny pasek, gdy tryb immersyjny jest aktywny */
#app-frame.hide-ui .bottombar {
    transform: translateY(100%);
}

/* KROK 2: Przesuń kontrolki wideo na sam dół ekranu */
#app-frame.hide-ui .video-controls {
    bottom: calc(8px + var(--safe-area-bottom));
}

/* KROK 3: Sidebar nie jest już ukrywany. Pozostaje widoczny. */
/* Celowo usunięto regułę dla #app-frame.hide-ui .sidebar */

/* ✅ NOWE: Wyśrodkuj sidebar w pionie, gdy dolny pasek jest ukryty */
#app-frame.hide-ui .sidebar {
    top: calc((var(--app-height) - var(--topbar-height)) / 2 + var(--topbar-height));
}

/* ✅ NOWE: Aktywuj ikonę CC w trybie immersyjnym (bez zmiany tła) */
#app-frame.hide-ui .cc-button {
    opacity: 1;
    cursor: pointer;
}

#app-frame.hide-ui .cc-button:hover {
    transform: scale(1.1); /* Lekkie powiększenie dla feedbacku */
    background-color: rgba(0, 0, 0, 0.7); /* Delikatne przyciemnienie tła */
}

/* ✅ NOWE: Wyśrodkuj nakładki pauzy i powtórzenia w trybie immersyjnym */
.pause-overlay, .replay-overlay {
    transition: top 0.3s ease-out, height 0.3s ease-out, opacity 0.2s ease-in-out;
}

#app-frame.hide-ui .pause-overlay,
#app-frame.hide-ui .replay-overlay {
    top: var(--topbar-height);
    height: calc(100% - var(--topbar-height));
}

/* NOWE: Wizualne wyłączenie przycisku immersji w trybie przeglądarki */
@media not all and (display-mode: standalone) {
  .fullscreen-button {
    opacity: 0.5;
    cursor: not-allowed;
  }
}

/* NOWE: Domyślnie ukryj ikonę wyjścia z trybu immersyjnego */
.fullscreen-exit-icon {
  display: none;
}

/* ============================================================================
   ELEGANT MODAL STYLES (for Tipping, etc.)
   ============================================================================ */

.elegant-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: flex !important;
  align-items: center;
  justify-content: center;
  z-index: 10200;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.4s ease, visibility 0.4s ease !important;
  overflow: hidden;
}

#tippingModal, #infoModal {
    display: flex;
    align-items: center;
    justify-content: center;
}

.elegant-modal-overlay.visible {
  opacity: 1;
  visibility: visible;
}

.elegant-modal-content {
  background: linear-gradient(180deg, #28282a 0%, #1c1c1e 100%);
  color: #f0f0f0;
  border-radius: 20px;
  width: 90%;
  max-width: 420px;
  max-height: 85vh; /* Dodano maksymalną wysokość */
  display: flex;
  flex-direction: column;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
  transform: scale(0.95) translateY(10px);
  opacity: 0;
  transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s ease;
}

.elegant-modal-overlay.visible .elegant-modal-content {
    transform: scale(1) translateY(0);
    opacity: 1;
}


.elegant-modal-content-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    padding: 20px;
    box-sizing: border-box;
}

.elegant-modal-header {
  padding: 20px 24px 16px;
  text-align: center;
  flex-shrink: 0;
  position: relative; /* Needed for the close button */
}

.elegant-modal-header .modal-close-btn {
    color: #fff; /* Light color for the 'x' */
}

.elegant-modal-title {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 8px;
}

.elegant-modal-progress-bar-container {
  height: 5px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 2.5px;
  overflow: hidden;
}

.elegant-modal-progress-bar-fill {
  height: 100%;
  width: 33.33%;
  background: var(--accent-color);
  border-radius: 2.5px;
  transition: width 0.5s ease-in-out;
}

.elegant-modal-body {
  padding: 0 24px 20px;
  overflow-y: auto; /* Włączono przewijanie */
  flex-grow: 1;
}

.elegant-modal-step {
  display: none;
  animation: elegantFadeIn 0.6s ease-out;
}

@keyframes elegantFadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}


.elegant-modal-step.active {
  display: block;
  animation: elegantFadeIn 0.6s ease-out;
}

@keyframes elegantFadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.elegant-modal-step-description {
  color: #b0b3b8;
  font-size: 15px;
  line-height: 1.5;
  margin-bottom: 12px;
  text-align: center;
}

.elegant-modal-fields-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.elegant-modal-input {
  background: rgba(0, 0, 0, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.15);
  padding: 14px 16px;
  border-radius: 10px;
  color: #fff;
  font-size: 16px;
  transition: all 0.2s ease;
  width: 100%;
}

.elegant-modal-input:focus {
  outline: none;
  border-color: var(--accent-color);
  background: rgba(0, 0, 0, 0.3);
  box-shadow: 0 0 0 2px rgba(255, 0, 85, 0.2);
}

.elegant-modal-input::placeholder {
  color: #8e8e93;
}

.elegant-modal-preference-row {
  display: flex;
  align-items: center;
  gap: 12px;
  background: rgba(255, 255, 255, 0.05);
  padding: 14px 16px;
  border-radius: 10px;
  cursor: pointer;
  border: 1px solid transparent;
  transition: background-color 0.2s, border-color 0.2s;
  flex-direction: row-reverse;
  justify-content: flex-end;
}

.elegant-modal-preference-row:hover {
  background-color: rgba(255, 255, 255, 0.08);
  border-color: rgba(255, 255, 255, 0.1);
}

.elegant-modal-preference-label {
  color: #f0f0f0;
  font-size: 15px;
  font-weight: 500;
}

.elegant-modal-checkbox {
  transform: scale(1.3);
  accent-color: var(--accent-color);
  background-color: #333;
  border: 1px solid #555;
  border-radius: 4px;
}

.elegant-modal-email-container {
    transition: all 0.4s ease-in-out;
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    margin-top: 0;
}

.elegant-modal-email-container.visible {
    opacity: 1;
    max-height: 150px; /* Zwiększono, aby pomieścić dłuższy hint */
    margin-top: 8px; /* small gap */
}

.elegant-modal-hint-text {
  font-size: 12px;
  color: #888;
  text-align: center;
  margin-top: 8px;
}

.tipping-amount-container .amount-input {
    flex-grow: 1;
    background: transparent;
    border: none;
    color: white;
    font-size: 24px;
    font-weight: 600;
    padding: 12px 16px;
    text-align: center;
    -moz-appearance: textfield; /* Firefox */
}

.tipping-amount-container .amount-input::-webkit-outer-spin-button,
.tipping-amount-container .amount-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.tipping-currency {
    font-size: 20px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.5);
    padding-right: 20px;
}

.elegant-modal-footer {
  padding: 16px 24px;
  padding-bottom: calc(20px + var(--safe-area-bottom));
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.elegant-modal-footer-buttons {
  display: flex;
  gap: 12px;
}

.elegant-modal-btn {
  flex: 1;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.elegant-modal-btn:active {
  transform: scale(0.97);
}

.elegant-modal-btn-prev {
    background: transparent;
    color: #a0a0a0;
    flex: 0 1 30%; /* Take up less space */
    font-size: 14px;
    box-shadow: none;
    border: 1px solid #4a4a4c;
}

.elegant-modal-btn-next,
.elegant-modal-btn-submit {
    color: #fff;
    box-shadow: 0 4px 15px rgba(255, 0, 85, 0.25);
    flex: 1; /* Make the main action button take more space */
}

.elegant-modal-btn-next {
    background: var(--accent-color);
}

.elegant-modal-btn-submit {
  background: #34c759; /* Green for payment */
  display: none; /* Hidden by default */
  box-shadow: 0 4px 15px rgba(52, 199, 89, 0.25);
}

.elegant-modal-btn:hover {
    filter: brightness(1.1);
}

/* ============================================================================
   ELEGANT MODAL STYLES (for Tipping, etc.) - ENHANCED UX/UI
   ============================================================================ */

/* ... (istniejące style .elegant-modal-overlay) ... */

.elegant-modal-content {
    /* ... (istniejące style) ... */
    /* NEW: Add subtle texture and depth */
    background: linear-gradient(175deg, #2D2D2F 0%, #1E1E20 100%);
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.08);
}

/* ... (istniejące style .elegant-modal-header) ... */

.elegant-modal-progress-bar-fill {
    /* ... (istniejące style) ... */
    /* NEW: Add a subtle glow and gradient */
    background: linear-gradient(90deg, var(--accent-color), #ff4081);
    box-shadow: 0 0 10px rgba(255, 0, 85, 0.5);
}

.elegant-modal-step.active {
    animation: elegantFadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1); /* Smoother animation */
}

@keyframes elegantFadeIn {
  from { opacity: 0; transform: translateY(12px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

/* ... (istniejące style .elegant-modal-step-description) ... */

.elegant-modal-input {
    /* ... (istniejące style) ... */
    /* NEW: Enhanced focus state */
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

/* NEW: Amount Suggestions */
.tipping-amount-suggestions {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.amount-suggestion-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #f0f0f0;
    padding: 14px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.amount-suggestion-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
}

.amount-suggestion-btn.active {
    background: var(--accent-color);
    color: #fff;
    border-color: var(--accent-color);
    box-shadow: 0 0 15px rgba(255, 0, 85, 0.4);
    transform: translateY(-2px) scale(1.02);
}

/* NEW: Enhanced Amount Input */
.tipping-amount-container {
    background-color: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
}

.tipping-amount-container:focus-within {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(255, 0, 85, 0.2);
}

#tippingAmount {
    font-size: 26px; /* Slightly larger */
    font-weight: 700;
}

.elegant-modal-btn {
    /* ... (istniejące style) ... */
    /* NEW: Enhanced button styles */
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.elegant-modal-btn:active {
    transform: scale(0.96);
}

.elegant-modal-btn-next,
.elegant-modal-btn-submit {
    /* NEW: Add gradient and subtle shadow */
    background: linear-gradient(90deg, var(--accent-color), #e6004d);
}

.elegant-modal-btn-submit {
    background: linear-gradient(90deg, #34c759, #28a745);
    box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3);
}

.elegant-modal-btn:hover {
    filter: brightness(1.15);
    transform: translateY(-2px);
}


.profile-header {
  height: var(--topbar-height);
  display: grid;
  grid-template-columns: 60px 1fr 60px;
  align-items: center;
  padding: 0;
  padding-top: var(--safe-area-top);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  flex-shrink: 0;
}

.profile-header .username-header {
  font-size: 16px;
  font-weight: 700;
  text-align: center;
  grid-column: 2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.profile-header .modal-close-btn,
.profile-header .options-btn {
  background: none;
  border: none;
  color: #fff;
  cursor: pointer;
  padding: 0;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition:
    transform 0.1s ease-in-out,
    opacity 0.2s;
}

.profile-header .modal-close-btn {
  grid-column: 1;
  justify-self: start;
  margin-left: 10px;
}
.profile-header .options-btn {
  grid-column: 3;
  justify-self: end;
  margin-right: 10px;
}

.profile-header .back-btn:active,
.profile-header .options-btn:active {
  transform: scale(0.9);
}

.profile-header .back-btn {
    font-size: 28px;
    font-weight: 300;
}

.profile-header .options-btn svg {
  width: 24px;
  height: 24px;
  fill: currentColor;
}

main {
  flex-grow: 1;
  overflow-y: auto;
  padding: 20px 16px;
}

main::-webkit-scrollbar {
  display: none;
}

.info-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  margin-bottom: 16px;
}

.avatar-container .profile-avatar {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid rgba(255, 255, 255, 0.1);
}

.stats-container {
  display: flex;
  justify-content: space-around;
  gap: 20px;
  width: 100%;
}

.stats-container .stat {
  text-align: center;
}

.stats-container .stat-number {
  font-size: 18px;
  font-weight: 700;
  display: block;
}

.stats-container .stat-label {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.6);
}

.fullname {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 4px;
  text-align: center;
}

.bio {
  font-size: 14px;
  line-height: 1.5;
  color: rgba(255, 255, 255, 0.8);
  margin-bottom: 16px;
  white-space: pre-wrap;
  text-align: center;
}

.profile-actions {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  justify-content: center;
}

.profile-actions .follow-btn {
  flex-grow: 1;
  max-width: 200px;
  background-color: var(--accent-color);
  color: #fff;
  border: none;
  border-radius: 4px;
  padding: 12px;
  font-weight: 600;
  font-size: 16px;
  cursor: pointer;
}

.profile-actions .social-btn {
  padding: 10px;
  background-color: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
}
.profile-actions .social-btn svg {
  width: 24px;
  height: 24px;
  fill: #fff;
  stroke: none;
}
.profile-actions .social-btn.instagram svg {
    stroke: #fff;
    stroke-width: 2px;
    fill: none;
}
.profile-actions .social-btn.youtube svg {
    fill: #fff;
    stroke: none;
}


.tabs {
  display: flex;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.tabs .tab {
  flex: 1;
  padding: 14px;
  text-align: center;
  cursor: pointer;
  position: relative;
  color: rgba(255, 255, 255, 0.6);
}

.tabs .tab.active {
  color: #fff;
}

.tabs .tab.active::after {
  content: "";
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 100%;
  height: 2px;
  background-color: #fff;
}

.tabs .tab svg {
  width: 28px;
  height: 28px;
  fill: currentColor;
}
.tabs .tab[data-tab-content="liked-grid"] svg {
    stroke: currentColor;
    stroke-width: 2px;
    fill: none;
}
.tabs .tab[data-tab-content="reposts-grid"] svg {
    fill: none;
    stroke: currentColor;
    stroke-width: 2px;
}

#author-profile-modal .profile-tabs {
  display: flex;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

#author-profile-modal .profile-tab {
  flex: 1;
  padding: 14px;
  text-align: center;
  cursor: pointer;
  position: relative;
  color: rgba(255, 255, 255, 0.6);
  background: none;
  border: none;
}

.profile-tab.active {
  color: #fff;
}

.profile-tab.active::after {
  content: "";
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 100%;
  height: 2px;
  background-color: #fff;
}

.profile-tab svg {
  width: 28px;
  height: 28px;
  fill: currentColor;
}
.profile-tab[data-tab="liked-grid"] svg {
    stroke: currentColor;
    stroke-width: 2px;
    fill: none;
}
.profile-tab[data-tab="reposts-grid"] svg {
    fill: none;
    stroke: currentColor;
    stroke-width: 2px;
}

.profile-tab-content {
  padding-top: 2px;
}


.video-gallery {
  display: none;
  grid-template-columns: repeat(3, 1fr);
  gap: 2px;
  padding-top: 2px;
}

.video-gallery.active {
  display: grid;
}

.video-thumbnail {
  position: relative;
  padding-bottom: 140%;
  background-color: #333;
}

.video-thumbnail img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.video-views {
  position: absolute;
  bottom: 8px;
  left: 8px;
  color: white;
  font-size: 13px;
  font-weight: 600;
  display: flex;
  align-items: center;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
}

.video-views svg {
  width: 16px;
  height: 16px;
  margin-right: 4px;
  fill: white;
}

#terms-step .terms-content {
    background: rgba(0,0,0,0.2);
    border-radius: 8px;
    padding: 15px;
    border: 1px solid rgba(255,255,255,0.1);
}

#terms-step .terms-content p {
    margin-bottom: 10px;
}

#payment-element {
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
}

#payment-element.ready {
    opacity: 1;
}


/* Custom UI Adjustments requested */

/* Info Modal: Header adjustments */
#infoModal .crowdfunding-title {
    font-size: 22px; /* Make header smaller */
    margin-top: -8px;  /* Move header closer to the top */
    margin-bottom: 4px;
}

/* Info Modal: Style for the premiere date */
#infoModal .premiere-date-value {
    color: #FFFFFF;
    font-weight: 700;
    font-size: 22px;
}

/* Tipping Modal: Style for currency dropdown indicator */
.tipping-currency-wrapper .currency-dropdown-arrow {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: #aaa;
    font-size: 14px;
}

/* Make sure the select has padding to not overlap with the new arrow */
.tipping-currency-wrapper .tipping-currency-select {
    padding-right: 30px !important;
}

/* Hide the old pseudo-element to avoid duplicate arrows */
.tipping-currency-wrapper::after {
    content: none !important;
}

/* Info Modal: Adjust CTA button to better fit the icon */
#infoModal .cta-button {
    gap: 10px;
}

#infoModal .cta-button svg {
    width: 32px;
    height: 32px;
    fill: none;
    stroke: #fff;
    stroke-width: 1.5;
}

/* Modal Transition Animations */
@keyframes slideOutLeft {
    from {
        transform: translateX(0);
    }
    to {
        transform: translateX(-100%);
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
    }
    to {
        transform: translateX(100%);
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
    }
    to {
        transform: translateX(0);
    }
}

#video-player-modal {
    z-index: 10400 !important;
    background-color: #000;
}

#video-player-modal video {
    width: 100%;
    height: 100%;
}

#video-player-modal .modal-close-btn {
    color: #fff;
}

/* ============================================================================
   --- PWA DESKTOP MINI MODAL ---
   ============================================================================ */

.pwa-desktop-mini-modal .modal-content {
    background: #ffffff;
    color: #333;
    border-radius: 16px;
    width: 90%;
    max-width: 320px;
    padding: 24px 20px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e5e5;
    animation: fadeIn 0.3s ease forwards;
}

.pwa-desktop-mini-modal .modal-close-btn {
  position: absolute;
  top: 10px;
  right: 14px;
  background: transparent;
  border: none;
  color: #888;
  font-size: 26px;
  opacity: 0.7;
  cursor: pointer;
  transition: opacity 0.2s ease;
}
.pwa-desktop-mini-modal .modal-close-btn:hover {
  opacity: 1;
}

.phone-icon {
    width: 40px;
    height: 40px;
    color: #ff3366;
    margin-bottom: 10px;
}

.pwa-mini-modal-text {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 6px;
    color: #222;
}

.pwa-mini-modal-subtitle {
    font-size: 13px;
    color: #555;
    margin-bottom: 0;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* New styles for tipping summary */
.elegant-modal-step-header {
    display: flex;
    flex-direction: column;
    align-items: center; /* Center the description by default */
    width: 100%;
    margin-bottom: 16px; /* A bit more space for the whole block */
    gap: 4px;
}

.elegant-modal-step-header .elegant-modal-step-description {
    margin-bottom: 0;
    text-align: center;
    width: 100%;
    order: 2;
    font-size: 14px; /* Make it slightly smaller to give prominence to amount */
    color: #999;
}

.tipping-summary-amount {
    font-size: 14px;
    font-weight: 600;
    color: #f0f0f0;
    background-color: rgba(255, 255, 255, 0.1);
    padding: 6px 12px;
    border-radius: 8px;
    white-space: nowrap;
    order: 1;
    align-self: center; /* Align this specific item to the center */
    margin-right: 0; /* Remove margin */
    margin-bottom: 0; /* Remove bottom margin, rely on gap */
}

/* --- Nowe klasy dla FIX: Wysokość modala --- */
.elegant-modal-content.fixed-height-transition {
    transition: height 0.3s ease-out;
}

.elegant-modal-content.force-fixed-height {
    height: var(--tipping-fixed-height, auto);
    overflow: hidden;
}

@keyframes cloud-wave {
  0% {
    box-shadow: 0 0 60px 20px rgba(255, 255, 255, 0.7), 0 0 100px 40px rgba(200, 200, 220, 0.5);
  }
  50% {
    box-shadow: 0 0 70px 25px rgba(255, 255, 255, 0.75), 0 0 110px 45px rgba(200, 200, 220, 0.55);
  }
  100% {
    box-shadow: 0 0 60px 20px rgba(255, 255, 255, 0.7), 0 0 100px 40px rgba(200, 200, 220, 0.5);
  }
}

/* ============================================================================
   --- AUTHOR PROFILE MODAL STYLES ---
   ============================================================================ */

.profile-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  z-index: 10300; /* Above other modals */
  opacity: 0;
  visibility: hidden;
  /* transition: opacity 0.4s ease, visibility 0.4s ease; */ /* This was incorrect */
  overflow: hidden;
}

.profile-modal-overlay.visible {
  opacity: 1;
  visibility: visible;
}

.profile-modal-content {
  position: absolute;
  top: 0;
  right: 0;
  width: 100%;
  height: 100%;
  background: rgba(20, 20, 20, 0.85);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  color: #fff;
  display: flex;
  flex-direction: column;
  transform: translateX(100%);
  transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  will-change: transform;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.profile-modal-overlay.visible .profile-modal-content {
  transform: translateX(0);
}

.profile-modal-overlay.is-hiding .profile-modal-content {
  transform: translateX(100%);
}

#author-profile-modal .profile-header {
    height: var(--topbar-height);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    padding-top: var(--safe-area-top);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    flex-shrink: 0;
    position: relative;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
}

#author-profile-modal .username-header {
    font-size: 16px;
    font-weight: 700;
    text-align: center;
    grid-column: 2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #fff;
}

#author-profile-modal .modal-close-btn {
    position: absolute;
    top: var(--safe-area-top);
    right: 4px;
    height: var(--topbar-base-height);
    width: 40px;
    background: none;
    border: none;
    color: #fff;
    font-size: 24px;
    font-weight: 400;
    line-height: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    z-index: 10;
}

#author-profile-modal .options-btn {
    grid-column: 3;
    justify-self: end;
    margin-right: 10px;
}

#author-profile-modal main {
    flex-grow: 1;
    overflow-y: visible;
    padding: 20px 16px;
    background-color: #e1e1e1;
    color: #333;
}

.author-modal-avatar {
  position: relative;
  padding: 0;
  background-clip: padding-box !important;
  animation: flicker-glow 4s infinite;
  transition: border-color 0.1s ease-in-out, filter 0.2s;
  background-color: white;
}

#author-profile-modal main::-webkit-scrollbar {
    display: none;
}

#author-profile-modal .info-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
}

#author-profile-modal .avatar-container {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    overflow: hidden;
    position: relative;
    background-color: white;
    border: 2px solid white;
}

#author-profile-modal .avatar-container .profile-avatar {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
}

#author-profile-modal .info-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
}

#author-profile-modal .stats-container {
    display: flex;
    justify-content: space-around;
    gap: 20px;
    width: 100%;
    margin: 24px 0;
}

#author-profile-modal .stats-container .stat {
    text-align: center;
}

#author-profile-modal .stats-container .stat-number {
    font-size: 14px;
    font-weight: 700;
    display: block;
}

#author-profile-modal .stats-container .stat-label {
    font-size: 12px;
    color: #555;
}

#author-profile-modal .fullname {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 4px;
    text-align: center;
    color: #111;
}

#author-profile-modal .bio {
    font-size: 14px;
    line-height: 1.5;
    color: #333;
    margin-bottom: 16px;
    white-space: pre-wrap;
    text-align: center;
}

#author-profile-modal .profile-actions {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    justify-content: center;
}

#author-profile-modal .profile-actions .follow-btn {
    flex-grow: 1;
    max-width: 200px;
    background-color: var(--accent-color);
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 12px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

#author-profile-modal .profile-actions .follow-btn svg {
    width: 32px;
    height: 32px;
    fill: none;
    stroke: #fff;
    stroke-width: 1.5;
}

#author-profile-modal .profile-actions .social-btn {
    padding: 10px;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
}

#author-profile-modal .profile-actions .social-btn svg {
    width: 24px;
    height: 24px;
    fill: #fff;
    stroke: none;
}

#author-profile-modal .profile-actions .social-btn.instagram svg {
    stroke: #fff;
    stroke-width: 2px;
    fill: none;
}

#author-profile-modal .tabs {
    display: flex;
    border-bottom: 1px solid #ddd;
}

#author-profile-modal .tabs .tab {
    flex: 1;
    padding: 14px;
    text-align: center;
    cursor: pointer;
    position: relative;
    color: #555;
}

#author-profile-modal .tabs .tab.active {
    color: #111;
}

#author-profile-modal .tabs .tab.active::after {
    content: "";
    position: absolute;
    bottom: -1px;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: #fff;
}

#author-profile-modal .tabs .tab svg {
    width: 28px;
    height: 28px;
    fill: currentColor;
}
#author-profile-modal .tabs .tab[data-tab-content="liked-grid"] svg {
    stroke: currentColor;
    stroke-width: 2px;
    fill: none;
}
#author-profile-modal .tabs .tab[data-tab-content="reposts-grid"] svg {
    fill: none;
    stroke: currentColor;
    stroke-width: 2px;
}

#author-profile-modal .video-gallery {
    display: none;
    grid-template-columns: repeat(3, 1fr);
    gap: 2px;
    padding-top: 2px;
}

#author-profile-modal .video-gallery.active {
    display: grid;
}

#author-profile-modal .video-thumbnail {
    position: relative;
    padding-bottom: 140%;
    background-color: #333;
}

#author-profile-modal .video-thumbnail img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

#author-profile-modal .video-views {
    position: absolute;
    bottom: 4px;
    left: 4px;
    color: white;
    font-size: 13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
}

#author-profile-modal .video-views svg {
    width: 16px;
    height: 16px;
    margin-right: 4px;
    fill: white;
}

/* Nowe style dla nakładki na miniatury w profilu autora */
.thumbnail-overlay-block {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
}

#author-profile-modal .video-thumbnail.locked-thumbnail .thumbnail-overlay-block {
    opacity: 1;
}

.thumbnail-overlay-block .lock-icon {
    width: 35%;
    height: 35%;
    opacity: 0.9;
}

.thumbnail-overlay-block .badge {
    position: absolute;
    bottom: 4px;
    right: 4px;
    background: rgba(0, 0, 0, 0.6);
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.thumbnail-overlay-block .badge svg {
    width: 16px;
    height: 16px;
}

.modal-content.slideOutLeft, .elegant-modal-content.slideOutLeft {
    animation: slideOutLeft 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
}

.modal-content.slideInRight, .elegant-modal-content.slideInRight, .profile-modal-content.slideInRight {
    animation: slideInRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
}


.modal-content.slideOutLeft, .elegant-modal-content.slideOutLeft {
    animation: slideOutLeft 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
}


/* Modal Transition Animations */
@keyframes slideOutLeft {
    from {
        transform: translateX(0);
    }
    to {
        transform: translateX(-100%);
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
    }
    to {
        transform: translateX(100%);
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
    }
    to {
        transform: translateX(0);
    }
}

#tiktok-profile-modal .tiktok-profile-content {
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    will-change: transform;
}

#tiktok-profile-modal.visible .profile-content {
    opacity: 1;
    transform: translateX(0);
    transition: none;
}

#app-frame[style*="pointer-events: none"] {
/* Opcjonalnie: wizualna informacja, że tło jest zablokowane */
filter: blur(5px);
transition: filter 0.3s ease;
pointer-events: none; /* Domyślna obsługa przez JS */
}

/* Wymuszony modal musi być widoczny */
#firstLoginModal.fl-modal-overlay {
/* Upewnij się, że modal jest zawsze na wierzchu, nawet z `pointer-events: none` na rodzicu */
z-index: 10021;
}


@keyframes slideInLeft {
    from {
        transform: translateX(-100%);
    }
    to {
        transform: translateX(0);
    }
}

/* ============================================================================
FIX: 1. Miniaturowy Modal Instalacji PWA (pwa-desktop-mini-modal)
============================================================================ */
#pwa-desktop-modal .modal-content {
max-width: 300px; /* Zmniejszenie maksymalnej szerokości */
width: 90%;
padding: 16px; /* Mniejszy padding */
border-radius: 12px;
}
.pwa-desktop-mini-modal .modal-close-btn {
top: 6px;
right: 10px;
font-size: 20px;
}
.phone-icon {
width: 32px; /* Mniejsza ikona */
height: 32px;
margin-bottom: 8px;
}
.pwa-mini-modal-text {
font-size: 14px; /* Mniejszy font */
font-weight: 600;
margin-bottom: 4px;
}
.pwa-mini-modal-subtitle {
font-size: 11px; /* Mniejszy font */
}


/* ============================================================================
FIX: 2. Panel Logowania (Czysta Animacja Slide In/Out - bez opacity)
============================================================================ */
.login-panel {
position: absolute;
top: var(--topbar-height);
left: 0;
width: 100%;
color: white;
z-index: 114;
border-top: none;
/* Domyślny stan - poza ekranem, ukryty i bez transition w bazowej klasie */
transform: translateY(-100%);
transition: none;
visibility: hidden;
opacity: 0; /* Utrzymaj dla klikalności */
}

.login-panel.active {
visibility: visible;
opacity: 1;
transform: translateY(0);
transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* KLUCZOWE: Tylko Transform */
}

.login-panel.login-panel--closing {
visibility: visible; /* KLUCZOWE: Utrzymaj widoczność podczas animacji wyjścia */
opacity: 1;
transform: translateY(-100%);
transition: transform 0.3s cubic-bezier(0.55, 0.085, 0.68, 0.53); /* Czysta animacja wyjścia */
pointer-events: none;
}


/* ============================================================================
FIX: 3. Author Modal - Usunięcie Transition z Hiding + Wymiary
============================================================================ */

/* Usunięcie transition przy chowaniu */
.profile-modal-overlay.is-hiding .profile-modal-content {
transform: translateX(100%);
}

/* Usunięcie transition przy chowaniu z Account Modal */
.account-modal-overlay.is-hiding .account-modal-content {
transform: translateX(-100%);
transition: none;
}

/* FIX: Author Modal - Ułożenie Nagłówka (Usunięcie ikony 3 kropek) */
#author-profile-modal .profile-header {
grid-template-columns: 1fr 40px; /* 1fr dla tytułu, 40px dla X */
}
#author-profile-modal .username-header {
grid-column: 1;
justify-self: center; /* Wyśrodkuj tytuł */
}
#author-profile-modal .modal-close-btn {
grid-column: 2; /* Przesunięcie X do prawej kolumny */
justify-self: end;
margin-right: 10px;
}
/* Ukrycie nieistniejącego już .options-btn */
.profile-header .options-btn {
display: none !important;
}


/* FIX: Author Modal - Wymiary Stats (zapobieganie poziomemu scrollowi) */
#author-profile-modal .stats-container {
gap: 10px; /* Zmniejszenie odstępów */
}
#author-profile-modal .stats-container .stat-number {
font-size: 14px; /* Zmniejszenie stat-number */
}
#author-profile-modal .stats-container .stat-label {
font-size: 10px; /* Zmniejszenie stat-label */
white-space: nowrap; /* Zapobieganie zawijaniu stat-label */
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
    }
    to {
        transform: translateX(100%);
    }
}

@keyframes elegantFadeOut {
  from {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
  to {
    opacity: 0;
    transform: scale(0.95) translateY(10px);
  }
}

@keyframes slideOutLeft {
    from {
        transform: translateX(0);
    }
    to {
        transform: translateX(-100%);
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
    }
    to {
        transform: translateX(0);
    }
}

@keyframes slideInLeft {
    from {
        transform: translateX(-100%);
    }
    to {
        transform: translateX(0);
    }
}

.no-transition {
    transition: none !important;
}

/* Custom styles for slides with a light theme, like "Elephants Dream" */

/* Avatar border and glow */
.slide--light-theme .tiktok-symulacja .profile img {
  border-color: #000 !important;
  animation: flicker-glow 2s infinite;
}

/* Text elements should be black */
.slide--light-theme .secret-overlay .secret-title,
.slide--light-theme .secret-overlay .secret-subtitle,
.slide--light-theme .tiktok-symulacja .sidebar .icon-button .icon-label,
.slide--light-theme .tiktok-symulacja .bottombar .author-name,
.slide--light-theme .tiktok-symulacja .bottombar .slide-title,
.slide--light-theme .tiktok-symulacja .bottombar .slide-description {
  color: #000 !important;
  text-shadow: none !important;
}

/* The lock icon which uses currentColor */
.slide--light-theme .secret-overlay .secret-icon {
  color: #000 !important;
}

/* For all sidebar icons on this slide, set stroke to black and keep other properties */
.slide--light-theme .tiktok-symulacja .sidebar .icon-button svg {
  stroke: #000 !important;
  fill: none !important; /* This is the default, but let's be explicit */
  stroke-width: 1.5 !important; /* Explicitly keep the same stroke-width */
}

/* Special case for the ACTIVE like button, restore original look for contrast */
.slide--light-theme .tiktok-symulacja .like-button.active > svg {
  fill: var(--accent-color) !important;
  stroke: white !important; /* White stroke looks better on red fill */
}


/* Underline for the login link */
.slide--light-theme .secret-subtitle u {
  border-bottom-color: #000 !important;
}

/* Video controls icons */
.slide--light-theme .video-controls button svg {
    fill: #000 !important;
}
import { Config } from './config.js';
import { State } from './state.js';
import { Utils } from './utils.js';
import { initInteractiveWall } from './interactive-wall.js';
// import { PWA } from './pwa.js'; // Usunięte, aby przerwać zależność cykliczną
import { API, slidesData } from './api.js';

let PWA_MODULE = null; // Zmienna przechowująca wstrzykniętą zależność
function setPwaModule(pwaModule) {
  PWA_MODULE = pwaModule;
}

function getIsUserLoggedIn() {
return State.get("isUserLoggedIn");
}

let countdownInterval = null;

function startCountdown() {
  const countdownElement = document.getElementById('countdown-timer');
  const countdownDateElement = document.getElementById('countdown-date');
  if (!countdownElement || !countdownDateElement) return;

  const endDate = new Date(countdownDateElement.textContent).getTime();

  const updateCountdown = () => {
    const now = new Date().getTime();
    const distance = endDate - now;

    if (distance < 0) {
      clearInterval(countdownInterval);
      countdownElement.textContent = "Premiera!";
      return;
    }

    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

    countdownElement.innerHTML = `
      <span class="countdown-part">${days}<span class="countdown-label-small">dni</span></span>
      <span class="countdown-part">${hours.toString().padStart(2, '0')}<span class="countdown-label-small">h</span></span>
      <span class="countdown-part">${minutes.toString().padStart(2, '0')}<span class="countdown-label-small">m</span></span>
      <span class="countdown-part">${seconds.toString().padStart(2, '0')}<span class="countdown-label-small">s</span></span>`;
  };

  if (countdownInterval) {
    clearInterval(countdownInterval);
  }
  updateCountdown();
  countdownInterval = setInterval(updateCountdown, 1000);
}

let selectedCommentImage = null;

const DOM = {};
let alertTimeout;

function initDOMCache() {
  DOM.container = document.getElementById("webyx-container");
  DOM.template = document.getElementById("slide-template");
  DOM.preloader = document.getElementById("preloader");
  DOM.alertBox = document.getElementById("alertBox");
  DOM.alertText = document.getElementById("alertText");
  DOM.commentsModal = document.getElementById("comments-modal-container");
  DOM.accountModal = document.getElementById("accountModal");
  DOM.notificationPopup = document.getElementById("notificationPopup");
  DOM.pwaDesktopModal = document.getElementById("pwa-desktop-modal");
  DOM.pwaIosInstructions = document.getElementById("pwa-ios-instructions");
  DOM.welcomeModal = document.getElementById("welcome-modal");
  DOM.infoModal = document.getElementById("infoModal");
  DOM.authorProfileModal = document.getElementById("author-profile-modal");
}

function openAuthorProfileModal(slideData, options = {}) {
    const modal = DOM.authorProfileModal;
    if (!modal) return;

    const content = modal.querySelector('.profile-modal-content');
    if (options.isLightTheme) {
        content.classList.add('profile-modal--wall-background');
    } else {
        content.classList.remove('profile-modal--wall-background');
    }

    openModal(modal, {
        onOpen: () => {
            const author = slideData.author;
            modal.querySelector('.username-header').textContent = Utils.getTranslation('authorProfileTitle');
            const avatarImg = modal.querySelector('.profile-avatar');
            avatarImg.src = author.avatar;
            avatarImg.classList.add('author-modal-avatar');
            modal.querySelector('.fullname').textContent = author.name;
            modal.querySelector('.bio').textContent = author.bio || '';

            modal.querySelector('.following-count').textContent = '123';
            modal.querySelector('.followers-count').textContent = '45.6K';
            modal.querySelector('.likes-count').textContent = '1.2M';

            const followBtn = modal.querySelector('.follow-btn');
            const btnSpan = followBtn.querySelector('span');
            const btnSvg = followBtn.querySelector('svg');

            const isLoggedIn = getIsUserLoggedIn();

            if (isLoggedIn) {
                btnSpan.textContent = 'Subsrajbujesz';
                btnSvg.innerHTML = '<path d="M26,12H20V6a3.0033,3.0033,0,0,0-3-3H14.8672a2.009,2.009,0,0,0-1.98,1.5146L11,12v9H24l2-9Z"/><path d="M9,23H5a2.0023,2.0023,0,0,1-2-2V13a2.0023,2.0023,0,0,1,2-2H9Z"/><rect id="_Transparent_Rectangle_" data-name="&lt;Transparent Rectangle&gt;" class="cls-1" width="32" height="32"/>';
                followBtn.disabled = true;
            } else {
                btnSpan.textContent = 'Zostań Patronem';
                btnSvg.innerHTML = '<rect x="2" y="7" width="20" height="12" rx="2" ry="2" /><path d="M2 10h20" /><circle cx="18" cy="13" r="2" />';
                followBtn.disabled = false;
            }

            const videosGrid = modal.querySelector('#videos-grid');
            videosGrid.innerHTML = '';

            const authorSlides = slidesData.filter(s => s.author.name === author.name && !s.isIframe);
            const otherSlides = authorSlides.filter(s => s.id !== slideData.id);
            const orderedSlides = [...otherSlides, slideData];

            const isStandalone = PWA_MODULE ? PWA_MODULE.isStandalone() : false;

            orderedSlides.forEach(authorSlide => {
                const thumbnailUrl = authorSlide.thumbnailUrl || `https://picsum.photos/200/300?random=${authorSlide.id}`;
                let overlayHtml = '';

                const isSecret = authorSlide.access === 'secret';
                const isPwaSecret = authorSlide.access === 'pwa-secret';
                const isLocked = (isSecret && !isLoggedIn) || (isPwaSecret && !isStandalone);

                if (isSecret && !isLoggedIn) {
                    overlayHtml = `
                        <div class="thumbnail-overlay-block">
                            <svg class="lock-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 00-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" /></svg>
                            <div class="badge">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2L2 9l10 13L22 9l-10-7zM2 9l10 3 10-3M12 12v10" /></svg>
                            </div>
                        </div>`;
                } else if (isPwaSecret && !isStandalone) {
                    overlayHtml = `
                        <div class="thumbnail-overlay-block">
                            <svg class="lock-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 00-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" /></svg>
                            <div class="badge">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 006 3.75v16.5a2.25 2.25 0 002.25 2.25h7.5A2.25 2.25 0 0018 20.25V3.75a2.25 2.25 0 00-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" /></svg>
                            </div>
                        </div>`;
                }

                const videoThumbnail = `
                    <div class="video-thumbnail ${isLocked ? 'locked-thumbnail' : ''}" data-video-url="${authorSlide.mp4Url}">
                        <img src="${thumbnailUrl}" alt="Video thumbnail">
                        ${overlayHtml}
                        <div class="video-views">
                            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                            <span>${Utils.formatCount(authorSlide.initialLikes)}</span>
                        </div>
                    </div>
                `;
                videosGrid.innerHTML += videoThumbnail;
            });
        }
    });
}

function closeAuthorProfileModal() {
    const modal = DOM.authorProfileModal;
    if (!modal) return;

    closeModal(modal, {
        contentSelector: '.profile-modal-content'
    });
}

function showToast(message, isError = false) {
    showAlert(message, isError);
}

function showAlert(message, isError = false) {
  if (!DOM.alertBox || !DOM.alertText) return;
  clearTimeout(alertTimeout);
  DOM.alertBox.style.animation = "none";
  requestAnimationFrame(() => {
    DOM.alertBox.style.animation = "";
    DOM.alertText.textContent = message;
    DOM.alertBox.style.backgroundColor = "rgba(0, 0, 0, 0.85)";
    DOM.alertBox.style.border = isError
      ? "1px solid var(--accent-color)"
      : "1px solid #000";
    DOM.alertBox.classList.add("visible");
  });
  alertTimeout = setTimeout(
    () => DOM.alertBox.classList.remove("visible"),
    3000,
  );
}

function getFocusable(node) {
  if (!node) return [];
  return Array.from(
    node.querySelectorAll(
      'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',
    ),
  );
}

function trapFocus(modal) {
  const focusable = getFocusable(modal);
  if (focusable.length === 0) return () => {};
  const first = focusable[0];
  const last = focusable[focusable.length - 1];
  const handleKeyDown = (e) => {
    if (e.key !== "Tab") return;
    if (e.shiftKey) {
      if (document.activeElement === first) {
        last.focus();
        e.preventDefault();
      }
    } else {
      if (document.activeElement === last) {
        first.focus();
        e.preventDefault();
      }
    }
  };
  modal.addEventListener("keydown", handleKeyDown);
  return () => modal.removeEventListener("keydown", handleKeyDown);
}

const activeModals = new Set();

function openModal(modal, options = {}) {
    if (!modal) {
        console.error("Attempted to open a null modal element.");
        return;
    }

    modal.style.display = 'flex';
    modal.classList.remove('is-hiding');
    void modal.offsetWidth;
    modal.classList.add('visible');

    const contentSelector = options.contentSelector || '.modal-content, .elegant-modal-content, .profile-modal-content, .fl-modal-content, .welcome-modal-content';
    const contentElement = modal.querySelector(contentSelector);
    if (options.animationClass && contentElement) {
        contentElement.style.animation = `${options.animationClass} 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards`;
        contentElement.addEventListener('animationend', () => {
            contentElement.style.animation = '';
        }, { once: true });
    }

    if (modal.id === 'comments-modal-container') {
        const swiper = State.get('swiper');
        if (swiper) {
            const slideId = swiper.slides[swiper.activeIndex].dataset.slideId;
            const slideData = slidesData.find(s => s.id === slideId);
            const count = slideData ? slideData.initialComments : 0;
            const titleEl = modal.querySelector('#commentsTitle');
            if (titleEl) {
                titleEl.textContent = `${Utils.getTranslation('commentsModalTitle')} (${count})`;
            }
        }
    }

    if (modal.id === 'infoModal') {
        startCountdown();
        updateCrowdfundingStats();
    }

    // Umożliwienie zamknięcia przez kliknięcie tła, jeśli to nie jest modal wymuszony
    if (!options.isPersistent) {
        const closeOnClick = (e) => {
            // Sprawdź, czy kliknięto bezpośrednio w overlay
            if (e.target === modal) {
                closeModal(modal);
            }
        };
        modal.addEventListener('click', closeOnClick);
        modal._closeOnClick = closeOnClick;
    }

    activeModals.add(modal);
    document.body.style.overflow = 'hidden';
    DOM.container.setAttribute("aria-hidden", "true");
    modal.setAttribute("aria-hidden", "false");

    // Zarządzanie focusem
    State.set("lastFocusedElement", document.activeElement);
    const focusable = getFocusable(modal);
    const focusTarget = modal.querySelector(".modal-content, .fl-modal-content, .tiktok-profile-content, .profile-content") || modal;

    if (focusable.length > 0) {
        focusable[0].focus();
    } else {
        focusTarget.focus();
    }

    modal._focusTrapDispose = trapFocus(modal);

    if (options.onOpen) options.onOpen();
    if (options.onClose) modal.onCloseCallback = options.onClose;
}

function _resetVideoPlayer(videoModal) {
    if (!videoModal) return;
    const videoPlayer = videoModal.querySelector('video');
    if (videoPlayer) {
        videoPlayer.pause();
        videoPlayer.currentTime = 0;
        videoPlayer.removeAttribute('src');
        videoPlayer.load();
    }
}

function closeModal(modal, options = {}) {
    if (!modal || !activeModals.has(modal) || modal.classList.contains('is-hiding')) return;

    modal.classList.add('is-hiding');
    modal.setAttribute('aria-hidden', 'true');

    const contentSelector = options.contentSelector || '.modal-content, .elegant-modal-content, .profile-modal-content, .fl-modal-content, .welcome-modal-content';
    const contentElement = modal.querySelector(contentSelector);

    if (options.animationClass && contentElement) {
        contentElement.style.animation = `${options.animationClass} 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards`;
    } else {
        modal.classList.remove('visible');
    }

    let cleanupHasRun = false;
    const cleanup = () => {
        if (cleanupHasRun) return;
        cleanupHasRun = true;

        if (contentElement) {
            contentElement.removeEventListener('animationend', cleanup);
            contentElement.style.animation = '';
        }
        modal.removeEventListener('transitionend', cleanup);

        modal.style.display = 'none';
        modal.classList.remove('is-hiding', 'visible');

        if (modal._focusTrapDispose) {
            modal._focusTrapDispose();
            delete modal._focusTrapDispose;
        }

        activeModals.delete(modal);

        if (activeModals.size === 0) {
            document.body.style.overflow = '';
            DOM.container.removeAttribute('aria-hidden');
        }

        const lastFocused = State.get("lastFocusedElement");
        if (lastFocused && document.body.contains(lastFocused)) {
            lastFocused.focus();
        }

        if (typeof modal.onCloseCallback === 'function') {
            modal.onCloseCallback();
            delete modal.onCloseCallback;
        }
    };

    modal.addEventListener('transitionend', cleanup, { once: true });
    modal.addEventListener('animationend', cleanup, { once: true });

    setTimeout(cleanup, 500); // Fallback
}

function updateLikeButtonState(likeButton, liked, count) {
  if (!likeButton) return;
  const likeCountEl = likeButton.querySelector(".like-count");
  likeButton.classList.toggle("active", liked);
  likeButton.setAttribute("aria-pressed", String(liked));
  if (likeCountEl) {
    likeCountEl.textContent = Utils.formatCount(count);
    likeCountEl.dataset.rawCount = String(count);
  }
  const translationKey = liked
    ? "unlikeAriaLabelWithCount"
    : "likeAriaLabelWithCount";
  const label = Utils.getTranslation(translationKey).replace(
    "{count}",
    Utils.formatCount(count),
  );
  likeButton.setAttribute("aria-label", label);
}

function applyLikeStateToDom(likeId, liked, count) {
  document
    .querySelectorAll(`.like-button[data-like-id="${likeId}"]`)
    .forEach((btn) => updateLikeButtonState(btn, liked, count));
}

/**
 * Sprawdza czy dla danego slajdu jest aktywna nakładka blokująca
 */
function isSlideOverlayActive(slideElement) {
  if (!slideElement) return false;

  const secretOverlay = slideElement.querySelector('.secret-overlay');
  const pwaSecretOverlay = slideElement.querySelector('.pwa-secret-overlay');

  const isSecretVisible = secretOverlay && secretOverlay.classList.contains('visible');
  const isPwaSecretVisible = pwaSecretOverlay && pwaSecretOverlay.classList.contains('visible');

  return isSecretVisible || isPwaSecretVisible;
}

function updateUIForLoginState() {
  UI.updateCommentFormVisibility();
  const isLoggedIn = State.get("isUserLoggedIn");
  const currentSlideIndex = State.get("currentSlideIndex");

  // Update global UI elements
  const topbar = document.querySelector("#app-frame > .topbar");
  const loginPanel = document.querySelector("#app-frame > .login-panel");
  const loggedInMenu = document.querySelector(
    "#app-frame > .logged-in-menu",
  );

  if (topbar) {
    topbar
      .querySelector(".central-text-wrapper")
      .classList.toggle("with-arrow", !isLoggedIn);
    topbar.querySelector(".topbar-text").textContent = isLoggedIn
      ? "Ting Tong"
      : Utils.getTranslation("loggedOutText");
    topbar.classList.remove("login-panel-active");
  }
  if (loginPanel) {
    loginPanel.classList.remove("active");
  }
  if (loggedInMenu) {
    loggedInMenu.classList.remove("active");
  }

  // Update per-slide elements
  DOM.container.querySelectorAll(".webyx-section").forEach((section) => {
    const sim = section.querySelector(".tiktok-symulacja");
    sim.classList.toggle("is-logged-in", isLoggedIn);

    const isSecret = sim.dataset.access === "secret";
    const isPwaSecret = sim.dataset.access === "pwa-secret";
    const isStandalone = PWA_MODULE ? PWA_MODULE.isStandalone() : false;
    const video = section.querySelector("video");

    // Determine overlay visibility
    const slideId = sim.closest('.webyx-section')?.dataset.slideId;
    const showSecret = isSecret && !isLoggedIn;
    const showPwaSecret = isPwaSecret && !isStandalone;
    const showInteractiveWall = isSecret && isLoggedIn && slideId === 'slide-002';

    // If an overlay is active, force the UI to be visible
    if (showSecret || showPwaSecret || showInteractiveWall) {
      sim.classList.add("video-loaded");
    }

    // Toggle "secret" overlay (static wall for guests)
    const secretOverlay = section.querySelector(".secret-overlay");
    if (secretOverlay) {
        secretOverlay.classList.toggle('visible', showSecret);
        if (showSecret) {
            secretOverlay.querySelector(".secret-title").textContent = Utils.getTranslation("secretTitle");
            const subtitleUElement = secretOverlay.querySelector(".secret-subtitle u");
            const subtitleSpanElement = secretOverlay.querySelector(".secret-subtitle span");
            if (subtitleUElement && subtitleSpanElement) {
                subtitleUElement.dataset.action = "toggle-login-panel";
                subtitleUElement.textContent = Utils.getTranslation("secretSubtitleAction");
                subtitleSpanElement.textContent = " " + Utils.getTranslation("secretSubtitleRest");
            }
        }
    }

    // Toggle "interactive-wall" overlay (canvas for logged-in users)
    const interactiveOverlay = section.querySelector(".interactive-wall-overlay");
    const interactiveCanvas = section.querySelector(".interactive-canvas");
    if (interactiveOverlay) {
        interactiveOverlay.classList.toggle('visible', showInteractiveWall);

        if (showInteractiveWall && interactiveCanvas && !interactiveCanvas.dataset.initialized) {
            initInteractiveWall(interactiveCanvas, section.dataset.slideId);
            interactiveCanvas.dataset.initialized = 'true';
        }
    }

    // Toggle "pwa-secret" overlay
    const pwaSecretOverlay = section.querySelector(".pwa-secret-overlay");
    if (pwaSecretOverlay) {
        pwaSecretOverlay.classList.toggle("visible", showPwaSecret);
        if (showPwaSecret) {
            pwaSecretOverlay.querySelector(".pwa-secret-title").textContent = Utils.getTranslation("pwaTitle");
            const subtitleUElement = pwaSecretOverlay.querySelector(".pwa-secret-subtitle u");
            const subtitleSpanElement = pwaSecretOverlay.querySelector(".pwa-secret-subtitle span");
            if (subtitleUElement && subtitleSpanElement) {
                subtitleUElement.textContent = Utils.getTranslation("pwaSecretSubtitleAction");
                subtitleSpanElement.textContent = Utils.getTranslation("pwaSecretSubtitleRest");
            }
        }
    }

    // Control video playback based on overlay state
    if (video) {
        const isOverlayVisible = showSecret || showPwaSecret;
        const isCurrentSlide = section.classList.contains('swiper-slide-active');

        // First, enforce pausing if any overlay is active.
        // This is the most important rule.
        if (isOverlayVisible) {
            if (!video.paused) {
                video.pause();
            }
        }
        // Only if no overlays are active, consider playing the video.
        else if (isCurrentSlide && video.paused) {
            video.play().catch(e => console.warn("Autoplay prevented on UI update:", e));
        }
    }

    const likeBtn = section.querySelector(".like-button");
    if (likeBtn) {
      const slide = slidesData.find(
        (s) => String(s.likeId) === String(likeBtn.dataset.likeId),
      );
      if (slide) {
        updateLikeButtonState(
          likeBtn,
          !!(slide.isLiked && isLoggedIn),
          Number(slide.initialLikes || 0),
        );
      }
    }
  });
}

function updateTranslations() {
  const lang = State.get("currentLang");
  document.documentElement.lang = lang;

  document.querySelectorAll("[data-translate-key]").forEach((el) => {
    el.textContent = Utils.getTranslation(el.dataset.translateKey);
  });
  document.querySelectorAll("[data-translate-aria-label]").forEach((el) => {
    el.setAttribute(
      "aria-label",
      Utils.getTranslation(el.dataset.translateAriaLabel),
    );
  });
  document.querySelectorAll("[data-translate-title]").forEach((el) => {
    el.setAttribute(
      "title",
      Utils.getTranslation(el.dataset.translateTitle),
    );
  });
  document
    .querySelectorAll("[data-translate-placeholder]")
    .forEach((el) => {
      el.setAttribute(
        "placeholder",
        Utils.getTranslation(el.dataset.translatePlaceholder),
      );
    });

  // Handle composite elements
  const sortTrigger = document.querySelector(".sort-trigger");
  if (sortTrigger) {
    const sortOrder = State.get("commentSortOrder");
    const currentSortText = Utils.getTranslation(
      sortOrder === "popular" ? "commentSortBest" : "commentSortNewest",
    );
    sortTrigger.innerHTML = `${Utils.getTranslation("commentSortTriggerText")}<span class="current-sort">${currentSortText}</span> ▼`;
  }

  const loginPrompt = document.querySelector(".login-to-comment-prompt p");
  if (loginPrompt) {
    loginPrompt.innerHTML = `<a href="#" data-action="toggle-login-panel" data-translate-key="loginToCommentAction">${Utils.getTranslation("loginToCommentAction")}</a><span data-translate-key="loginToCommentRest">${Utils.getTranslation("loginToCommentRest")}</span>`;
  }

  updateUIForLoginState();
}

function createSlideElement(slideData, index) {
  const slideFragment = DOM.template.content.cloneNode(true);
  const section = slideFragment.querySelector(".webyx-section");
  section.dataset.index = index;
  section.dataset.slideId = slideData.id;

  if (slideData.id === 'slide-002') {
    section.classList.add('slide--light-theme');
  }

  if (slideData.isIframe) {
    const tiktokSymulacja = section.querySelector(".tiktok-symulacja");
    const videoEl = tiktokSymulacja.querySelector("video");
    if (videoEl) videoEl.remove();
    const pauseOverlay = tiktokSymulacja.querySelector(".pause-overlay");
    if (pauseOverlay) pauseOverlay.remove();
    const secretOverlay = tiktokSymulacja.querySelector(".secret-overlay");
    if (secretOverlay) secretOverlay.remove();
    const errorOverlay = tiktokSymulacja.querySelector(".error-overlay");
    if (errorOverlay) errorOverlay.remove();

    const iframe = document.createElement("iframe");
    iframe.style.width = "100%";
    iframe.style.height = "100%";
    iframe.src = slideData.iframeUrl;
    iframe.frameBorder = "0";
    iframe.allow =
      "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
    iframe.allowFullscreen = true;
    tiktokSymulacja.prepend(iframe);
  } else if (slideData.mp4Url) {
    const videoEl = section.querySelector("video");
    if (videoEl) {
      videoEl.src = slideData.mp4Url;
      // Wideo zablokowane domyślnie pauzujemy. Logika UI je odblokuje, jeśli warunki są spełnione.
      if (slideData.access === 'secret' || slideData.access === 'pwa-secret') {
        videoEl.pause();
      }
    }
  }

  // Ustawienie początkowej widoczności nakładek.
  // Główna logika jest w `updateUIForLoginState`, ale to zapewnia poprawny stan przed pierwszym renderowaniem.
  if (slideData.access === 'pwa-secret' && PWA_MODULE && !PWA_MODULE.isStandalone()) {
    const pwaSecretOverlay = section.querySelector('.pwa-secret-overlay');
    if (pwaSecretOverlay) {
      pwaSecretOverlay.classList.add('visible');
    }
    // ✅ FIX: Natychmiast dodaj klasę video-loaded dla slajdów PWA, aby UI był widoczny
    section.querySelector('.tiktok-symulacja').classList.add('video-loaded');
  }

  section.querySelector(".tiktok-symulacja").dataset.access =
    slideData.access;
  const avatarImg = section.querySelector(".profileButton img");
  avatarImg.src = slideData.author.avatar;
  if (slideData.author.is_vip) {
    avatarImg.classList.add("vip-avatar-border");
  }

  section.querySelector(".slide-title").textContent = slideData.title;
  section.querySelector(".author-name").textContent = slideData.author.name;
  section.querySelector(".slide-description").textContent =
    slideData.description;

  const likeBtn = section.querySelector(".like-button");
  likeBtn.dataset.likeId = slideData.likeId;
  updateLikeButtonState(likeBtn, slideData.isLiked, slideData.initialLikes);

  const commentsBtn = section.querySelector(".commentsButton");
  const commentsCountEl = commentsBtn.querySelector(".comment-count");
  commentsCountEl.textContent = Utils.formatCount(
    slideData.initialComments,
  );

  const tiktokSymulacja = section.querySelector(".tiktok-symulacja");
  const videoEl = section.querySelector("video");
  const pauseOverlay = section.querySelector(".pause-overlay");
  const replayOverlay = section.querySelector(".replay-overlay");

  if (videoEl && pauseOverlay && replayOverlay) {
    // Gdy video się kończy - pokaż replay
    videoEl.addEventListener("ended", () => {
      replayOverlay.classList.add("visible");
    });

    // Gdy video zaczyna grać - ukryj overlays
    videoEl.addEventListener("play", () => {
      replayOverlay.classList.remove("visible");
      pauseOverlay.classList.remove("visible");
    });

    // Gdy video jest odtwarzane (po play) - ukryj overlays
    videoEl.addEventListener("playing", () => {
      replayOverlay.classList.remove("visible");
      pauseOverlay.classList.remove("visible");
    });
  }
  const progressBar = section.querySelector(".progress-bar");
  const progressBarFill = section.querySelector(".progress-bar-fill");

  if (videoEl) {
    // ✅ FIX: Pokaż UI od razu po załadowaniu metadanych, nie czekaj na odtwarzanie
    videoEl.addEventListener(
      "loadedmetadata",
      () => {
        tiktokSymulacja.classList.add("video-loaded");
      },
      { once: true },
    );

    // Spróbuj odtworzyć (może zadziałać lub nie - ale UI już będzie widoczny)
    videoEl.addEventListener(
      "canplay",
      () => {
        // Tylko jeśli to aktywny slajd i brak overlay
        if (section.classList.contains('swiper-slide-active')) {
          const secretOverlay = section.querySelector('.secret-overlay');
          const pwaSecretOverlay = section.querySelector('.pwa-secret-overlay');
          const isOverlayVisible =
            (secretOverlay && secretOverlay.classList.contains('visible')) ||
            (pwaSecretOverlay && pwaSecretOverlay.classList.contains('visible'));

          if (!isOverlayVisible && videoEl.paused) {
            videoEl.play().catch(e => {
              console.log("Autoplay prevented, showing pause overlay");
              const pauseOverlay = section.querySelector('.pause-overlay');
              if (pauseOverlay) pauseOverlay.classList.add('visible');
            });
          }
        }
      },
      { once: true },
    );
  }

  if (videoEl && progressBar && progressBarFill) {
    const handle = section.querySelector(".progress-bar-handle");
    let isDragging = false;

    const updateProgress = () => {
      if (isDragging || !videoEl.duration) return;
      const progress = (videoEl.currentTime / videoEl.duration) * 100;
      progressBarFill.style.width = `${progress}%`;
      if (handle) handle.style.left = `${progress}%`;
    };

    const seek = (e) => {
      const rect = progressBar.getBoundingClientRect();
      const clickX =
        (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      const width = rect.width;
      const progress = Math.max(0, Math.min(1, clickX / width));

      if (videoEl.duration > 0) {
        videoEl.currentTime = progress * videoEl.duration;
        progressBarFill.style.width = `${progress * 100}%`;
        if (handle) handle.style.left = `${progress * 100}%`;
      }
    };

    videoEl.addEventListener("timeupdate", updateProgress);

    const startDrag = (e) => {
      if (e.type === "touchstart") {
        e.preventDefault();
      }
      isDragging = true;
      progressBar.classList.add("dragging");
      const wasPlaying = !videoEl.paused;
      videoEl.pause();

      seek(e);

      const onDrag = (moveEvent) => {
        if (!isDragging) return;
        moveEvent.preventDefault();
        seek(moveEvent);
      };

      const endDrag = () => {
        if (!isDragging) return;
        isDragging = false;
        progressBar.classList.remove("dragging");
        if (wasPlaying) {
          videoEl.play().catch((err) => {
            console.error("Play failed after drag:", err);
          });
        }
        document.removeEventListener("mousemove", onDrag);
        document.removeEventListener("mouseup", endDrag);
        document.removeEventListener("touchmove", onDrag, {
          passive: false,
        });
        document.removeEventListener("touchend", endDrag);
      };

      document.addEventListener("mousemove", onDrag);
      document.addEventListener("mouseup", endDrag);
      document.addEventListener("touchmove", onDrag, { passive: false });
      document.addEventListener("touchend", endDrag);
    };

    progressBar.addEventListener("mousedown", startDrag);
    progressBar.addEventListener("touchstart", startDrag, {
      passive: false,
    });
  }

  return section;
}

function renderSlides() {
  const wrapper = DOM.container.querySelector(".swiper-wrapper");
  if (!wrapper) return;
  wrapper.innerHTML = "";
  if (slidesData.length === 0) return;

  slidesData.forEach((data, index) => {
    const slideElement = createSlideElement(data, index);
    wrapper.appendChild(slideElement);
  });
}

function updateCommentFormVisibility() {
  const isLoggedIn = State.get("isUserLoggedIn");
  const form = document.getElementById("comment-form");
  const prompt = document.querySelector(".login-to-comment-prompt");

  if (form && prompt) {
    if (isLoggedIn) {
      form.style.display = "flex";
      prompt.style.display = "none";
    } else {
      form.style.display = "none";
      prompt.style.display = "block";
    }
  }
}

function updateVolumeButton(isMuted) {
  document.querySelectorAll(".volume-button").forEach(button => {
    const onIcon = button.querySelector(".volume-on-icon");
    const offIcon = button.querySelector(".volume-off-icon");
    if (onIcon && offIcon) {
      onIcon.style.display = isMuted ? 'none' : 'block';
      offIcon.style.display = isMuted ? 'block' : 'none';
    }
  });
}

/**
 * Globalny Keyboard Listener (v2 - Niezawodny)
 * Odporny na zmiany orientacji i poprawnie współpracuje z CSS "Freezer".
 */

function initEmojiPicker() {
  const emojiPicker = document.querySelector('.emoji-picker');
  if (!emojiPicker || emojiPicker.children.length > 0) return;

  const fragment = document.createDocumentFragment();
  Config.EMOJI_LIST.forEach(emoji => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'emoji-item';
    btn.textContent = emoji;
    btn.setAttribute('aria-label', `Insert ${emoji}`);
    btn.addEventListener('click', () => insertEmoji(emoji));
    fragment.appendChild(btn);
  });
  emojiPicker.appendChild(fragment);
}

function insertEmoji(emoji) {
  const input = document.querySelector('#comment-input');
  if (!input) return;

  const start = input.selectionStart;
  const end = input.selectionEnd;
  const text = input.value;

  input.value = text.substring(0, start) + emoji + text.substring(end);
  input.selectionStart = input.selectionEnd = start + emoji.length;
  input.focus();

  hideEmojiPicker();
}

// Dodaj zmienną dla debounce na początku pliku (przed funkcją)
let emojiPickerTimeout = null;
let emojiPickerClickListener = null;

function toggleEmojiPicker() {
  const picker = document.querySelector('.emoji-picker');
  if (!picker) {
    console.warn('Emoji picker element not found');
    return;
  }

  // Debounce - zapobiegaj podwójnym kliknięciom
  if (emojiPickerTimeout) {
    return;
  }

  const isVisible = picker.classList.contains('visible');

  if (isVisible) {
    hideEmojiPicker();
  } else {
    picker.classList.add('visible');

    // Usuń stary listener jeśli istnieje
    if (emojiPickerClickListener) {
      document.removeEventListener('click', emojiPickerClickListener);
      emojiPickerClickListener = null;
    }

    // Dodaj nowy listener po micro-delay
    setTimeout(() => {
      emojiPickerClickListener = (e) => closeEmojiPickerOnClickOutside(e);
      document.addEventListener('click', emojiPickerClickListener, { once: true });
    }, 10);
  }

  // Debounce timer
  emojiPickerTimeout = setTimeout(() => {
    emojiPickerTimeout = null;
  }, 300);
}

function hideEmojiPicker() {
  const picker = document.querySelector('.emoji-picker');
  if (picker) {
    picker.classList.remove('visible');
  }

  // Usuń pending listener
  if (emojiPickerClickListener) {
    document.removeEventListener('click', emojiPickerClickListener);
    emojiPickerClickListener = null;
  }
}

function closeEmojiPickerOnClickOutside(e) {
  const picker = document.querySelector('.emoji-picker');
  const emojiBtn = document.querySelector('.emoji-btn');

  // Walidacja elementów
  if (!picker || !emojiBtn) {
    return;
  }

  // Sprawdź czy kliknięcie było poza pickerem i przyciskiem
  if (!picker.contains(e.target) && !emojiBtn.contains(e.target)) {
    hideEmojiPicker();
  }
}

function handleImageAttachment() {
  const fileInput = document.querySelector('.comment-image-input');

  if (!fileInput) {
    console.error('Comment image input not found');
    UI.showAlert(
      Utils.getTranslation('imageInputError') || 'Nie można załączyć obrazu',
      true
    );
    return;
  }

  // Sprawdź czy użytkownik jest zalogowany
  if (!State.get('isUserLoggedIn')) {
    UI.showAlert(Utils.getTranslation('likeAlert') || 'Zaloguj się, aby dodać obraz', true);
    return;
  }

  fileInput.click();
}

function handleImageSelect(e) {
  const file = e.target.files[0];

  if (!file) {
    return;
  }

  // Walidacja typu
  if (!file.type.startsWith('image/')) {
    UI.showAlert(
      Utils.getTranslation('fileSelectImageError') || 'Wybierz plik obrazu (JPG, PNG, GIF)',
      true
    );
    e.target.value = '';
    return;
  }

  // Walidacja rozmiaru
  const maxSize = 5 * 1024 * 1024; // 5MB
  if (file.size > maxSize) {
    UI.showAlert(
      Utils.getTranslation('fileTooLargeError') || 'Obraz jest za duży. Maksymalny rozmiar: 5MB',
      true
    );
    e.target.value = '';
    return;
  }

  // Sprawdź czy można odczytać plik
  const reader = new FileReader();

  reader.onerror = () => {
    console.error('Failed to read file');
    UI.showAlert(
      Utils.getTranslation('fileReadError') || 'Nie można odczytać pliku',
      true
    );
    e.target.value = '';
  };

  reader.onload = () => {
    // Plik jest OK - zapisz go
    selectedCommentImage = file;
    showImagePreview(file);
  };

  // Rozpocznij odczyt (tylko dla walidacji)
  reader.readAsDataURL(file);

  // Wyczyść input żeby można było wybrać ten sam plik ponownie
  e.target.value = '';
}

function showImagePreview(file) {
  const container = document.querySelector('.image-preview-container');
  if (!container) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    container.innerHTML = `
      <div class="image-preview">
        <img src="${e.target.result}" alt="Preview">
        <button type="button" class="remove-image-btn" data-action="remove-comment-image">&times;</button>
      </div>
    `;
    container.classList.add('visible');
  };
  reader.readAsDataURL(file);
}

function removeCommentImage() {
  selectedCommentImage = null;
  const container = document.querySelector('.image-preview-container');
  if (container) {
    container.classList.remove('visible');
    container.innerHTML = '';
  }
}

function focusCommentInput() {
  const input = document.querySelector('#comment-input');
  if (input) {
    setTimeout(() => {
      input.focus();

      if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 100);
  }
}

function scrollToComment(commentId) {
  const commentEl = document.querySelector(`[data-comment-id="${commentId}"]`);
  if (commentEl) {
    commentEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

    commentEl.style.background = 'rgba(255, 0, 85, 0.1)';
    setTimeout(() => {
      commentEl.style.background = '';
    }, 1000);
  }
}

function openImageLightbox(imageUrl) {
  const lightbox = document.querySelector('.image-lightbox');
  if (!lightbox) return;

  const img = lightbox.querySelector('img');
  img.src = imageUrl;
  lightbox.classList.add('visible');

  document.body.style.overflow = 'hidden';
}

function closeImageLightbox() {
  const lightbox = document.querySelector('.image-lightbox');
  if (!lightbox) return;

  lightbox.classList.remove('visible');
  document.body.style.overflow = '';
}

function renderComments(comments) {
    const container = DOM.commentsModal.querySelector('.comments-list');
    const emptyState = DOM.commentsModal.querySelector('.comments-empty-state');
    const errorState = DOM.commentsModal.querySelector('.comment-load-error');
    const template = document.getElementById('comment-template');

    if (!container || !emptyState || !errorState || !template) {
        console.error('Required comment elements not found in DOM.');
        if(errorState) errorState.style.display = 'block';
        return;
    }

    container.innerHTML = '';
    errorState.style.display = 'none';

    if (!comments || comments.length === 0) {
        emptyState.style.display = 'flex';
        return;
    }
    emptyState.style.display = 'none';

    const fragment = document.createDocumentFragment();

    comments.forEach(comment => {
        const commentNode = template.content.cloneNode(true);
        const commentItem = commentNode.querySelector('.comment-item');

        commentItem.dataset.commentId = comment.id;
        commentItem.querySelector('.comment-avatar img').src = comment.avatar || 'path/to/default-avatar.png';
        commentItem.querySelector('.comment-author').textContent = comment.user;
        commentItem.querySelector('.comment-timestamp').textContent = Utils.formatTimeAgo(comment.timestamp);
        commentItem.querySelector('.comment-text').textContent = comment.text;

        const imageAttachment = commentItem.querySelector('.comment-image-attachment');
        if (comment.image_url) {
            imageAttachment.style.display = 'block';
            imageAttachment.querySelector('img').src = comment.image_url;
            imageAttachment.querySelector('img').addEventListener('click', () => openImageLightbox(comment.image_url));
        } else {
            imageAttachment.style.display = 'none';
        }

        const likeBtn = commentItem.querySelector('.comment-like-btn');
        likeBtn.classList.toggle('active', comment.isLiked);
        commentItem.querySelector('.comment-like-count').textContent = Utils.formatCount(comment.likes);

        const optionsContainer = commentItem.querySelector('.comment-options');
        if (comment.canEdit) {
            optionsContainer.style.display = 'block';
        } else {
            optionsContainer.style.display = 'none';
        }

        fragment.appendChild(commentNode);
    });

    container.appendChild(fragment);
}

function initGlobalPanels() {
  initEmojiPicker();

  // Setup file input handler
  const fileInput = document.querySelector('.comment-image-input');
  if (fileInput) {
    fileInput.addEventListener('change', handleImageSelect);
  }

  // Setup lightbox close
  const lightboxClose = document.querySelector('.image-lightbox-close');
  if (lightboxClose) {
    lightboxClose.addEventListener('click', closeImageLightbox);
  }

  const lightbox = document.querySelector('.image-lightbox');
  if (lightbox) {
    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox) {
        closeImageLightbox();
      }
    });
  }
}

function closeWelcomeModal() {
    const modal = DOM.welcomeModal;
    if (!modal || !modal.classList.contains('visible') || modal.classList.contains('is-hiding')) {
        return;
    }

    modal.classList.add('is-hiding');
    modal.setAttribute('aria-hidden', 'true');

    const content = modal.querySelector('.welcome-modal-content');

    const cleanup = () => {
        if(content) content.removeEventListener('animationend', cleanup);
        modal.classList.remove('visible', 'is-hiding');
        activeModals.delete(modal);

        if (activeModals.size === 0) {
            DOM.container.removeAttribute('aria-hidden');
            const lastFocused = State.get('lastFocusedElement');
            if(lastFocused) lastFocused.focus();
        }
    };

    if(content){
        content.addEventListener('animationend', cleanup, { once: true });
        setTimeout(cleanup, 700); // Fallback
    } else {
        closeModal(modal); // Fallback for simple structure
    }
}

export const UI = {
  initDOMCache,
  DOM,
  showAlert,
  openModal,
  closeModal,
  updateUIForLoginState,
  updateTranslations,
  applyLikeStateToDom,
  createSlideElement,
  renderSlides,
  initGlobalPanels,
  renderComments,
  updateCommentFormVisibility,
  showToast,
  updateVolumeButton,
  toggleEmojiPicker,
  hideEmojiPicker,
  handleImageAttachment,
  removeCommentImage,
  focusCommentInput,
  scrollToComment,
  openImageLightbox,
  closeImageLightbox,
  isSlideOverlayActive, // ✅ NOWE
  setPwaModule, // ✅ NOWE
  getIsUserLoggedIn,
  closeCommentsModal,
  closeWelcomeModal,
  updateCrowdfundingStats,
  openAuthorProfileModal,
  closeAuthorProfileModal,
};

async function updateCrowdfundingStats() {
    try {
        const result = await API.getNewCrowdfundingStats();
        if (result.success && result.data) {
            const stats = result.data;
            const patronsEl = document.querySelector('.stats-grid .stat-item:nth-child(1) .stat-value');
            const collectedEl = document.querySelector('.progress-label span strong');
            const progressFillEl = document.querySelector('.progress-section .progress-bar-fill');
            const progressLabelEl = document.querySelector('.progress-label');

            if (patronsEl) patronsEl.textContent = stats.patrons_count;

            if (progressLabelEl) {
                const goal = parseFloat(progressLabelEl.dataset.goal) || 500;
                const percentage = Math.min(100, (stats.collected_eur / goal) * 100);
                progressLabelEl.dataset.collected = stats.collected_eur.toFixed(2);
                progressLabelEl.dataset.percentage = percentage.toFixed(0);

                if (collectedEl) collectedEl.textContent = `${stats.collected_eur.toFixed(2)} z ${goal} EUR`;

                const labelSpan = progressLabelEl.querySelector('span');
                if(labelSpan) {
                    labelSpan.innerHTML = `Cel: <strong>${stats.collected_eur.toFixed(2)} z ${goal} EUR</strong> (${percentage.toFixed(0)}%)`;
                }
            }

            if (progressFillEl) {
                const goal = 500;
                const percentage = Math.min(100, (stats.collected_eur / goal) * 100);
                progressFillEl.style.width = `${percentage}%`;
            }
        }
    } catch (error) {
        console.error("Failed to update crowdfunding stats:", error);
    }
}

function closeCommentsModal() {
    const modal = DOM.commentsModal;
    if (!modal || !modal.classList.contains('visible') || modal.classList.contains('is-hiding')) {
        return;
    }

    modal.classList.add('is-hiding');
    modal.setAttribute('aria-hidden', 'true');

    const cleanup = () => {
        modal.removeEventListener('transitionend', cleanup);
        modal.classList.remove('visible', 'is-hiding');
        activeModals.delete(modal);

        if (activeModals.size === 0) {
            DOM.container.removeAttribute('aria-hidden');
            State.get('lastFocusedElement')?.focus();
        }
    };

    modal.addEventListener('transitionend', cleanup, { once: true });
    // Fallback w razie gdyby event się nie odpalił
    setTimeout(cleanup, 400);
}// ting-tong-theme/js/modules/interactive-wall.js

export function initInteractiveWall(canvas, slideId) {
    const ctx = canvas.getContext('2d');
    const parent = canvas.parentElement;
    if (!parent) return;

    // Definicje stałych (kolor fugi jest też kolorem konturu)
    const ceglaSzerokosc = 60;
    const ceglaWysokosc = 30;
    const fugaGrubosc = 1;
    const kolorCegly = '#ffffff';
    const kolorKonturu = '#333333'; // Kolor konturu/fugi
    const grawitacja = 0.5;

    let cegly = [];

    class Cegla {
        constructor(x, y, szerokosc, wysokosc, isStatic = true) {
            this.x = x;
            this.y = y;
            this.szerokosc = szerokosc;
            this.wysokosc = wysokosc;
            this.isStatic = isStatic;
            this.vx = 0;
            this.vy = 0;
            this.kat = 0;
            this.predkoscKatowa = 0;
            this.zniszczona = false;
        }

        draw() {
            if (this.zniszczona) return;
            ctx.save();
            ctx.translate(this.x + this.szerokosc / 2, this.y + this.wysokosc / 2);
            ctx.rotate(this.kat);

            // Rysowanie cegły (wypełnienie)
            ctx.fillStyle = kolorCegly;
            ctx.fillRect(-this.szerokosc / 2, -this.wysokosc / 2, this.szerokosc, this.wysokosc);

            // NAPRAWA KONTURU: Rysowanie konturu (fugi)
            ctx.strokeStyle = kolorKonturu;
            ctx.lineWidth = fugaGrubosc;
            ctx.strokeRect(-this.szerokosc / 2, -this.wysokosc / 2, this.szerokosc, this.wysokosc);

            ctx.restore();
        }

        update() {
            if (this.isStatic || this.zniszczona) return;

            // Logika fizyki
            this.vy += grawitacja;
            this.x += this.vx;
            this.y += this.vy;
            this.kat += this.predkoscKatowa;

            if (this.y > canvas.height + this.wysokosc) {
                this.zniszczona = true;
            }
        }
    }

    function inicjalizujMur() {
        cegly = [];
        const szerokoscCeglyZFuga = ceglaSzerokosc + fugaGrubosc;
        const wysokoscCeglyZFuga = ceglaWysokosc + fugaGrubosc;
        const iloscRzedow = Math.ceil(canvas.height / wysokoscCeglyZFuga);
        // Dodatkowa kolumna dla pełnego pokrycia
        const iloscKolumn = Math.ceil(canvas.width / szerokoscCeglyZFuga) + 1;

        for (let rzad = 0; rzad < iloscRzedow; rzad++) {
            const offset = (rzad % 2 !== 0) ? szerokoscCeglyZFuga / 2 : 0;
            for (let kolumna = 0; kolumna < iloscKolumn; kolumna++) {
                let x = kolumna * szerokoscCeglyZFuga - offset;
                const y = rzad * wysokoscCeglyZFuga;
                cegly.push(new Cegla(x, y, ceglaSzerokosc, ceglaWysokosc));
            }
        }
    }

    function niszczMur(klikX, klikY) {
        // NAPRAWA 1: Zmniejszony promień destrukcji i siła (mniejsze fragmenty)
        const PROMIEN_DESTRUKCJI = 40;
        const BAZOWA_SILA = 8;
        let ceglaZniszczona = false;

        cegly.forEach(cegla => {
            if (cegla.isStatic && !cegla.zniszczona) {
                const dx = (cegla.x + cegla.szerokosc / 2) - klikX;
                const dy = (cegla.y + cegla.wysokosc / 2) - klikY;
                const dystans = Math.sqrt(dx * dx + dy * dy);

                if (dystans < PROMIEN_DESTRUKCJI) {
                    ceglaZniszczona = true; // Zaznacz, że coś zostało zniszczone
                    cegla.isStatic = false;
                    const katEksplozji = Math.atan2(dy, dx);

                    // Siła jest proporcjonalna do dystansu od centrum
                    const sila = (PROMIEN_DESTRUKCJI - dystans) / (PROMIEN_DESTRUKCJI / BAZOWA_SILA);

                    cegla.vx = -Math.cos(katEksplozji) * sila * (0.8 + Math.random() * 0.4);
                    cegla.vy = -Math.sin(katEksplozji) * sila * (0.5 + Math.random() * 0.5) - 5;
                    cegla.predkoscKatowa = (Math.random() - 0.5) * 0.4;
                }
            }
        });
        return ceglaZniszczona; // Zwróć true, jeśli jakakolwiek cegła została uderzona
    }

    function animate() {
        // NAPRAWA KRUCJALNA (PRZEZROCZYSTOŚĆ): Usuwamy wypełnienie tła, wideo pod spodem jest widoczne
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        cegly.forEach(cegla => {
            cegla.update();
            cegla.draw();
        });

        requestAnimationFrame(animate);
    }

    // Resize handler (dostosowuje Canvas przy zmianie rozmiaru)
    const resizeObserver = new ResizeObserver(entries => {
        for (let entry of entries) {
            canvas.width = entry.contentRect.width;
            canvas.height = entry.contentRect.height;
            inicjalizujMur();
        }
    });
    if (parent) {
       resizeObserver.observe(parent);
    }

    // Listener interakcji
    canvas.addEventListener('click', (event) => {
        // KRUCJALNA NAPRAWA 2: ZAWSZE blokuj propagację do Swipera/Wideo.
        event.stopPropagation();

        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;

        // 1. Wykonaj destrukcję. Zapisz, czy jakakolwiek cegła została uderzona.
        const czyZniszczono = niszczMur(x, y);

        // 2. Sprawdź, czy kliknięcie trafiło w JAKĄKOLWIEK nienaruszoną cegłę (nawet poza promieniem destrukcji)
        let trafionoWNienaruszonaCegle = cegly.some(cegla => {
            if (cegla.isStatic && !cegla.zniszczona) {
                 return (
                     x >= cegla.x && x <= cegla.x + cegla.szerokosc &&
                     y >= cegla.y && y <= cegla.y + cegla.wysokosc
                 );
            }
            return false;
        });

        // 3. LOGIKA PAUZY (NAPRAWIONA):
        // Wideo pauzuje/odtwarza TYLKO, jeśli NIE TRAFIONO w ŻADNĄ nienaruszoną cegłę.
        // (Czyli kliknięto w PUSTE TŁO lub w DZIURĘ pozostawioną przez zniszczone cegły).

        if (!trafionoWNienaruszonaCegle) {
             const video = canvas.closest('.tiktok-symulacja')?.querySelector('video');
             const pauseOverlay = canvas.closest('.tiktok-symulacja')?.querySelector('.pause-overlay');

             if(video) {
                 if (video.paused) {
                     video.play().catch(e => console.warn('Autoplay error:', e));
                     if (pauseOverlay) pauseOverlay.classList.remove("visible");
                 } else {
                     video.pause();
                     if (pauseOverlay) pauseOverlay.classList.add("visible");
                 }
             }
        }
    });

    inicjalizujMur();
    animate();
}
import { State } from './state.js';
import { UI } from './ui.js';
import { Utils } from './utils.js';
import { API, slidesData } from './api.js';
import { PWA } from './pwa.js';
import { Notifications } from './notifications.js';
import { AccountPanel } from './account-panel.js';
import { authManager } from './auth-manager.js';
import { TippingModal } from './tipping-modal.js';
import { CommentsModal } from './comments-modal.js';

function mockToggleLogin() {
  const isLoggedIn = State.get("isUserLoggedIn");
  State.set("isUserLoggedIn", !isLoggedIn);
  UI.updateUIForLoginState();
  const message = !isLoggedIn
    ? Utils.getTranslation("loginSuccess")
    : Utils.getTranslation("logoutSuccess");
  UI.showAlert(message);

  // If we are logging in, close the panel
  if (!isLoggedIn) {
    const loginPanel = document.querySelector("#app-frame > .login-panel");
    if (loginPanel) loginPanel.classList.remove("active");
    const topbar = document.querySelector("#app-frame > .topbar");
    if (topbar) topbar.classList.remove("login-panel-active");
  }
}


async function handleLikeToggle(button) {
  if (!State.get("isUserLoggedIn")) {
    Utils.vibrateTry();
    UI.showAlert(Utils.getTranslation("likeAlert"));
    return;
  }
  const swiper = State.get('swiper');
  if (!swiper) return;
  const slideId = swiper.slides[swiper.activeIndex].dataset.slideId;
  const slideData = slidesData.find((s) => s.id === slideId);
  if (!slideData) return;

  const isCurrentlyLiked = !!slideData.isLiked;
  const newLikedState = !isCurrentlyLiked;
  const currentCount = slideData.initialLikes;
  const newCount = newLikedState
    ? currentCount + 1
    : Math.max(0, currentCount - 1);

  // Optimistic UI update
  slideData.isLiked = newLikedState;
  slideData.initialLikes = newCount;
  UI.applyLikeStateToDom(slideData.likeId, newLikedState, newCount);
  button.disabled = true;

  const json = await API.toggleLike(slideData.likeId);

  if (json.success) {
    slideData.isLiked = json.data.status === "liked";
    slideData.initialLikes = json.data.count;
    UI.applyLikeStateToDom(
      slideData.likeId,
      slideData.isLiked,
      slideData.initialLikes,
    );
  } else {
    // Revert
    slideData.isLiked = isCurrentlyLiked;
    slideData.initialLikes = currentCount;
    UI.applyLikeStateToDom(
      slideData.likeId,
      isCurrentlyLiked,
      currentCount,
    );
    UI.showAlert(
      json.data?.message || Utils.getTranslation("likeError"),
      true,
    );
  }
  button.disabled = false;
}

function handleShare(button) {
  const swiper = State.get('swiper');
  if (!swiper) return;
  const slideId = swiper.slides[swiper.activeIndex].dataset.slideId;
  const slideData = slidesData.find(
    (s) => s.id === slideId,
  );
  if (navigator.share && slideData) {
    navigator
      .share({
        title: Utils.getTranslation("shareTitle"),
        text: slideData.description,
        url: window.location.href,
      })
      .catch((err) => {
        if (err.name !== "AbortError") console.error("Share error:", err);
      });
  } else {
    navigator.clipboard
      .writeText(window.location.href)
      .then(() => UI.showAlert(Utils.getTranslation("linkCopied")));
  }
}

async function handleLanguageToggle() { // Zmień na async
  const oldLang = State.get("currentLang");
  const newLang = oldLang === "pl" ? "en" : "pl";

  // Mapowanie na lokalizację WP
  const newLocale = newLang === 'pl' ? 'pl_PL' : 'en_GB';

  // 1. Aktualizacja stanu aplikacji
  State.set("currentLang", newLang);
  localStorage.setItem("tt_lang", newLang);

  // 2. Aktualizacja UI
  UI.updateTranslations();
  Notifications.render();

  // 3. Wysłanie nowej lokalizacji do API WordPressa
  if (State.get("isUserLoggedIn")) {
      try {
        const result = await API.updateLocale(newLocale);
        if (result.success) {
          console.log(`WordPress locale updated to: ${newLocale}`);
        } else {
          console.warn("Failed to update WP locale via main toggle:", result.data?.message);
        }
      } catch (error) {
        console.error("API Error updating WP locale via main toggle:", error);
      }
  }
}


export const Handlers = {
  handleNotificationClick: (event) => {
    const item = event.target.closest(".notification-item");
    if (!item) return;
    item.classList.toggle("expanded");
    item.setAttribute("aria-expanded", item.classList.contains("expanded"));
    if (item.classList.contains("unread")) {
      item.classList.remove("unread");
    }
  },
  mainClickHandler: (e) => {
    const target = e.target;
    const actionTarget = target.closest("[data-action]");
    const videoThumbnail = target.closest(".video-thumbnail");

    if (videoThumbnail) {
        if (videoThumbnail.classList.contains('locked-thumbnail')) {
            UI.showAlert(Utils.getTranslation('becomePatronToWatch'), true);
            return;
        }
        const videoUrl = videoThumbnail.dataset.videoUrl;
        if (videoUrl) {
            const videoModal = document.getElementById('video-player-modal');
            const videoPlayer = videoModal.querySelector('video');
            videoPlayer.src = videoUrl;

            // 1. Zlokalizuj wideo w tle i zapauzuj, jeśli gra
            const swiper = State.get('swiper');
            let mainVideo;
            if (swiper && swiper.slides[swiper.activeIndex]) {
                mainVideo = swiper.slides[swiper.activeIndex].querySelector('video');
                // Pauzujemy główne wideo tylko, jeśli już leci
                if (mainVideo && !mainVideo.paused && !mainVideo.ended) {
                    mainVideo.pause();
                    State.set('videoPausedByAuthorModal', true); // Nowa flaga
                }
            }

            // 2. Otwórz modal z wideo
            UI.openModal(videoModal);
            videoPlayer.play();

            // 3. Dodaj handler, aby wznowić główne wideo po zamknięciu
            const closeModalHandler = () => {
                videoPlayer.pause();

                // Wznów tylko jeśli zostało zapauzowane przez modal autora
                if (State.get('videoPausedByAuthorModal') && mainVideo) {
                    mainVideo.play().catch(e => console.error("Błąd odtwarzania głównego wideo:", e));
                    State.set('videoPausedByAuthorModal', false);
                }
                // Musimy też upewnić się, że flaga jest czyszczona przy zamykaniu modala
                State.set('videoPausedByAuthorModal', false);
            };
            videoModal.addEventListener('modal:close', closeModalHandler, { once: true });
            return;
        }
    }

    // Handle comment-related actions first
    if (actionTarget && actionTarget.closest(".comment-item")) {
      const commentItem = actionTarget.closest(".comment-item");
      const commentId = commentItem.dataset.commentId;
      const slideId = document.querySelector(".swiper-slide-active")
        ?.dataset.slideId;

      // Walidacja przed wykonaniem akcji
      if (!slideId || !commentId) {
        console.error('Missing slideId or commentId');
        return;
      }

      // Sprawdź czy użytkownik jest zalogowany (dla akcji wymagających autoryzacji)
      const requiresAuth = ['edit-comment', 'delete-comment', 'toggle-comment-like'];
      if (requiresAuth.includes(actionTarget.dataset.action) && !State.get('isUserLoggedIn')) {
        UI.showAlert(Utils.getTranslation('likeAlert'), true);
        return;
      }

      switch (actionTarget.dataset.action) {
        case "toggle-comment-like": {
          const countEl = commentItem.querySelector(".comment-like-count");

          if (!countEl) {
            console.error('Like count element not found');
            return;
          }

          let currentLikes = parseInt(countEl.textContent.replace(/K|M/g, "")) || 0;

          // Optimistic UI update
          actionTarget.classList.toggle("active");
          const isLiked = actionTarget.classList.contains("active");
          currentLikes += isLiked ? 1 : -1;
          countEl.textContent = Utils.formatCount(currentLikes);

          // Disable button podczas requestu
          actionTarget.disabled = true;

          API.toggleCommentLike(slideId, commentId)
            .then((response) => {
              // Walidacja odpowiedzi
              if (!response || typeof response.success !== 'boolean') {
                throw new Error('Invalid response format');
              }

              if (!response.success) {
                // Revert on failure
                actionTarget.classList.toggle("active");
                currentLikes += isLiked ? -1 : 1;
                countEl.textContent = Utils.formatCount(currentLikes);

                throw new Error(
                  response.data?.message || Utils.getTranslation("failedToUpdateLike")
                );
              }

              // Zaktualizuj z prawdziwą wartością z serwera
              if (response.data?.likes !== undefined) {
                countEl.textContent = Utils.formatCount(response.data.likes);
              }
            })
            .catch((error) => {
              console.error('Toggle comment like error:', error);
              UI.showAlert(error.message || Utils.getTranslation("failedToUpdateLike"), true);
            })
            .finally(() => {
              actionTarget.disabled = false;
            });
          break;
        }
        case "edit-comment": {
          const textElement = commentItem.querySelector(".comment-text");

          if (!textElement) {
            console.error('Comment text element not found');
            return;
          }

          const currentText = textElement.textContent;
          const newText = prompt(
            Utils.getTranslation("editCommentPrompt"),
            currentText,
          );

          // Walidacja input
          if (!newText || !newText.trim()) {
            return;
          }

          if (newText.trim() === currentText) {
            return; // Brak zmian
          }

          // Disable edit button podczas requestu
          actionTarget.disabled = true;

          API.editComment(slideId, commentId, newText.trim())
            .then((response) => {
              // Walidacja odpowiedzi
              if (!response || typeof response.success !== 'boolean') {
                throw new Error('Invalid response format');
              }

              if (!response.success) {
                throw new Error(
                  response.data?.message || Utils.getTranslation("commentUpdateError")
                );
              }

              // Sprawdź czy mamy dane komentarza
              if (!response.data || !response.data.id) {
                throw new Error('Invalid comment data in response');
              }

              // Zaktualizuj w slidesData
              const slideData = slidesData.find((s) => s.id === slideId);
              if (slideData && Array.isArray(slideData.comments)) {
                const commentIndex = slideData.comments.findIndex(
                  c => String(c.id) === String(commentId)
                );
                if (commentIndex > -1) {
                  slideData.comments[commentIndex] = response.data;
                }
                UI.renderComments(slideData.comments);
              }

              UI.showToast(Utils.getTranslation("commentUpdateSuccess"));
            })
            .catch((error) => {
              console.error('Edit comment error:', error);
              UI.showAlert(error.message || Utils.getTranslation("commentUpdateError"), true);
            })
            .finally(() => {
              actionTarget.disabled = false;
            });
          break;
        }
        case "delete-comment": {
          if (!confirm(Utils.getTranslation("deleteCommentConfirm"))) {
            return;
          }

          // Disable delete button podczas requestu
          actionTarget.disabled = true;

          API.deleteComment(slideId, commentId)
            .then((response) => {
              // Walidacja odpowiedzi
              if (!response || typeof response.success !== 'boolean') {
                throw new Error('Invalid response format');
              }

              if (!response.success) {
                throw new Error(
                  response.data?.message || Utils.getTranslation("commentDeleteError")
                );
              }

              // Sprawdź czy mamy new_count
              if (typeof response.data?.new_count !== 'number') {
                console.warn('Missing new_count in response, calculating manually');
              }

              // Zaktualizuj slidesData
              const slideData = slidesData.find((s) => s.id === slideId);
              if (slideData) {
                // Usuń komentarz z lokalnych danych
                if (Array.isArray(slideData.comments)) {
                  const commentIndex = slideData.comments.findIndex(
                    c => String(c.id) === String(commentId)
                  );
                  if (commentIndex > -1) {
                    slideData.comments.splice(commentIndex, 1);
                  }
                }

                // Zaktualizuj licznik
                slideData.initialComments = response.data?.new_count ?? slideData.comments.length;

                // Re-render komentarzy
                UI.renderComments(slideData.comments);

                // Zaktualizuj licznik w głównym widoku
                const slideElement = document.querySelector(
                  `.swiper-slide-active[data-slide-id="${slideId}"]`
                );
                const mainSlideCount = slideElement?.querySelector(".comment-count");
                if (mainSlideCount) {
                  mainSlideCount.textContent = Utils.formatCount(slideData.initialComments);
                }

                // Zaktualizuj tytuł modala
                const commentsTitle = UI.DOM.commentsModal.querySelector("#commentsTitle");
                if (commentsTitle) {
                  commentsTitle.textContent = `${Utils.getTranslation("commentsModalTitle")} (${slideData.initialComments})`;
                }
              }

              UI.showToast(Utils.getTranslation("commentDeleteSuccess"));
            })
            .catch((error) => {
              console.error('Delete comment error:', error);
              UI.showAlert(error.message || Utils.getTranslation("commentDeleteError"), true);
              actionTarget.disabled = false; // Re-enable jeśli błąd
            });
          break;
        }
      }
      // Return to avoid double-handling reply-to-comment
      if (actionTarget.dataset.action !== 'reply-to-comment') {
          return;
      }
    }

    if (!actionTarget) {
      return;
    }

    const action = actionTarget.dataset.action;

    const topbar = document.querySelector("#app-frame > .topbar");
    const loginPanel = document.querySelector("#app-frame > .login-panel");
    const loggedInMenu = document.querySelector(
      "#app-frame > .logged-in-menu",
    );

    switch (action) {
      case "toggle-password-visibility":
        const passwordInput = document.getElementById('tt-password');
        const eyeOpen = actionTarget.querySelector('.eye-icon-open');
        const eyeClosed = actionTarget.querySelector('.eye-icon-closed');

        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            eyeOpen.style.display = 'block';
            eyeClosed.style.display = 'none';
        } else {
            passwordInput.type = 'password';
            eyeOpen.style.display = 'none';
            eyeClosed.style.display = 'block';
        }
        break;
      case "toggle-emoji-picker":
        UI.toggleEmojiPicker();
        break;
      case "attach-image":
        UI.handleImageAttachment();
        break;
      case "remove-comment-image":
        UI.removeCommentImage();
        break;
      case "reply-to-comment": {
        const commentItem = actionTarget.closest(".comment-item");
        const commentId = commentItem?.dataset.commentId;
        const userElement = commentItem?.querySelector(".comment-user");

        // Walidacja
        if (!commentId || !userElement) {
          console.error('Invalid reply target');
          return;
        }

        const user = userElement.textContent;

        // Sprawdź czy już nie odpowiadamy na ten komentarz
        const currentReplyId = State.get("replyingToComment");
        if (currentReplyId === commentId) {
          // Już odpowiadamy na ten komentarz - tylko focus input
          UI.focusCommentInput();
          return;
        }

        State.set("replyingToComment", commentId);

        const formContainer = document.querySelector(".comment-form-container");
        if (!formContainer) {
          console.error('Comment form container not found');
          return;
        }

        // Usuń stary reply context jeśli istnieje (zapobieganie duplikatom)
        const oldReplyContext = formContainer.querySelector(".reply-context");
        if (oldReplyContext) {
          oldReplyContext.remove();
        }

        // Utwórz nowy reply context
        const replyContext = document.createElement("div");
        replyContext.className = "reply-context";
        formContainer.prepend(replyContext);

        const cancelAriaLabel = Utils.getTranslation("cancelReplyAriaLabel");
        const replyingToText = Utils.getTranslation("replyingTo").replace("{user}", user);

        replyContext.innerHTML = `
          <span class="reply-context-text">${replyingToText}</span>
          <button class="cancel-reply-btn" data-action="cancel-reply" aria-label="${cancelAriaLabel}">&times;</button>
        `;
        replyContext.style.display = "flex";

        // Animacja wejścia
        requestAnimationFrame(() => {
          replyContext.style.opacity = '0';
          replyContext.style.transform = 'translateY(-10px)';
          replyContext.style.transition = 'opacity 0.2s, transform 0.2s';

          requestAnimationFrame(() => {
            replyContext.style.opacity = '1';
            replyContext.style.transform = 'translateY(0)';
          });
        });

        UI.focusCommentInput();
        break;
      }
      case "cancel-reply": {
        State.set("replyingToComment", null);
        const replyContext = document.querySelector(".reply-context");
        if (replyContext) replyContext.style.display = "none";
        UI.removeCommentImage();
        break;
      }
      case "go-back":
        const modalToClose = actionTarget.closest(".modal-overlay");
        if (modalToClose) {
          UI.closeModal(modalToClose);
        }
        break;
      case "toggle-like":
        handleLikeToggle(actionTarget);
        break;
      case "share":
        handleShare(actionTarget);
        break;
      case "toggle-language":
        handleLanguageToggle();
        break;
      case "open-comments-modal": {
        const modal = document.getElementById('comments-modal-container');
        if (modal) {
            modal.classList.add('visible');
        }
        break;
      }
      case "switch-profile-tab": {
        const tabButton = actionTarget;
        const tabContentId = tabButton.dataset.tab;

        const modal = tabButton.closest('.profile-modal-content');
        if (!modal) return;

        // Deactivate all tabs and hide all content
        modal.querySelectorAll('.profile-tab').forEach(tab => tab.classList.remove('active'));
        modal.querySelectorAll('.video-gallery').forEach(content => content.classList.remove('active'));

        // Activate the clicked tab and show its content
        tabButton.classList.add('active');
        const activeContent = modal.querySelector(`#${tabContentId}`);
        if (activeContent) {
          activeContent.classList.add('active');
        }
        break;
      }
      case "close-comments-modal":
        UI.closeCommentsModal();
        break;
      case "open-info-modal":
        UI.openModal(document.getElementById('infoModal'), {
          animationClass: 'slideInFromTop'
        });
        break;
      case "open-tipping-from-info": {
        const infoModal = document.getElementById('infoModal');
        if (infoModal && infoModal.classList.contains('visible')) {
            UI.closeModal(infoModal, {
                keepFocus: true,
                animationClass: 'slideOutLeft',
                onClose: () => {
                    TippingModal.showModal({ animationClass: 'slideInRight' });
                }
            });
        } else {
            TippingModal.showModal();
        }
        break;
      }
      case "open-desktop-pwa-modal":
        PWA.openDesktopModal();
        break;
      case "open-ios-pwa-modal":
        PWA.openIosModal();
        break;
      case "install-pwa":
        // This is now handled directly in the PWA module.
        break;
      case "open-author-profile":
        const swiper = State.get('swiper');
        if (swiper) {
            const activeSlide = swiper.slides[swiper.activeIndex];
            const slideId = activeSlide.dataset.slideId;
            const slideData = slidesData.find((s) => s.id === slideId);
            if (slideData) {
                const isLightTheme = activeSlide.classList.contains('slide--light-theme');
                UI.openAuthorProfileModal(slideData, { isLightTheme });
            }
        }
        break;
      case "close-author-profile": {
        const authorModal = document.getElementById('author-profile-modal');

        // Nowa logika do zatrzymania odtwarzania wideo z kafelka
        const activeVideoPlayer = authorModal.querySelector('.video-tile-content.active video');
        if (activeVideoPlayer) {
            activeVideoPlayer.pause();
            activeVideoPlayer.currentTime = 0; // Przewinięcie na początek
        }
        UI.closeAuthorProfileModal();
        break;
      }
      case "close-modal":
        e.stopPropagation(); // Stop the event from bubbling up to parent elements
        const modal = actionTarget.closest(".modal-overlay");
        if (modal) {
          if (modal.id === 'infoModal') {
            UI.closeModal(modal, { animationClass: 'slideOutToTop' });
          } else {
            UI.closeModal(modal);
          }
        } else {
          PWA.closePwaModals();
        }
        break;
      case "close-welcome-modal":
        UI.closeWelcomeModal();
        break;
      case "open-account-modal":
        AccountPanel.openAccountModal();
        break;
      case "close-account-modal":
        UI.closeModal(UI.DOM.accountModal, { animationClass: 'slideOutLeft' });
        break;
      case "logout":
        e.preventDefault();
        (async () => {
          if (actionTarget.disabled) return;

          actionTarget.disabled = true;
          const originalText = actionTarget.textContent;

          try {
            await authManager.logout();

            if (loggedInMenu) loggedInMenu.classList.remove("active");

            UI.showAlert(Utils.getTranslation("logoutSuccess"));

          } catch (error) {
            console.error('Logout error:', error);
            UI.showAlert(error.message || 'Logout failed', true);
          } finally {
            actionTarget.disabled = false;
            actionTarget.textContent = originalText;
          }
        })();
        break;
      case "toggle-main-menu":
        if (State.get("isUserLoggedIn")) {
          if (loggedInMenu) loggedInMenu.classList.toggle("active");
        } else {
          Utils.vibrateTry();
          UI.showAlert(Utils.getTranslation("menuAccessAlert"));
        }
        break;
      case "toggle-login-panel":
        if (!State.get("isUserLoggedIn")) {
            // Kod do zapisania stanu odtwarzania wideo w tle (zachowany)
            const swiper = State.get('swiper');
            if (swiper) {
                const activeSlide = swiper.slides[swiper.activeIndex];
                const video = activeSlide?.querySelector('video');
                if (video) {
                    State.set('videoPlaybackState', {
                        slideId: activeSlide.dataset.slideId,
                        currentTime: video.currentTime,
                    });
                }
            }

            if (UI.DOM.commentsModal.classList.contains("visible")) {
                UI.closeCommentsModal();
            }
            if (loginPanel) {
                if (loginPanel.classList.contains('active')) {
                    // CLOSING
                    loginPanel.classList.add('login-panel--closing');
                    // Użyj transitionend dla transform, aby zapewnić płynne zamknięcie i prawidłowe czyszczenie
                    const onTransitionEnd = (e) => {
                        // Upewnij się, że event dotyczy właściwej właściwości i że jest to stan zamykania
                        if (e.propertyName === 'transform' && loginPanel.classList.contains('login-panel--closing')) {
                            loginPanel.classList.remove('active', 'login-panel--closing');
                            loginPanel.removeEventListener('transitionend', onTransitionEnd);
                            if (topbar) {
                                topbar.classList.remove("login-panel-active");
                            }
                        }
                    };
                    // Użyj { once: true } na ogólnym listenerze dla bezpieczeństwa
                    loginPanel.addEventListener('transitionend', onTransitionEnd);
                } else {
                    // OPENING
                    loginPanel.classList.remove('login-panel--closing');
                    loginPanel.classList.add('active');
                    if (topbar) {
                        topbar.classList.add("login-panel-active");
                    }
                }
            }
        }
        break;
      case "subscribe":
        if (!State.get("isUserLoggedIn")) {
          Utils.vibrateTry();
          UI.showAlert(Utils.getTranslation("subscribeAlert"));
        }
        break;
      case "toggle-push-notifications":
        Notifications.handleBellClick();
        break;
      case "close-notifications":
        if (UI.DOM.notificationPopup) {
          UI.DOM.notificationPopup.classList.remove("visible");
        }
        break;
      case "show-tip-jar":
        const authorModal = actionTarget.closest('#author-profile-modal');
        if (authorModal) {
            // NAPRAWA: Wymuś lustrzaną animację wyjścia
            UI.closeModal(authorModal, {
                animationClass: 'slideOutRight', // <--- POPRAWIONO: Modal Autora chowa się w prawo
                contentSelector: '.profile-modal-content',
                onClose: () => {
                    // Modal Napiwkowy wjeżdża z prawej (efekt płynnej zamiany)
                    TippingModal.showModal({
                        animationClass: 'slideInRight'
                    });
                }
            });
        } else {
            TippingModal.showModal();
        }
        break;
      case "tipping-next":
        TippingModal.handleNextStep();
        break;
      case "tipping-prev":
        TippingModal.handlePrevStep();
        break;
      case "play-video": {
        const video = actionTarget.closest(".tiktok-symulacja")?.querySelector("video");
        if (video) {
          video.play().catch(err => console.log("Błąd play:", err));
          const pauseOverlay = actionTarget.closest(".tiktok-symulacja")?.querySelector(".pause-overlay");
          if (pauseOverlay) pauseOverlay.classList.remove('visible');
        }
        break;
      }
      case "replay-video": {
        const video = actionTarget.closest(".tiktok-symulacja")?.querySelector("video");
        if (video) {
          video.currentTime = 0;
          video.play().catch(err => console.log("Błąd replay:", err));
          const replayOverlay = actionTarget.closest(".tiktok-symulacja")?.querySelector(".replay-overlay");
          if (replayOverlay) replayOverlay.classList.remove('visible');
        }
        break;
      }
      case "toggle-volume":
        e.stopPropagation();
        const isMuted = !State.get("isSoundMuted");
        State.set("isSoundMuted", isMuted);
        const activeSlideVideo = document.querySelector(".swiper-slide-active video");
        if (activeSlideVideo) {
          activeSlideVideo.muted = isMuted;
        }
        UI.updateVolumeButton(isMuted);
        break;
      case "toggle-fullscreen": {
        // This action should only work in PWA mode.
        if (!PWA.isStandalone()) {
          UI.showToast(Utils.getTranslation("immersiveModePwaOnly"));
          return;
        }

        const appFrame = document.getElementById("app-frame");
        if (appFrame) {
            const isHiding = appFrame.classList.toggle("hide-ui");

            // Find the button in the active slide to update its icon
            const activeSlide = document.querySelector('.swiper-slide-active');
            const btn = activeSlide?.querySelector('.fullscreen-button');

            if (btn) {
                const enterIcon = btn.querySelector('.fullscreen-enter-icon');
                const exitIcon = btn.querySelector('.fullscreen-exit-icon');

                if (isHiding) {
                    enterIcon.style.display = 'none';
                    exitIcon.style.display = 'block';
                } else {
                    enterIcon.style.display = 'block';
                    exitIcon.style.display = 'none';
                }
            }
        }
        break;
      }
    }
  },
  formSubmitHandler: async (e) => {
    const loginForm = e.target.closest("form#tt-login-form");

    // ========================================================================
    // OBSŁUGA FORMULARZA LOGOWANIA - Z AKTUALIZACJĄ O MODAL PIERWSZEGO LOGOWANIA
    // ========================================================================
    if (loginForm) {
      e.preventDefault();

      const usernameInput = loginForm.querySelector("#tt-username");
      const passwordInput = loginForm.querySelector("#tt-password");
      const submitButton = loginForm.querySelector("#tt-login-submit");

      if (!usernameInput || !passwordInput) {
        UI.showAlert("Form elements not found", true);
        return;
      }

      const username = usernameInput.value.trim();
      const password = passwordInput.value;

      if (!username || !password) {
        UI.showAlert(Utils.getTranslation("allFieldsRequiredError") || "Please enter username and password.", true);
        return;
      }

      submitButton.disabled = true;
      const originalText = submitButton.textContent;
      submitButton.innerHTML = '<span class="loading-spinner"></span>';

      try {
        // Zaloguj się. authManager.login sam wywoła event 'user:login',
        // który jest obsługiwany w app.js. To centralne miejsce
        // zajmie się pokazaniem modala lub zaktualizowaniem UI.
        await authManager.login(username, password);

        // Po prostu wyczyść formularz.
        usernameInput.value = '';
        passwordInput.value = '';

      } catch (error) {
        console.error('Login error:', error);
        UI.showAlert(
          error.message || Utils.getTranslation("loginFailed"),
          true
        );
      } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
      }

      return;
    }

    const tippingForm = e.target.closest("form#tippingForm");
    if (tippingForm) {
        e.preventDefault();
        TippingModal.handleFormSubmit();
        return;
    }

    // ========================================================================
    // OBSŁUGA FORMULARZA KOMENTARZY (pozostaje bez zmian)
    // ========================================================================
    const commentForm = e.target.closest("form#comment-form");
    if (commentForm) {
      e.preventDefault();

      const input = commentForm.querySelector("#comment-input");
      if (!input) {
        console.error('Comment input not found');
        return;
      }

      const text = input.value.trim();
      const hasImage = window.selectedCommentImage !== null;

      // Walidacja - musi być tekst lub obraz
      if (!text && !hasImage) {
        return;
      }

      const button = commentForm.querySelector('button[type="submit"]');
      if (button) button.disabled = true;

      const swiper = State.get('swiper');
      if (!swiper) {
        console.error('Swiper instance not found');
        if (button) button.disabled = false;
        return;
      }
      const slideId = swiper.slides[swiper.activeIndex].dataset.slideId;
      const parentId = State.get("replyingToComment");

      if (!slideId) {
        console.error('No active slide found');
        if (button) button.disabled = false;
        return;
      }

      (async () => {
        try {
          let imageUrl = null;

          // Upload obrazu jeśli istnieje
          if (window.selectedCommentImage) {
            UI.showToast(Utils.getTranslation('uploadingAvatar') || 'Przesyłanie obrazu...');

            const uploadResult = await API.uploadCommentImage(window.selectedCommentImage);

            // Walidacja odpowiedzi
            if (!uploadResult || typeof uploadResult.success !== 'boolean') {
              throw new Error('Invalid upload response');
            }

            if (!uploadResult.success) {
              throw new Error(
                uploadResult.data?.message || 'Nie udało się przesłać obrazu'
              );
            }

            if (!uploadResult.data?.url) {
              throw new Error('Missing image URL in response');
            }

            imageUrl = uploadResult.data.url;
          }

          // Wyślij komentarz
          const postResponse = await API.postComment(slideId, text, parentId, imageUrl);

          // Walidacja odpowiedzi
          if (!postResponse || typeof postResponse.success !== 'boolean') {
            throw new Error('Invalid comment response');
          }

          if (!postResponse.success) {
            throw new Error(
              postResponse.data?.message || Utils.getTranslation("postCommentError")
            );
          }

          if (!postResponse.data || !postResponse.data.id) {
            throw new Error('Invalid comment data in response');
          }

          // Sukces - wyczyść formularz
          input.value = "";
          State.set("replyingToComment", null);

          const replyContext = document.querySelector(".reply-context");
          if (replyContext) replyContext.style.display = "none";

          UI.removeCommentImage();

          UI.showToast(Utils.getTranslation("postCommentSuccess"));

          // Zaktualizuj lokalne dane
          const slideData = slidesData.find((s) => s.id === slideId);
          if (slideData) {
            // Dodaj nowy komentarz
            if (!Array.isArray(slideData.comments)) {
              slideData.comments = [];
            }
            slideData.comments.push(postResponse.data);

            // Zaktualizuj licznik
            slideData.initialComments = postResponse.data.new_comment_count ?? slideData.comments.length;

            // Re-render
            UI.renderComments(slideData.comments);

            // Zaktualizuj licznik w głównym widoku
            const mainSlideCount = slideElement.querySelector(".comment-count");
            if (mainSlideCount) {
              mainSlideCount.textContent = Utils.formatCount(slideData.initialComments);
            }

            // Zaktualizuj tytuł modala
            const commentsTitle = UI.DOM.commentsModal.querySelector("#commentsTitle");
            if (commentsTitle) {
              commentsTitle.textContent = `${Utils.getTranslation("commentsModalTitle")} (${slideData.initialComments})`;
            }

            // Scroll do dołu
            const modalBody = UI.DOM.commentsModal.querySelector(".modal-body");
            if (modalBody) {
              setTimeout(() => {
                modalBody.scrollTop = modalBody.scrollHeight;
              }, 100);
            }
          }

        } catch (error) {
          console.error('Post comment error:', error);
          UI.showAlert(error.message || Utils.getTranslation("postCommentError"), true);
        } finally {
          if (button) button.disabled = false;
          input.focus();
        }
      })();
    }
  },
};
